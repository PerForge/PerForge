{% extends "layouts/base-fullscreen.html" %}
{% block title %} Tests {% endblock %}
<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}
<link type="text/css" href="/static/assets/vendor/@fortawesome/fontawesome-free/css/all.min.css" rel="stylesheet">
<link type="text/css" href="/static/assets/css/main.css" rel="stylesheet">
<link type="text/css" href="/static/assets/css/nfrs.css" rel="stylesheet">
{% endblock stylesheets %}
{% block content %}
    <main>
        <div class="main-background">
            {% include 'includes/sidebar.html' %}
            <div class="main-body">
                <div class="main-body-header">
                    <h4 class="mb-0">Test log
                        <div class="tooltip-container">
                          <a href="https://perforge.app/docs/tutorial-extras/reporting-ui" target="_blank">
                              <span class="fa-regular fa-circle-question me-2 mt-2"></span>
                          </a>
                          <div class="tooltip-content" style="font-size: 16px;">
                              Click to learn more
                          </div>
                        </div>
                        <a id="version-info"></a>
                    </h4>
                </div>
                <div class="card mb-3 margin-all-10" data-component-card="data-component-card">
                    <div class="card-body">
                        <div id="table-id">
                            <div class="d-flex align-items-center justify-content-end mb-3">
                                <div class="d-flex" id="bulk-select-actions">
                                    <div>
                                        <div class="search-box position-relative" data-bs-toggle="search" data-bs-display="static">
                                            <input class="form-control search-input search" type="search" placeholder="Search" aria-label="Search" />
                                            <span class="fas fa-search search-box-icon"></span>
                                        </div>
                                    </div>
                                    <select class="form-select ms-2" id="dataSourceId">
                                        {% for db in db_configs %}
                                            <option value='{"source_type": "{{ db.source_type }}", "id": "{{ db.id }}"}'>{{ db.name }}</option>
                                        {% endfor %}
                                    </select>
                                    <select class="form-select ms-2" id="selectedAction">
                                        <option value='{"type": "none"}' selected="selected">Choose output</option>
                                        {% for output in output_configs %}
                                            <option value='{{ output | tojson | safe }}'>{{ output.name }}</option>
                                        {% endfor %}
                                        <option value='{"type": "pdf_report"}'>PDF report</option>
                                        <option value='{"type": "delete"}'>Delete</option>
                                    </select>
                                    <select class="form-select ms-2" id="templateGroupName">
                                        <option value='' selected="selected">Template group</option>
                                        {% for template_group in template_groups %}
                                            <option value="{{ template_group.id }}">{{ template_group.name }}</option>
                                        {% endfor %}
                                    </select>
                                    <button class="btn btn-secondary ms-2" id="show-api" style="min-width: 110px;">
                                        <div>Show API</div>
                                    </button>
                                    <button class="btn btn-primary ms-2" data-selected-rows="data-selected-rows" style="min-width: 86px;">
                                        <span id="spinner-apply" class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none;"></span>
                                        <div id="spinner-apply-text">Apply</div>
                                    </button>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="table fs--1 mb-0">
                                    <thead>
                                        <tr>
                                            <th>
                                                <div class="form-check mb-0 fs-0">
                                                    <input class="form-check-input" id="bulk-select-example" type="checkbox" data-bulk-select='{"body":"bulk-select-body","actions":"bulk-select-actions","replacedElement":"bulk-select-replace-element"}'/>
                                                </div>
                                            </th>
                                            <th class="sort" data-sort="test_title">Test title</th>
                                            <th>Template</th>
                                            <th class="sort" data-sort="application">Application</th>
                                            <th class="sort" data-sort="duration">Duration (sec)</th>
                                            <th class="sort" data-sort="max_threads">Users</th>
                                            <th class="sort" data-sort="start_time">Start time</th>
                                            <th class="sort" data-sort="end_time">End time</th>
                                            <th>Compare</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody class="list" id="bulk-select-body">
                                        <tr>
                                            <th></th>
                                            <th></th>
                                            <th></th>
                                            <th></th>
                                            <th></th>
                                            <th></th>
                                            <th></th>
                                            <th></th>
                                            <th></th>
                                            <th></th>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="d-flex justify-content-between mt-3 fs--1">
                                <span data-list-info="data-list-info"></span>
                                <div class="d-flex">
                                    <button class="page-link" data-list-pagination="prev">
                                        <span class="fas fa-chevron-left"></span>
                                    </button>
                                    <ul class="mb-0 pagination"></ul>
                                    <button class="page-link pe-0" data-list-pagination="next">
                                        <span class="fas fa-chevron-right"></span>
                                    </button>
                                </div>
                            </div>
                            <div class="center-section" id="spinner">
                                <div class="spinner-border text-info" role="status"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Result Modal -->
                <div class="modal fade" id="resultModal" tabindex="-1" aria-labelledby="resultModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                        <h5 class="modal-title" id="resultModalLabel"></h5>
                        </div>
                        <div class="modal-body" id="resultModalBody">
                        <!-- Result content will be populated here -->
                        </div>
                        <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                    </div>
                </div>
                {% with msgs = get_flashed_messages() %}
                    {% include 'includes/flashed-msg.html' %}
                {% endwith %}
            </div>
        </div>
        <script type="text/javascript" charset="utf8" src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script>
            $(document).ready(function(){
                // Cookie handling functions
                function setCookie(name, value, days) {
                    let expires = "";
                    if (days) {
                        const date = new Date();
                        date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                        expires = "; expires=" + date.toUTCString();
                    }
                    document.cookie = name + "=" + (value || "") + expires + "; path=/";
                }

                function getCookie(name) {
                    const nameEQ = name + "=";
                    const ca = document.cookie.split(';');
                    for(let i = 0; i < ca.length; i++) {
                        let c = ca[i];
                        while (c.charAt(0) === ' ') c = c.substring(1);
                        if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
                    }
                    return null;
                }

                const dataSource_select = document.getElementById("dataSourceId");
                
                // Initialize from cookie if exists
                const savedDataSource = getCookie("selectedDataSource");
                if (savedDataSource) {
                    dataSource_select.value = savedDataSource;
                }

                // Update cookie when selection changes
                dataSource_select.addEventListener("change", function() {
                    setCookie("selectedDataSource", this.value, 7);
                    loadData();
                });

                const templates = JSON.parse('{{ templates | tojson }}');
                if (!templates){
                    templates = []
                }

                // Initial load after everything is initialized
                loadData();

                function loadData(){
                    var dataSource = $("#dataSourceId").val();
                    const dataSourceJson = JSON.parse(dataSource);
                    const sourceType = encodeURIComponent(dataSourceJson.source_type);
                    const id = encodeURIComponent(dataSourceJson.id);
                    const queryString = `source_type=${sourceType}&id=${id}`;
                    $("#spinner").show()
                    perforge.utils
                        .sendGetRequest(`/load_tests?${queryString}`)
                        .then((data) => {
                            if(data.status === 'success'){
                                updateTable(data.tests);
                            }else{
                                var tableBody = document.getElementById("bulk-select-body");
                                tableBody.innerHTML = ''; // Clear the table body
                                const badmsg = document.getElementById("bad-msg");
                                badmsg.style.display = "flex";
                                const msg = badmsg.querySelector("#msg");
                                msg.textContent = data.message;
                            }
                            $("#spinner").hide();
                        })
                        .catch((error) => {
                            var tableBody = document.getElementById("bulk-select-body");
                            tableBody.innerHTML = ''; // Clear the table body
                            $("#spinner").hide();
                        });
                }

                function updateTable(tests) {
                    $("#table-id").attr('data-list', '{"valueNames":["test_title", "application", "duration", "max_threads", "start_time", "end_time"], "page": 10, "pagination": true}');

                    var tableBody = document.getElementById("bulk-select-body");
                    tableBody.innerHTML = ''; // Clear the table body

                    tests.forEach(function(test) {
                        const row = tableBody.insertRow();

                        // Insert the checkbox column
                        const checkboxCell = row.insertCell();
                        const checkboxDiv = document.createElement("div");
                        checkboxDiv.className = "form-check fs-0";
                        checkboxDiv.innerHTML = `<input class="form-check-input" type="checkbox" data-bulk-select-row='{"test_title":"${test.test_title}","application":"${test.application}","duration":"${test.duration}","max_threads":"${test.max_threads}","start_time":"${test.start_time}","end_time":"${test.end_time}"}' />`;
                        checkboxCell.appendChild(checkboxDiv);

                        // Insert cells for each column based on your data structure
                        const runIdCell = row.insertCell();
                        runIdCell.textContent = test.test_title;

                        // Create and insert the Test ID dropdown
                        const templateIdCell = row.insertCell();
                        const selectTemplate = document.createElement("select");
                        selectTemplate.className = "form-select";

                        // Create a default "Choose for comparison" option
                        const defaultTemplateOption = document.createElement("option");
                        defaultTemplateOption.value = "no data"; // Set an empty value for the default option
                        defaultTemplateOption.textContent = "For report generation";
                        selectTemplate.appendChild(defaultTemplateOption);
                        selectTemplate.setAttribute("template-test-id", test.test_title)
                        templates.forEach(tmp => {
                            const option = document.createElement("option");
                            option.value = tmp.id;
                            option.textContent = tmp.name;
                            selectTemplate.appendChild(option);
                        });
                        templateIdCell.appendChild(selectTemplate);

                        selectTemplate.addEventListener('change', (event) => {
                            const value = event.target.value;
                            const checkbox = checkboxDiv.querySelector('input[data-bulk-select-row]');
                            let checkboxData = JSON.parse(checkbox.getAttribute('data-bulk-select-row'));
                            checkboxData['template_id'] = value;
                            checkbox.setAttribute('data-bulk-select-row', JSON.stringify(checkboxData))
                        });

                        // Insert Test Name (modify as needed)
                        const applicationCell = row.insertCell();
                        applicationCell.textContent = test.application;

                        // Insert Duration (modify as needed)
                        const durationCell = row.insertCell();
                        durationCell.textContent = test.duration;

                        // Insert Max Threads (modify as needed)
                        const max_threadsCell = row.insertCell();
                        max_threadsCell.textContent = test.max_threads;

                        // Insert Start Time (modify as needed)
                        const start_timeCell = row.insertCell();
                        start_timeCell.textContent = test.start_time;

                        // Insert End Time (modify as needed)
                        const end_timeCell = row.insertCell();
                        end_timeCell.textContent = test.end_time;

                        // Create and insert the Test ID dropdown
                        const testIdCell = row.insertCell();
                        const select = document.createElement("select");
                        select.className = "form-select";

                        // Create a default "Choose for comparison" option
                        const defaultOption = document.createElement("option");
                        defaultOption.value = "no data"; // Set an empty value for the default option
                        defaultOption.textContent = "For comparison";
                        select.appendChild(defaultOption);
                        select.setAttribute("data-test-id", test.test_title)
                        tests.forEach(test => {
                            const option = document.createElement("option");
                            option.value = test.test_title;
                            option.textContent = test.test_title;
                            select.appendChild(option);
                        });
                        testIdCell.appendChild(select);

                        select.addEventListener('change', (event) => {
                            const value = event.target.value;
                            const checkbox = checkboxDiv.querySelector('input[data-bulk-select-row]');
                            let checkboxData = JSON.parse(checkbox.getAttribute('data-bulk-select-row'));
                            checkboxData['baseline_test_title'] = value;
                            checkbox.setAttribute('data-bulk-select-row', JSON.stringify(checkboxData))
                        });

                        const reportCell = row.insertCell();
                        const btn = document.createElement('a');
                        btn.className = 'btn btn-danger';
                        const dataSource = document.getElementById('dataSourceId').value;
                        const dataSourceJson = JSON.parse(dataSource);
                        btn.href = `/report?test_title=${test.test_title}&source_type=${encodeURIComponent(dataSourceJson.source_type)}&id=${encodeURIComponent(dataSourceJson.id)}`;
                        btn.textContent = 'Report';
                        reportCell.appendChild(btn);
                    });

                    perforge.utils.listInit();
                }
            });

            async function checkVersion() {
                const response = await fetch('/check_new_version');
                const data = await response.json();
                const versionInfo = document.getElementById('version-info');

                if (data.new_version_released) {
                    versionInfo.innerHTML = `
                        New<span class="text-primary fw-bold ms-2">${data.new_version}</span> version is available!
                        <a href="https://github.com/PerForge/PerForge/releases/tag/${data.new_version}" class="text-primary fw-bold" target="_blank">Click to check out the release notes and update.</a>
                    `;
                }
            }
            // Check version when the page loads
            checkVersion();
        </script>
    </main>
{% endblock content %}