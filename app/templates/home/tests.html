{% extends "layouts/base-fullscreen.html" %}
{% block title %} Tests {% endblock %}
<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}
<link type="text/css" href="/static/assets/vendor/@fortawesome/fontawesome-free/css/all.min.css" rel="stylesheet">
<link type="text/css" href="/static/assets/css/main.css" rel="stylesheet">
<link type="text/css" href="/static/assets/css/nfrs.css" rel="stylesheet">
    <style>
        th.sort {
            pointer-events: none;
        }
    </style>
{% endblock stylesheets %}
{% block content %}
    <main>
        <div class="main-background">
            {% include 'includes/sidebar.html' %}
            <div class="main-body">
                <div class="card mb-3 margin-all-10" data-component-card="data-component-card">
                    <div class="card-body">
                        <div id="table-id">
                            <div class="d-flex align-items-center justify-content-between mb-3">
                                <div class="d-flex">
                                    <div class="search-box position-relative" data-bs-toggle="search" data-bs-display="static">
                                        <input class="form-control search-input search" type="search" placeholder="Search" aria-label="Search" style="min-width: 100px;"/>
                                        <span class="fas fa-search search-box-icon"></span>
                                    </div>
                                    <div class="d-flex align-items-center ms-2">
                                        <label for="dataSourceId" class="form-label mb-0 me-2">Datasource:</label>
                                        <select class="form-select" id="dataSourceId">
                                        </select>
                                    </div>
                                </div>
                                <div class="d-flex" id="bulk-select-actions">
                                    <select class="form-select ms-2" id="selectedAction" style="min-width: 180px;">
                                        <option value='{"type": "none"}' selected="selected">Select an action</option>
                                        <option value='{"type": "pdf_report"}'>PDF file</option>
                                        <option value='{"type": "delete"}'>Delete test</option>
                                    </select>
                                    <select class="form-select ms-2" id="templateGroupName" style="min-width: 310px;">
                                        <option value='' selected="selected">Select a template group (optional)</option>
                                    </select>
                                    <button class="btn btn-secondary ms-2" id="show-api" style="min-width: 110px;">
                                        <div>Show API</div>
                                    </button>
                                    <button class="btn btn-primary ms-2" data-selected-rows="data-selected-rows" style="min-width: 86px;">
                                        <span id="spinner-apply" class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none;"></span>
                                        <div id="spinner-apply-text">Apply</div>
                                    </button>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="table fs--1 mb-0">
                                    <thead>
                                        <tr>
                                            <th>
                                                <div class="form-check mb-0 fs-0">
                                                    <input class="form-check-input" id="bulk-select-example" type="checkbox" data-bulk-select='{"body":"bulk-select-body","actions":"bulk-select-actions","replacedElement":"bulk-select-replace-element"}'/>
                                                </div>
                                            </th>
                                            <th class="sort" data-sort="test_title">Test title</th>
                                            <th class="sort" data-sort="duration">Duration, s</th>
                                            <th class="sort" data-sort="max_threads">Users</th>
                                            <th class="sort" data-sort="start_time">Start time</th>
                                            <th class="sort" data-sort="end_time">End time</th>
                                            <th>Template</th>
                                            <th>Baseline test</th>
                                            <th>Additional context</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody class="list" id="bulk-select-body">
                                        <tr>
                                            <th></th>
                                            <th></th>
                                            <th></th>
                                            <th></th>
                                            <th></th>
                                            <th></th>
                                            <th></th>
                                            <th></th>
                                            <th></th>
                                            <th></th>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="d-flex justify-content-between mt-3 fs--1">
                                <div class="d-flex align-items-center">
                                    <select id="pageSizeSelect" class="form-select form-select-sm me-2" style="width:auto;">
                                        <option value="10">10</option>
                                        <option value="25">25</option>
                                        <option value="50">50</option>
                                        <option value="100">100</option>
                                    </select>
                                    <span data-list-info="data-list-info"></span>
                                </div>
                                <div class="d-flex">

                                    <button class="page-link" data-list-pagination="prev">
                                        <span class="fas fa-chevron-left"></span>
                                    </button>
                                    <ul class="mb-0 pagination"></ul>

                                    <button class="page-link pe-0" data-list-pagination="next">
                                        <span class="fas fa-chevron-right"></span>
                                    </button>
                                </div>
                            </div>
                            <div class="center-section" id="spinner">
                                <div class="spinner-border text-info" role="status"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Result Modal -->
                <div class="modal fade" id="resultModal" tabindex="-1" aria-labelledby="resultModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                        <h5 class="modal-title" id="resultModalLabel"></h5>
                        </div>
                        <div class="modal-body" id="resultModalBody">
                        <!-- Result content will be populated here -->
                        </div>
                        <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                    </div>
                </div>
                <!-- Additional Context Modal -->
                <div class="modal fade" id="contextModal" tabindex="-1" aria-labelledby="contextModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="contextModalLabel">Additional Context</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <textarea id="contextTextarea" class="form-control" rows="4" placeholder="Enter additional context for this test..."></textarea>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" id="saveContextBtn">Save</button>
                            </div>
                        </div>
                    </div>
                </div>
                {% with msgs = get_flashed_messages() %}
                    {% include 'includes/flashed-msg.html' %}
                {% endwith %}
            </div>
        </div>
        <script type="text/javascript" charset="utf8" src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script>
            $(document).ready(function(){
                // Cookie handling functions
                function setCookie(name, value, days) {
                    let expires = "";
                    if (days) {
                        const date = new Date();
                        date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                        expires = "; expires=" + date.toUTCString();
                    }
                    document.cookie = name + "=" + (value || "") + expires + "; path=/";
                }

                function getCookie(name) {
                    const nameEQ = name + "=";
                    const ca = document.cookie.split(';');
                    for(let i = 0; i < ca.length; i++) {
                        let c = ca[i];
                        while (c.charAt(0) === ' ') c = c.substring(1);
                        if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
                    }
                    return null;
                }

                const dataSource_select = document.getElementById("dataSourceId");
                let currentAbortController = null;

                // Pagination and sorting state
                let currentPage = 1;
                let pageSize = parseInt(localStorage.getItem('pageSize')) || 10; // UI page size

                // Initialize page size dropdown and handler
                const pageSizeSelect = document.getElementById('pageSizeSelect');
                if (pageSizeSelect) {
                    pageSizeSelect.value = pageSize;
                    pageSizeSelect.addEventListener('change', function () {
                        pageSize = parseInt(this.value);
                        localStorage.setItem('pageSize', pageSize);
                        currentPage = 1; // reset to first page
                        loadData();
                    });
                }
                let totalItems = 0;
                // Fixed sorting parameters (used only for icon updates)
                const sortBy = 'start_time';
                const sortDir = 'desc';


                // Helper to build an array of page numbers / ellipsis tokens
                function generatePageList(page, totalPages, innerWindow = 1, outerWindow = 1){
                    // Show all pages if total small
                    const maxVisible = innerWindow * 2 + outerWindow * 2 + 3; // +2 for two ellipsis, +1 for current
                    if (totalPages <= maxVisible) {
                        return Array.from({length: totalPages}, (_, idx) => idx + 1);
                    }
                    const pages = [];
                    const left = Math.max(page - innerWindow, outerWindow + 2);
                    const right = Math.min(page + innerWindow, totalPages - outerWindow - 1);

                    // first outerWindow pages
                    for (let i = 1; i <= outerWindow; i++) {
                        pages.push(i);
                    }
                    // left gap
                    if (left > outerWindow + 2) {
                        pages.push('...');
                    } else if (left === outerWindow + 2) {
                        pages.push(outerWindow + 1);
                    }
                    // middle pages
                    for (let i = left; i <= right; i++) {
                        pages.push(i);
                    }
                    // right gap
                    if (right < totalPages - outerWindow - 1) {
                        pages.push('...');
                    } else if (right === totalPages - outerWindow - 1) {
                        pages.push(totalPages - outerWindow);
                    }
                    // last outerWindow pages
                    for (let i = totalPages - outerWindow + 1; i <= totalPages; i++) {
                        pages.push(i);
                    }
                    return pages;
                }

                // Initialize from cookie if exists
                const savedDataSource = getCookie("selectedDataSource");
                if (savedDataSource) {
                    dataSource_select.value = savedDataSource;
                }

                // Update cookie when selection changes
                dataSource_select.addEventListener("change", function() {
                    setCookie("selectedDataSource", this.value, 7);
                    loadData();
                });

                // Pagination buttons (bind once)
                $("[data-list-pagination='prev']").on('click', function(){
                    if(currentPage > 1){
                        currentPage--;
                        loadData();
                    }
                });
                $("[data-list-pagination='next']").on('click', function(){
                    const maxPage = Math.ceil(totalItems / pageSize);
                    if(currentPage < maxPage){
                        currentPage++;
                        loadData();
                    }
                });

                function updateSortIcons(){
                    // Clear previous indicators
                    $('th.sort').each(function(){
                        $(this).find('.sort-indicator').remove();
                    });
                    if(!sortBy){
                        return;
                    }
                    // Add indicator to active column
                    const $active = $('th.sort[data-sort="'+sortBy+'"]');
                    if($active.length){
                        const indicator = $('<span class="sort-indicator ms-1"></span>').html(sortDir === 'asc' ? '&#9650;' : '&#9660;');
                        $active.append(indicator);
                    }
                }

                let templates = [];

                let baselineTitles = []; // global list of available baseline tests

                // Helper: populate per-row Template selects after templates are loaded
                function populateTemplateSelects() {
                    const selects = document.querySelectorAll('select[template-test-id]');
                    selects.forEach(selectTemplate => {
                        const currentValue = selectTemplate.value;
                        // Rebuild options
                        selectTemplate.innerHTML = '';
                        const defaultTemplateOption = document.createElement('option');
                        defaultTemplateOption.value = 'no data';
                        defaultTemplateOption.textContent = 'Select a template';
                        selectTemplate.appendChild(defaultTemplateOption);

                        if (Array.isArray(templates)) {
                            templates.forEach(tmp => {
                                const option = document.createElement('option');
                                option.value = tmp.id;
                                option.textContent = tmp.name;
                                selectTemplate.appendChild(option);
                            });
                        }

                        // Try to preserve previous selection if still valid
                        if (currentValue && currentValue !== 'no data') {
                            selectTemplate.value = currentValue;
                        }
                    });
                }

                // Load templates and template groups via API (can happen after tests data)
                function loadTemplatesAndGroups() {
                    const tplPromise = window.apiClient.templates.getAll()
                        .then(resp => {
                            if (resp.status === 'success' && resp.data && Array.isArray(resp.data.templates)) {
                                templates = resp.data.templates;
                            } else {
                                templates = [];
                            }
                            // Update any existing row selects with newly fetched templates
                            populateTemplateSelects();
                        })
                        .catch(() => { templates = []; });

                    const groupsPromise = window.apiClient.templateGroups.getAll()
                        .then(resp => {
                            const selectEl = document.getElementById('templateGroupName');
                            if (selectEl) {
                                // Reset options
                                selectEl.innerHTML = '';
                                const defaultOpt = document.createElement('option');
                                defaultOpt.value = '';
                                defaultOpt.selected = true;
                                defaultOpt.textContent = 'Select a template group (optional)';
                                selectEl.appendChild(defaultOpt);

                                const groups = (resp.status === 'success' && resp.data && Array.isArray(resp.data.template_groups)) ? resp.data.template_groups : [];
                                groups.forEach(group => {
                                    const opt = document.createElement('option');
                                    opt.value = group.id;
                                    opt.textContent = group.name;
                                    selectEl.appendChild(opt);
                                });
                            }
                        })
                        .catch(() => { /* ignore */ });

                    return Promise.all([tplPromise, groupsPromise]);
                }

                // Load InfluxDB datasources via API and populate the select
                function loadDatasources() {
                    const select = document.getElementById('dataSourceId');
                    // Keep a copy of cookie/localStorage to try and restore selection
                    const savedCookie = getCookie('selectedDataSource');
                    const savedId = localStorage.getItem('selectedDataSourceId');

                    return window.apiClient.get('/integrations/type/influxdb')
                        .then(resp => {
                            const items = (resp && resp.status === 'success' && resp.data && Array.isArray(resp.data.integrations)) ? resp.data.integrations : [];
                            // Clear current options
                            select.innerHTML = '';

                            items.forEach(cfg => {
                                // Normalize to the structure expected by the rest of the page
                                const valueObj = {
                                    id: cfg.id,
                                    name: cfg.name,
                                    source_type: 'influxdb_v2',
                                    listener: cfg.listener
                                };
                                const opt = document.createElement('option');
                                opt.value = JSON.stringify(valueObj); // preserve key order as set above
                                opt.textContent = cfg.name;
                                select.appendChild(opt);
                            });

                            // Try to restore previous selection by cookie exact match
                            let restored = false;
                            if (savedCookie) {
                                for (let i = 0; i < select.options.length; i++) {
                                    if (select.options[i].value === savedCookie) {
                                        select.selectedIndex = i;
                                        restored = true;
                                        break;
                                    }
                                }
                            }
                            // Fallback: restore by ID
                            if (!restored && savedId) {
                                for (let i = 0; i < select.options.length; i++) {
                                    try {
                                        const val = JSON.parse(select.options[i].value);
                                        if (String(val.id) == String(savedId)) {
                                            select.selectedIndex = i;
                                            restored = true;
                                            break;
                                        }
                                    } catch (e) { /* ignore */ }
                                }
                            }
                            // Default to first option if nothing restored
                            if (!restored && select.options.length > 0) {
                                select.selectedIndex = 0;
                            }
                        });
                }

                // Load Output Configs for Actions dropdown
                function loadOutputConfigs() {
                    const select = document.getElementById('selectedAction');
                    if (!select) {
                        return Promise.resolve();
                    }
                    return window.apiClient.get('/integrations/outputs')
                        .then(resp => {
                            const outputs = (resp && resp.status === 'success' && resp.data && Array.isArray(resp.data.output_configs)) ? resp.data.output_configs : [];
                            // Insert options after the default 'none' and before static actions
                            // Find index of first static action (pdf_report). We'll append before these two if needed, or just before end.
                            const staticStartIndex = Array.from(select.options).findIndex(opt => {
                                try { return JSON.parse(opt.value).type === 'pdf_report'; } catch (e) { return false; }
                            });

                            outputs.forEach(out => {
                                const opt = document.createElement('option');
                                opt.value = JSON.stringify(out);
                                opt.textContent = out.name || `Output ${out.id}`;
                                if (staticStartIndex > -1) {
                                    select.insertBefore(opt, select.options[staticStartIndex]);
                                } else {
                                    select.appendChild(opt);
                                }
                            });
                        })
                        .catch(() => { /* ignore */ });
                }

                // Initial load: load datasources first, then tests, then templates/groups and output configs
                loadDatasources()
                    .then(() => {
                        loadData();
                        loadTemplatesAndGroups();
                        loadOutputConfigs();
                    })
                    .catch(() => {
                        // Even if datasources failed to load, try to proceed to show error states in loadData
                        loadData();
                        loadTemplatesAndGroups();
                        loadOutputConfigs();
                    });

                function loadData(){
                    // If there's a pending request, abort it.
                    if (currentAbortController) {
                        currentAbortController.abort();
                    }
                    // Create a new AbortController for the new request.
                    currentAbortController = new AbortController();
                    const signal = currentAbortController.signal;

                    var dataSource = $("#dataSourceId").val();
                    const dataSourceJson = JSON.parse(dataSource);
                    const sourceType = encodeURIComponent(dataSourceJson.source_type);
                    const id = encodeURIComponent(dataSourceJson.id);
                    $("#spinner").show();

                    // Use the API client instead of direct fetch, passing the signal
                    apiClient.tests.getTestData(sourceType, id,
                        {
                            page: currentPage,
                            page_size: pageSize
                        },
                        { signal })
                        .then((response) => {
                            if(response.status === 'success'){
                                baselineTitles = response.data.baseline_titles || [];
                                totalItems = response.data.total;
                                // Ensure current page reflects server response (safety if server adjusted page)
                                if (response.data.page) {
                                    currentPage = response.data.page;
                                }
                                updateTable(response.data.tests);
                            } else {
                                var tableBody = document.getElementById("bulk-select-body");
                                tableBody.innerHTML = ''; // Clear the table body
                                showFlashMessage(response.message, 'error');
                            }
                            $("#spinner").hide();

                            // Initialize List.js after updating the table
                            perforge.utils.listInit();

                            // Override List.js generated info with correct server-side pagination info
                            // Use timeout to ensure this runs after List.js internal updateListControls
                            setTimeout(() => {
                                const startItemCalc = ((currentPage - 1) * pageSize) + 1;
                                const endItemCalc = Math.min(currentPage * pageSize, totalItems);
                                $("[data-list-info]").text(`${startItemCalc} to ${endItemCalc} Items of ${totalItems}`);

                                // Re-enable/disable Prev/Next after List.js mutates DOM
                                const maxPageCalc = Math.ceil(totalItems / pageSize) || 1;
                                const $prevBtn = $("[data-list-pagination='prev']");
                                const $nextBtn = $("[data-list-pagination='next']");
                                $prevBtn.prop('disabled', currentPage === 1).toggleClass('disabled', currentPage === 1);
                                $nextBtn.prop('disabled', currentPage === maxPageCalc).toggleClass('disabled', currentPage === maxPageCalc);
                            }, 0);

                        })
                        .catch((error) => {
                            // If the error is an AbortError, it means we cancelled it intentionally.
                            if (error.name === 'AbortError') {
                                console.log('Fetch aborted');
                                return; // Don't show an error message.
                            }
                            var tableBody = document.getElementById("bulk-select-body");
                            tableBody.innerHTML = ''; // Clear the table body
                            showFlashMessage('Failed to load test data. Please try again.', 'error');
                            $("#spinner").hide();
                        });
                }

                function updateTable(tests) {
                    // Update pagination UI info to show item range and total from API
                    const maxPage = Math.ceil(totalItems / pageSize) || 1;
                    const startItem = ((currentPage - 1) * pageSize) + 1;
                    const endItem = Math.min(currentPage * pageSize, totalItems);
                    $("[data-list-info]").text(`${startItem} to ${endItem} Items of ${totalItems}`);

                    // Enable/disable Prev/Next buttons appropriately
                    const $prevBtn = $("[data-list-pagination='prev']");
                    const $nextBtn = $("[data-list-pagination='next']");
                    $prevBtn.prop('disabled', currentPage === 1).toggleClass('disabled', currentPage === 1);
                    $nextBtn.prop('disabled', currentPage === maxPage).toggleClass('disabled', currentPage === maxPage);

                    // Render numeric pagination
                    const $pagination = $("ul.pagination");
                    $pagination.empty();
                    generatePageList(currentPage, maxPage).forEach(p => {
                        const $li = $('<li>').addClass('page-item');
                        if (p === '...') {
                            $li.addClass('disabled').append($('<span>').addClass('page-link').text('...'));
                        } else {
                            const isActive = p === currentPage;
                            const $a = $('<a>').addClass('page-link').attr('href','#').text(p);
                            if (isActive) {
                                $li.addClass('active');
                                $a.addClass('active').attr('aria-current', 'page');
                            }
                            $a.on('click', function(e){
                                e.preventDefault();
                                if(currentPage !== p){
                                    currentPage = p;
                                    loadData();
                                }
                            });
                            $li.append($a);
                        }
                        $pagination.append($li);
                    });

                    // Disable List.js built-in pagination since we paginate server-side
                    $("#table-id").attr('data-list', '{"valueNames":["test_title", "duration", "max_threads", "start_time", "end_time"]}');

                    var tableBody = document.getElementById("bulk-select-body");
                    tableBody.innerHTML = ''; // Clear the table body

                    tests.forEach(function(test) {
                        const row = tableBody.insertRow();

                        // Insert the checkbox column
                        const checkboxCell = row.insertCell();
                        const checkboxDiv = document.createElement("div");
                        checkboxDiv.className = "form-check fs-0";
                        checkboxDiv.innerHTML = `<input class="form-check-input" type="checkbox" data-bulk-select-row='{"test_title":"${test.test_title}","duration":"${test.duration}","max_threads":"${test.max_threads}","start_time":"${test.start_time}","end_time":"${test.end_time}"}' />`;
                        checkboxCell.appendChild(checkboxDiv);

                        // Insert cells for each column based on your data structure
                        const testTitleCell = row.insertCell();
                        testTitleCell.className = "test_title";
                        testTitleCell.textContent = test.test_title;

                        // Insert Duration (modify as needed)
                        const durationCell = row.insertCell();
                        durationCell.className = "duration";
                        durationCell.textContent = test.duration;

                        // Insert Max Threads (modify as needed)
                        const max_threadsCell = row.insertCell();
                        max_threadsCell.className = "max_threads";
                        max_threadsCell.textContent = test.max_threads;

                        // Insert Start Time (modify as needed)
                        const start_timeCell = row.insertCell();
                        start_timeCell.className = "start_time";
                        start_timeCell.textContent = test.start_time;

                        // Insert End Time (modify as needed)
                        const end_timeCell = row.insertCell();
                        end_timeCell.className = "end_time";
                        end_timeCell.textContent = test.end_time;

                        // Create and insert the Test ID dropdown
                        const templateIdCell = row.insertCell();
                        const selectTemplate = document.createElement("select");
                        selectTemplate.className = "form-select";

                        // Create a default "Choose for comparison" option
                        const defaultTemplateOption = document.createElement("option");
                        defaultTemplateOption.value = "no data"; // Set an empty value for the default option
                        defaultTemplateOption.textContent = "Select a template";
                        selectTemplate.appendChild(defaultTemplateOption);
                        selectTemplate.setAttribute("template-test-id", test.test_title)
                        templates.forEach(tmp => {
                            const option = document.createElement("option");
                            option.value = tmp.id;
                            option.textContent = tmp.name;
                            selectTemplate.appendChild(option);
                        });
                        templateIdCell.appendChild(selectTemplate);

                        selectTemplate.addEventListener('change', (event) => {
                            const value = event.target.value;
                            const checkbox = checkboxDiv.querySelector('input[data-bulk-select-row]');
                            let checkboxData = JSON.parse(checkbox.getAttribute('data-bulk-select-row'));
                            checkboxData['template_id'] = value;
                            checkbox.setAttribute('data-bulk-select-row', JSON.stringify(checkboxData))
                        });

                        // Create and insert the Test ID dropdown
                        const testIdCell = row.insertCell();
                        const select = document.createElement("select");
                        select.className = "form-select";

                        // Create a default "Choose for comparison" option
                        const defaultOption = document.createElement("option");
                        defaultOption.value = "no data"; // Set an empty value for the default option
                        defaultOption.textContent = "Select a test to compare (optional)";
                        select.appendChild(defaultOption);
                        select.setAttribute("data-test-id", test.test_title)
                        baselineTitles.forEach(testTitle => {
                            const option = document.createElement("option");
                            option.value = testTitle;
                            option.textContent = testTitle;
                            select.appendChild(option);
                        });
                        testIdCell.appendChild(select);

                        select.addEventListener('change', (event) => {
                            const value = event.target.value;
                            const checkbox = checkboxDiv.querySelector('input[data-bulk-select-row]');
                            let checkboxData = JSON.parse(checkbox.getAttribute('data-bulk-select-row'));
                            checkboxData['baseline_test_title'] = value;
                            checkbox.setAttribute('data-bulk-select-row', JSON.stringify(checkboxData))
                        });

                        // Per-row Additional Context via modal
                        const additionalContextCell = row.insertCell();
                        const contextBtn = document.createElement('button');
                        contextBtn.type = 'button';
                        contextBtn.className = 'btn btn-outline-secondary btn-sm';
                        contextBtn.textContent = 'Add';
                        contextBtn.addEventListener('click', () => {
                            window.currentContextCheckbox = checkboxDiv.querySelector('input[data-bulk-select-row]');
                            window.currentContextButton = contextBtn;
                            const checkboxData = JSON.parse(window.currentContextCheckbox.getAttribute('data-bulk-select-row'));
                            const textarea = document.getElementById('contextTextarea');
                            textarea.value = checkboxData['additional_context'] || '';
                            const modal = new bootstrap.Modal(document.getElementById('contextModal'));
                            modal.show();
                        });
                        additionalContextCell.appendChild(contextBtn);

                        const reportCell = row.insertCell();
                        const btn = document.createElement('a');
                        btn.className = 'btn btn-danger';
                        const dataSource = document.getElementById('dataSourceId').value;
                        const dataSourceJson = JSON.parse(dataSource);
                        btn.textContent = 'ML Report';
                        if (dataSourceJson.listener === 'sitespeed_influxdb_v2') {
                            btn.classList.add('disabled');
                        } else {
                            btn.href = `/report?test_title=${test.test_title}&source_type=${encodeURIComponent(dataSourceJson.source_type)}&id=${encodeURIComponent(dataSourceJson.id)}`;
                        }
                        reportCell.appendChild(btn);
                    });

                    perforge.utils.listInit();

                    // Context modal handlers (global state for currently edited row)
                    if (!window._contextHandlersInitialized) {
                        window.currentContextCheckbox = null;
                        window.currentContextButton = null;
                        const saveContextBtn = document.getElementById('saveContextBtn');
                        if (saveContextBtn) {
                            saveContextBtn.addEventListener('click', () => {
                                const textarea = document.getElementById('contextTextarea');
                                const value = (textarea.value || '').trim();
                                if (window.currentContextCheckbox) {
                                    let checkboxData = JSON.parse(window.currentContextCheckbox.getAttribute('data-bulk-select-row'));
                                    if (value) {
                                        checkboxData['additional_context'] = value;
                                        if (window.currentContextButton) {
                                            window.currentContextButton.classList.remove('btn-outline-secondary');
                                            window.currentContextButton.classList.add('btn-success');
                                            window.currentContextButton.textContent = 'Edit';
                                        }
                                    } else {
                                        delete checkboxData['additional_context'];
                                        if (window.currentContextButton) {
                                            window.currentContextButton.classList.remove('btn-success');
                                            window.currentContextButton.classList.add('btn-outline-secondary');
                                            window.currentContextButton.textContent = 'Set';
                                        }
                                    }
                                    window.currentContextCheckbox.setAttribute('data-bulk-select-row', JSON.stringify(checkboxData));
                                }
                                const modalEl = document.getElementById('contextModal');
                                const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
                                modal.hide();
                            });
                        }
                        window._contextHandlersInitialized = true;
                    }
                }
            });


            // --- Logic to save and restore selected data source ---
            document.addEventListener('DOMContentLoaded', function() {
                const dataSourceSelect = document.getElementById('dataSourceId');
                const storedDataSourceId = localStorage.getItem('selectedDataSourceId');

                if (storedDataSourceId) {
                    let found = false;
                    for (let i = 0; i < dataSourceSelect.options.length; i++) {
                        const option = dataSourceSelect.options[i];
                        try {
                            const dbConfig = JSON.parse(option.value);
                            // Use == for type coercion just in case one is a string and the other a number
                            if (dbConfig.id == storedDataSourceId) {
                                option.selected = true;
                                // Trigger the change event to load the tests table
                                dataSourceSelect.dispatchEvent(new Event('change'));
                                found = true;
                                break;
                            }
                        } catch (e) {
                            console.error("Could not parse data source option value:", option.value, e);
                        }
                    }
                    // If the stored ID is not in the list, it was probably deleted.
                    if (!found) {
                        localStorage.removeItem('selectedDataSourceId');
                    }
                }

                // Add event listener to save the data source ID when the user changes it
                dataSourceSelect.addEventListener('change', function() {
                    try {
                        const selectedDbConfig = JSON.parse(this.value);
                        if (selectedDbConfig && selectedDbConfig.id) {
                            localStorage.setItem('selectedDataSourceId', selectedDbConfig.id);
                        }
                    } catch (e) {
                        console.error("Could not parse selected data source value:", this.value, e);
                    }
                });
            });
        </script>
    </main>
{% endblock content %}
