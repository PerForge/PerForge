{% extends "layouts/base-fullscreen.html" %}
{% block title %} Home {% endblock %}
<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}
<link type="text/css" href="/static/assets/vendor/@fortawesome/fontawesome-free/css/all.min.css" rel="stylesheet">
<link type="text/css" href="/static/assets/css/main.css" rel="stylesheet">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
{% endblock stylesheets %}
{% block content %}
   <main>
      <div class="main-background">
            {% include 'includes/sidebar.html' %}
            <div class="main-body">
               <div class="start-section ms-4 mt-3">
                  <h2 class="lh-sm">Project stats</h2>
               </div>
               <div class="start-section ms-4 mt-3">
                  <div class="pr-10 col-xxl-2-5 col-lg-2-5">
                      <div class="card">
                        <div class="card-body">
                            <p class="text-info fs-2-5 fw-bold mb-0">{{ project_stats.templates }} <span class="fs-0 text-900 lh-lg">templates</span></p>
                            <div class="flex-end">
                              <a class="badge badge-success" href="{{ url_for('get_templates') }}">add new</a>
                            </div>
                        </div>
                      </div>
                  </div>
                  <div class="pr-10 col-xxl-2-5 col-lg-2-5">
                     <div class="card">
                        <div class="card-body">
                           <p class="text-info fs-2-5 fw-bold mb-0">{{ project_stats.graphs }} <span class="fs-0 text-900 lh-lg">graphs</span></p>
                           <div class="flex-end">
                              <a class="badge badge-success" href="{{ url_for('get_graphs') }}">add new</a>
                           </div>
                        </div>
                     </div>
                  </div>
                  <div class="pr-10 col-xxl-2-5 col-lg-2-5">
                     <div class="card">
                        <div class="card-body">
                           <p class="text-info fs-2-5 fw-bold mb-0">{{ project_stats.nfrs }} <span class="fs-0 text-900 lh-lg">nfrs</span></p>
                           <div class="flex-end">
                              <a class="badge badge-success" href="{{ url_for('get_nfrs') }}">add new</a>
                           </div>
                        </div>
                     </div>
                  </div>
                  <div class="pr-10 col-xxl-2-5 col-lg-2-5">
                      <div class="card">
                        <div class="card-body">
                            <p class="text-info fs-2-5 fw-bold mb-0">{{ project_stats.integrations }} <span class="fs-0 text-900 lh-lg">integrations</span></p>
                            <div class="flex-end">
                              <a class="badge badge-success" href="{{ url_for('integrations') }}">add new</a>
                            </div>
                        </div>
                      </div>
                  </div>
                  <div class="pr-10 col-xxl-2-5 col-lg-2-5">
                      <div class="card">
                        <div class="card-body">
                            <p class="text-info fs-2-5 fw-bold mb-0">{{ project_stats.secrets }} <span class="fs-0 text-900 lh-lg">secrets</span></p>
                            <div class="flex-end">
                              <a class="badge badge-success" href="{{ url_for('get_secrets') }}">add new</a>
                            </div>
                        </div>
                      </div>
                  </div>
               </div>
               <div class="start-section ms-4 mt-3">
                  <h2 class="mb-2 lh-sm">Projects</h2>
               </div>
               <div class="start-section ms-4">
                  {% for project in projects %}
                      <div class="card card-project center-section" data-project-id="{{ project.id }}">
                          <a class="mt-3-5 d-block" href="#" onclick="setActiveProject('{{ project.id }}'); return false;">{{ project.name }}</a>
                          <div class="project-actions mt-2 d-flex align-items-center">
                              <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#renameProjectModal-{{ project.id }}" onclick="prefillRename('{{ project.id }}')" aria-label="Rename project" title="Rename project"><i class="fas fa-pen"></i></button>
                              <button class="btn btn-danger ms-2" data-bs-toggle="modal" data-bs-target="#deleteProjectModal-{{ project.id }}" aria-label="Delete project" title="Delete project"><i class="fas fa-trash"></i></button>
                          </div>
                      </div>
                      <div class="modal fade" id="renameProjectModal-{{ project.id }}" tabindex="-1" aria-labelledby="renameProjectModalLabel-{{ project.id }}" aria-hidden="true">
                          <div class="modal-dialog">
                              <div class="modal-content">
                                  <div class="modal-header">
                                      <h5 class="modal-title" id="renameProjectModalLabel-{{ project.id }}">Rename Project</h5>
                                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                  </div>
                                  <div class="modal-body">
                                      <label for="renameProjectName-{{ project.id }}" class="form-label">New name</label>
                                      <input type="text" class="form-control" id="renameProjectName-{{ project.id }}" value="{{ project.name }}" />
                                  </div>
                                  <div class="modal-footer">
                                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                      <button type="button" class="btn btn-primary" onclick="renameProject('{{ project.id }}')">Save</button>
                                  </div>
                              </div>
                          </div>
                      </div>
                      <div class="modal fade" id="deleteProjectModal-{{ project.id }}" tabindex="-1" aria-labelledby="deleteProjectModalLabel-{{ project.id }}" aria-hidden="true">
                          <div class="modal-dialog">
                              <div class="modal-content">
                                  <div class="modal-header">
                                      <h5 class="modal-title" id="deleteProjectModalLabel-{{ project.id }}">Confirm Delete</h5>
                                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                  </div>
                                  <div class="modal-body">
                                      Are you sure you want to delete the project "{{ project.name }}"?
                                  </div>
                                  <div class="modal-footer">
                                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                      <button type="button" class="btn btn-danger" onclick="deleteProject('{{ project.id }}')">Confirm Delete</button>
                                  </div>
                              </div>
                          </div>
                      </div>
                  {% endfor %}
                  <div class="card card-project center-section">
                     <button class="dropdown-item" type="button" data-bs-toggle="modal" data-bs-target="#projectModal">new project</button>
                  </div>
               </div>
               <div class="start-section ms-4 mt-3">
                  <h2 class="mb-2 lh-sm">Docs</h2>
               </div>
               <div class="start-section ms-4 mb-9">
                  <div class="card card-docs">
                     <div class="border-bottom-sm mt-3 ms-4 me-4">
                        <ul class="useful-links">
                            <li class="mt-1">
                                <a href="https://perforge.app/docs/category/configuration" target="_blank">üìÑ Documentation</a>
                            </li>
                            <li class="mt-1">
                                <a href="https://www.youtube.com/@PerForge" target="_blank">üé• Youtube channel</a>
                            </li>
                            <li class="mt-1">
                                <a href="https://github.com/PerForge/PerForge/discussions" target="_blank">üå† Feature requests</a>
                            </li>
                            <li class="mt-1">
                                <a href="https://github.com/PerForge/PerForge/issues" target="_blank">üêõ Report a bug</a>
                            </li>
                        </ul>
                     </div>
                     <div class="center-section">
                        <p id="version-info" class="fs-5">Current version: <span class="text-primary fw-bold">{{ current_version }}</span></p>
                     </div>
                  </div>
               </div>
               <div class="center-section">
                  {% with msgs = get_flashed_messages() %}
                  {% include 'includes/flashed-msg.html' %}
                  {% endwith %}
              </div>
            </div>
        </div>
        <script>
            function setActiveProject(projectId) {
                apiClient.projects.setActive(projectId)
                    .then(response => {
                        window.location.reload();
                    })
                    .catch(error => {
                        console.error('Error setting active project:', error);
                        showFlashMessage("Error setting active project: " + (error.message || 'Unknown error'), "error");
                    });
            }

            function prefillRename(projectId) {
                const card = document.querySelector(`.card-project[data-project-id='${projectId}']`);
                const nameLink = card ? card.querySelector('a.mt-3-5') : null;
                const input = document.getElementById(`renameProjectName-${projectId}`);
                if (nameLink && input) {
                    input.value = nameLink.textContent.trim();
                }
            }

            function renameProject(projectId) {
                const input = document.getElementById(`renameProjectName-${projectId}`);
                const newName = (input && input.value ? input.value : '').trim();
                if (!newName) {
                    showFlashMessage('Project name cannot be empty', 'error');
                    return;
                }

                apiClient.projects.update(projectId, { id: Number(projectId), name: newName })
                    .then(response => {
                        // Close modal
                        $(`#renameProjectModal-${projectId}`).modal('hide');

                        // Update UI text
                        const card = document.querySelector(`.card-project[data-project-id='${projectId}']`);
                        if (card) {
                            const nameLink = card.querySelector('a.mt-3-5');
                            if (nameLink) nameLink.textContent = newName;
                        }

                        // Update cookie if this is the active project
                        const getCookie = (name) => {
                            const value = `; ${document.cookie}`;
                            const parts = value.split(`; ${name}=`);
                            if (parts.length === 2) return parts.pop().split(';').shift();
                        };
                        const activeProjectId = getCookie('project');
                        if (String(activeProjectId) === String(projectId)) {
                            document.cookie = `project_name=${encodeURIComponent(newName)}; path=/`;
                        }

                        showFlashMessage('Project renamed successfully', 'success');
                    })
                    .catch(error => {
                        console.error('Error renaming project:', error);
                        const errMsg = (error && (error.message || (error.data && error.data.message))) || 'Unknown error';
                        showFlashMessage(`Error renaming project: ${errMsg}`, 'error');
                    });
            }

            function deleteProject(projectId) {
                apiClient.projects.delete(projectId)
                    .then(response => {
                        // Close modal
                        $(`#deleteProjectModal-${projectId}`).modal('hide');

                        // Show success message
                        showFlashMessage("Project deleted successfully", "success");

                        // Get all available projects after deletion
                        apiClient.projects.getAll()
                            .then(response => {
                                if (response.data && response.data.projects && response.data.projects.length > 0) {
                                    // If there are still projects, set the first one as active
                                    apiClient.projects.setActive(response.data.projects[0].id)
                                        .then(() => {
                                            // Reload page after a short delay to allow message to be seen
                                            setTimeout(() => {
                                                window.location.reload();
                                            }, 1000);
                                        });
                                } else {
                                    // If no projects left, redirect to choose-project page after a short delay
                                    setTimeout(() => {
                                        window.location.href = '/choose-project';
                                    }, 1000);
                                }
                            })
                            .catch(error => {
                                console.error('Error getting projects after deletion:', error);
                                showFlashMessage("Error getting projects after deletion", "error");
                                // Fallback to choose-project page if there's an error
                                setTimeout(() => {
                                    window.location.href = '/choose-project';
                                }, 1000);
                            });
                    })
                    .catch(error => {
                        console.error('Error deleting project:', error);
                        showFlashMessage("Error deleting project: " + (error.message || 'Unknown error'), "error");
                    });
            }

            async function checkVersion() {
                const response = await fetch('/check_new_version');
                const data = await response.json();
                const versionInfo = document.getElementById('version-info');

                if (data.new_version_released) {
                    versionInfo.innerHTML = `<i class="fas fa-rocket text-primary me-2"></i> New version <strong class="text-primary">${data.new_version}</strong> is out! <a href="https://github.com/PerForge/PerForge/releases/tag/${data.new_version}" class="fw-bold" target="_blank">See what's new</a>`;
                }
            }

            document.addEventListener('DOMContentLoaded', function() {
                checkVersion();

                function getCookie(name) {
                    const value = `; ${document.cookie}`;
                    const parts = value.split(`; ${name}=`);
                    if (parts.length === 2) return parts.pop().split(';').shift();
                }

                const activeProjectId = getCookie('project');

                if (activeProjectId) {
                    const projectCard = document.querySelector(`.card-project[data-project-id='${activeProjectId}']`);
                    if (projectCard) {
                        projectCard.classList.add('selected-project');
                    }
                }
            });
        </script>
      {% include 'includes/project-modal.html' %}
    </main>
{% endblock content %}
