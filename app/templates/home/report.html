{% extends "layouts/base-fullscreen.html" %}
{% block title %} Prompts {% endblock %}
<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}
<link type="text/css" href="/static/assets/vendor/@fortawesome/fontawesome-free/css/all.min.css" rel="stylesheet">
<link type="text/css" href="/static/assets/css/main.css" rel="stylesheet">
<script src="{{ url_for('static', filename='assets/js/plotly-latest.min.js') }}"></script>
<style>
    .chart-container {
        width: 100%;
        height: 300px;
    }
    .graph-container {
        display: none;
    }
    .dropdown-btn {
        cursor: pointer;
        padding: 5px 10px 5px 10px !important;
    }
</style>
{% endblock stylesheets %}
{% block content %}
<main>
    <div class="main-background">
        {% include 'includes/sidebar.html' %}
        <div class="main-body">
            <div class="main-body-header">
                {% with msgs = get_flashed_messages() %}
                {% include 'includes/flashed-msg.html' %}
                {% endwith %}
            </div>
            <div class="start-section ms-4 m10-top" style="align-items: normal;">
                <div class="pr-10 col-lg-6">
                    <div class="card" style="height: auto; border-left: 4px solid #ffc107;">
                        <div class="card-header-sm">Performance analysis <span class="fas fa-exclamation-triangle" style="color: #ffc107;"></span></div>
                        <div class="card-body">
                            <p class="mb-0 fs--1">Summary: The performance testing results indicate that the system shows both strengths and areas for improvement. The key areas for improvement include response time stability and anomaly detection in throughput and response times.</p>
                            <p class="mb-0 fs--1">Analysis:</p>
                            <p class="mb-0 fs--1">- The throughput was generally stable during the test, with a minor anomaly detected where the metric dropped to 61.27.</p>
                            <p class="mb-0 fs--1">- The response times, including average, median, and 90th percentile, were not stable during the test, showing potential increases and anomalies, particularly during a specific time window.</p>
                        </div>
                    </div>
                </div>
                <div class="pr-10 col-lg-6">
                    <div class="card" style="height: 100%;">
                        <div class="card-header-sm">Test details</div>
                        <div class="card-body flex">
                            <div class="pr-10 col-lg-6">
                                <div>Start time:</div>
                                <div class="m10-top">End time:</div>
                                <div class="m10-top">Duration:</div>
                            </div>
                            <div class="pr-10 col-lg-6">
                                <div class="secondary-text" id="startTimeDetail"></div>
                                <div class="m10-top secondary-text" id="endTimeDetail"></div>
                                <div class="m10-top secondary-text" id="durationDetail"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="start-section justify-content-between ms-4 m10-top">
                <div class="pr-10 col-xxl-2-5 col-lg-2-5">
                    <div class="card">
                        <div class="card-body">
                            <p class="text-info fs-2 fw-bold mb-0" id="vuCard">...</p>
                            <span class="fs--1 text-900 lh-lg">Virtual users</span>
                        </div>
                    </div>
                </div>
                <div class="pr-10 col-xxl-2-5 col-lg-2-5">
                    <div class="card">
                        <div class="card-body">
                            <p class="text-info fs-2 fw-bold mb-0" id="throughputCard">...</p>
                            <span class="fs--1 text-900 lh-sm">Throughput</span>
                        </div>
                    </div>
                </div>
                <div class="pr-10 col-xxl-2-5 col-lg-2-5">
                    <div class="card">
                        <div class="card-body">
                            <p class="text-info fs-2 fw-bold mb-0" id="medianCard">...</p>
                            <span class="fs--1 text-900 lh-sm">Median</span>
                        </div>
                    </div>
                </div>
                <div class="pr-10 col-xxl-2-5 col-lg-2-5">
                    <div class="card">
                        <div class="card-body">
                            <p class="text-info fs-2 fw-bold mb-0" id="pct90Card">...</p>
                            <span class="fs--1 text-900 lh-sm">90% Response time</span>
                        </div>
                    </div>
                </div>
                <div class="pr-10 col-xxl-2-5 col-lg-2-5">
                    <div class="card">
                        <div class="card-body">
                            <p class="text-info fs-2 fw-bold mb-0" id="errorsCard">...</p>
                            <span class="fs--1 text-900 lh-sm">Error rate</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="start-section ms-4 m10-top me-4">
                <div class="pr-10 col-lg-6">
                    <div class="chart-card">
                        <div class="nopadding chart-container" id="throughputChart"></div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="chart-card">
                        <div class="nopadding chart-container" id="responseTimeChart"></div>
                    </div>
                </div>
            </div>
            <div class="start-section ms-4 m10-top me-4">
                <div class="pr-10 col-lg-6">
                    <div class="chart-card">
                        <div class="nopadding chart-container" id="responseTimeScatterChart"></div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="chart-card">
                        <div class="nopadding chart-container" id="overalErrors"></div>
                    </div>
                </div>
            </div>
            <div id="data-component-card" class="card ms-4 m10-top me-4">
                <div class="card-body">
                    <div id="aggregated-table">
                        <div class="table-responsive">
                            <table class="table fs--1 mb-0">
                                <thead>
                                    <tr>
                                        <th class="sort" data-sort="label">Label</th>
                                        <th class="sort" data-sort="count">Count</th>
                                        <th class="sort" data-sort="avg">Avg [ms]</th>
                                        <th class="sort" data-sort="pct50">Pct50 [ms]</th>
                                        <th class="sort" data-sort="pct75">Pct75 [ms]</th>
                                        <th class="sort" data-sort="pct90">Pct90 [ms]</th>
                                        <th class="sort" data-sort="rpm">Reqs/min</th>
                                        <th class="sort" data-sort="errors">Errors</th>
                                        <th class="sort" data-sort="stddev">Stddev</th>
                                    </tr>
                                </thead>
                                <tbody class="list">
                                    <!-- Rows will be dynamically inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div id="data-component-card" class="card ms-4 m10-top me-4">
                <div class="card-header-sm">Analysis</div>
                <div class="card-body">
                    <div id="analysis-table">
                        <div class="table-responsive">
                            <table class="table fs--1 mb-0">
                                <thead>
                                    <tr>
                                        <th class="sort" data-sort="status">Status</th>
                                        <th class="sort" data-sort="method">Method</th>
                                        <th class="sort" data-sort="description">Description</th>
                                    </tr>
                                </thead>
                                <tbody class="list">
                                    <!-- Rows will be dynamically inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            let chartData = null;
            let styling = null;
            let layoutConfig = null;
            const testTitle = "{{ test_title }}";

            console.log(`Fetching data for test_title: ${testTitle}`); // Debugging

            fetch(`/api/data?test_title=${encodeURIComponent(testTitle)}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(response => {
                    console.log('Data fetched:', response); // Debugging
                    chartData = response.data;
                    styling = response.styling;
                    layoutConfig = response.layout;
                    const analysisData = response.analysis;
                    const aggregatedResults = response.aggregated_results;
                    const testDetails = response.test_details;
                    const statistics = response.statistics;

                    updateTestDetails(testDetails);
                    updateCards(aggregatedResults);
                    updateTable(statistics); // New function to update the table
                    updateAnalysisTable(analysisData); // New function to update the analysis table
                    createGraphs(); // Creating initial graphs
                    createScatterChartForResponseTimes(chartData.avgResponseTimePerReq, 'responseTimeScatterChart'); // Create the scatter chart

                    // Attach event listeners after rows are inserted
                    initializeListJs();
                    addDropdownEventListeners();
                })
                .catch(error => {
                    console.error('Error fetching data:', error); // Debugging
                });

            function initializeListJs() {
                const options = {
                    valueNames: ['label', 'count', 'avg', 'pct50', 'pct75', 'pct90', 'rpm', 'errors', 'stddev']
                };

                const tableList = new List('aggregated-table', options);

                tableList.on('updated', function () {
                    const rows = Array.from(document.querySelectorAll('.stat-row'));
                    const parent = rows[0].parentNode;

                    rows.forEach(statRow => {
                        const transaction = statRow.dataset.transaction;
                        const graphRow = document.getElementById(`graph-${transaction}`);

                        if (graphRow) {
                            parent.insertBefore(graphRow, statRow.nextSibling);
                        }
                    });
                });
            }

            function updateCards(aggregatedResults) {
                document.getElementById('vuCard').innerHTML = `${aggregatedResults.vu}`;
                document.getElementById('throughputCard').innerHTML = `${aggregatedResults.throughput}`;
                document.getElementById('medianCard').innerHTML = `${aggregatedResults.median}`;
                document.getElementById('pct90Card').innerHTML = `${aggregatedResults['90pct']}`;
                document.getElementById('errorsCard').innerHTML = `${aggregatedResults.errors}`;
            }

            function updateTestDetails(testDetails) {
                document.getElementById('startTimeDetail').innerHTML = `${testDetails.start_time}`;
                document.getElementById('endTimeDetail').innerHTML = `${testDetails.end_time}`;
                document.getElementById('durationDetail').innerHTML = `${testDetails.duration}`;
            }

            function updateTable(statistics) {
                const tbody = document.querySelector('#aggregated-table .list');
                tbody.innerHTML = ''; // Clear any existing rows

                statistics.forEach(stat => {
                    const row = `
                        <tr class="stat-row" data-transaction="${stat.transaction}">
                            <th class="label">
                                <button class="dropdown-btn btn btn-primary" data-target="chart-${stat.transaction}">˅</button>
                                ${stat.transaction}
                            </th>
                            <th class="count">${stat.count}</th>
                            <th class="avg">${stat.avg}</th>
                            <th class="pct50">${stat.pct50}</th>
                            <th class="pct75">${stat.pct75}</th>
                            <th class="pct90">${stat.pct90}</th>
                            <th class="rpm">${stat.rpm.toFixed(2)}</th>
                            <th class="errors">${stat.errors.toFixed(2)}</th>
                            <th class="stddev">${stat.stddev}</th>
                        </tr>
                        <tr class="graph-container" id="graph-${stat.transaction}" style="display: none;" data-transaction="${stat.transaction}">
                            <td colspan="9">
                                <div class="chart" id="chart-${stat.transaction}" style="height: 300px;"></div>
                            </td>
                        </tr>`;
                    tbody.insertAdjacentHTML('beforeend', row);
                });
            }

            function updateAnalysisTable(analysisData) {
                const tbody = document.querySelector('#analysis-table .list');
                tbody.innerHTML = ''; // Clear any existing rows

                analysisData.forEach(analysis => {
                    let badgeClass;
                    if (analysis.status === 'passed') {
                        badgeClass = 'badge-success';
                    } else if (analysis.status === 'failed') {
                        badgeClass = 'badge-failure';
                    } else {
                        badgeClass = 'badge-primary';
                    }

                    const row = `
                        <tr>
                            <td class="status"><span class="badge ${badgeClass}">${analysis.status}</span></td>
                            <td class="method">${analysis.method}</td>
                            <td class="description">${analysis.description}</td>
                        </tr>`;
                    tbody.insertAdjacentHTML('beforeend', row);
                });
            }

            function addDropdownEventListeners() {
                document.querySelectorAll('.dropdown-btn').forEach(btn => {
                    btn.addEventListener('click', function () {
                        console.log('Dropdown button clicked'); // Debugging
                        const parentRow = this.closest('.stat-row');
                        const transaction = parentRow.dataset.transaction;
                        const graphRow = document.getElementById(`graph-${transaction}`);

                        if (!graphRow) {
                            console.error(`Graph row not found for transaction: ${transaction}`);
                            return;
                        }

                        // Toggle graph visibility and button rotation
                        if (graphRow.style.display === 'none' || !graphRow.style.display) {
                            graphRow.style.display = 'table-row';
                            this.innerHTML = '^'; // Change to up arrow
                            drawGraph(transaction, `chart-${transaction}`);
                        } else {
                            graphRow.style.display = 'none';
                            this.innerHTML = '˅'; // Change to down arrow
                        }
                    });
                });
            }

            function drawGraph(transactionName, chartElementId) {
                console.log(`Drawing graph for transaction: ${transactionName}`); // Debugging
                const avgTransactionData = chartData.avgResponseTimePerReq.find(transaction => transaction.name === transactionName);
                const medianTransactionData = chartData.medianResponseTimePerReq.find(transaction => transaction.name === transactionName);
                const pctTransactionData = chartData.pctResponseTimePerReq.find(transaction => transaction.name === transactionName);

                if (!avgTransactionData || !medianTransactionData || !pctTransactionData) {
                    console.error(`Transaction data not found for: ${transactionName}`);
                    return;
                }

                const timestamps = avgTransactionData.data.map(d => new Date(d.timestamp));
                const avgValues = avgTransactionData.data.map(d => d.value);
                const avgAnomalies = avgTransactionData.data.map(d => d.anomaly !== 'Normal');
                const avgAnomalyMessages = avgTransactionData.data.map(d => d.anomaly);

                const medianValues = medianTransactionData.data.map(d => d.value);
                const medianAnomalies = medianTransactionData.data.map(d => d.anomaly !== 'Normal');
                const medianAnomalyMessages = medianTransactionData.data.map(d => d.anomaly);

                const pctValues = pctTransactionData.data.map(d => d.value);
                const pctAnomalies = pctTransactionData.data.map(d => d.anomaly !== 'Normal');
                const pctAnomalyMessages = pctTransactionData.data.map(d => d.anomaly);

                createGraph(chartElementId, `Response Time - ${transactionName}`, timestamps, [
                    { name: 'Avg Response Time', data: avgValues, anomalies: avgAnomalies, anomalyMessages: avgAnomalyMessages, color: 'rgba(2, 208, 81, 0.8)', yAxisUnit: 'ms' },
                    { name: 'Median Response Time', data: medianValues, anomalies: medianAnomalies, anomalyMessages: medianAnomalyMessages, color: 'rgba(23, 100, 254, 0.8)', yAxisUnit: 'ms' },
                    { name: 'Pct90 Response Time', data: pctValues, anomalies: pctAnomalies, anomalyMessages: pctAnomalyMessages, color: 'rgba(245, 165, 100, 1)', yAxisUnit: 'ms' }
                ], styling, layoutConfig);
            }

            function createGraphs() {
                const timestamps = chartData.overalAvgResponseTime.data.map(d => new Date(d.timestamp));

                const avgResponseTime = chartData.overalAvgResponseTime.data.map(d => d.value);
                const avgResponseTimeAnomalies = chartData.overalAvgResponseTime.data.map(d => d.anomaly !== 'Normal');
                const avgResponseTimeAnomalyMessages = chartData.overalAvgResponseTime.data.map(d => d.anomaly);

                const medianResponseTime = chartData.overalMedianResponseTime.data.map(d => d.value);
                const medianResponseTimeAnomalies = chartData.overalMedianResponseTime.data.map(d => d.anomaly !== 'Normal');
                const medianResponseTimeAnomalyMessages = chartData.overalMedianResponseTime.data.map(d => d.anomaly);

                const pctResponseTime = chartData.overal90PctResponseTime.data.map(d => d.value);
                const pctResponseTimeAnomalies = chartData.overal90PctResponseTime.data.map(d => d.anomaly !== 'Normal');
                const pctResponseTimeAnomalyMessages = chartData.overal90PctResponseTime.data.map(d => d.anomaly);

                const throughput = chartData.overalThroughput.data.map(d => d.value);
                const throughputAnomalies = chartData.overalThroughput.data.map(d => d.anomaly !== 'Normal');
                const throughputAnomalyMessages = chartData.overalThroughput.data.map(d => d.anomaly);

                const users = chartData.overalUsers.data.map(d => d.value);

                const errors = chartData.overalErrors.data.map(d => d.value);

                createGraph('throughputChart', 'Throughput and Users', timestamps, [
                    { name: 'Throughput', data: throughput, anomalies: throughputAnomalies, anomalyMessages: throughputAnomalyMessages, color: 'rgba(31, 119, 180, 1)', yAxisUnit: 'r/s' },
                    { name: 'Users', data: users, anomalies: [], anomalyMessages: [], color: 'rgba(0, 155, 162, 0.8)', yAxisUnit: 'vu', useRightYAxis: true }
                ], styling, layoutConfig);

                createGraph('responseTimeChart', 'Response Time', timestamps, [
                    { name: 'Avg Response Time', data: avgResponseTime, anomalies: avgResponseTimeAnomalies, anomalyMessages: avgResponseTimeAnomalyMessages, color: 'rgba(2, 208, 81, 0.8)', yAxisUnit: 'ms' },
                    { name: 'Median Response Time', data: medianResponseTime, anomalies: medianResponseTimeAnomalies, anomalyMessages: medianResponseTimeAnomalyMessages, color: 'rgba(23, 100, 254, 0.8)', yAxisUnit: 'ms' },
                    { name: '90Pct Response Time', data: pctResponseTime, anomalies: pctResponseTimeAnomalies, anomalyMessages: pctResponseTimeAnomalyMessages, color: 'rgba(245, 165, 100, 1)', yAxisUnit: 'ms' }
                ], styling, layoutConfig);

                createGraph('overalErrors', 'Errors', timestamps, [
                    { name: 'Errors', data: errors, anomalies: [], anomalyMessages: [], color: 'rgba(255, 8, 8, 0.8)', yAxisUnit: 'er' }
                
                ], styling, layoutConfig);
            }

            function createGraph(divId, title, labels, metrics, styling, layoutConfig) {
                const traces = metrics.map(metric => {
                    return {
                        x: labels,
                        y: metric.data,
                        mode: 'lines+markers',
                        name: metric.name,
                        marker: {
                            color: (metric.anomalies.length > 0 ? metric.anomalies : metric.data.map(() => false)).map(anomaly => anomaly ? styling.marker_color_anomaly : styling.marker_color_normal),
                            size: (metric.anomalies.length > 0 ? metric.anomalies : metric.data.map(() => false)).map(anomaly => anomaly ? styling.marker_size : 0) // Show markers only for anomalies
                        },
                        text: (metric.anomalyMessages.length > 0 ? metric.anomalyMessages : metric.data.map(() => '')).map((msg, index) => metric.anomalies[index] ? msg : ''),
                        hoverinfo: 'x+y+text',
                        line: { shape: styling.line_shape, width: styling.line_width, color: metric.color },
                        yaxis: metric.useRightYAxis ? 'y2' : 'y' // Use secondary y-axis if specified
                    };
                });

                const leftYAxisColor = metrics.find(metric => !metric.useRightYAxis).color;
                const rightYAxisColor = metrics.find(metric => metric.useRightYAxis)?.color || leftYAxisColor;

                const layout = {
                    title: {
                        text: title,
                        font: {
                            color: styling.title_font_color,
                            family: styling.font_family, // Customize font family
                            size: styling.title_size // Customize font size
                        }
                    },
                    paper_bgcolor: styling.paper_bgcolor,
                    plot_bgcolor: styling.plot_bgcolor,
                    xaxis: {
                        tickfont: {
                            color: styling.axis_font_color,
                            family: styling.font_family, // Use font family from backend
                            size: styling.xaxis_tickfont_size // Use x-axis tick font size from backend
                        },
                        color: styling.axis_font_color,
                        gridcolor: styling.gridcolor // Grid color
                    },
                    yaxis: {
                        tickfont: {
                            color: leftYAxisColor,
                            family: styling.font_family, // Use font family from backend
                            size: styling.yaxis_tickfont_size // Use y-axis tick font size from backend
                        },
                        color: leftYAxisColor,
                        ticksuffix: ` ${metrics.find(metric => !metric.useRightYAxis).yAxisUnit}`, // Add unit of measurement next to the value
                        zeroline: false, // Disable the zero line,
                        gridcolor: styling.gridcolor // Grid color
                    },
                    yaxis2: {
                        tickfont: {
                            color: rightYAxisColor, // Color for the secondary y-axis
                            family: styling.font_family, // Use font family from backend
                            size: styling.yaxis_tickfont_size // Use y-axis tick font size from backend
                        },
                        color: rightYAxisColor,
                        ticksuffix: ` ${metrics.find(metric => metric.useRightYAxis)?.yAxisUnit || ''}`, // Add unit of measurement next to the value
                        zeroline: false, // Disable the zero line,
                        overlaying: 'y',
                        side: 'right',
                        showgrid: false // Disable grid lines for the secondary y-axis
                    },
                    hoverlabel: {
                        bgcolor: styling.hover_bgcolor,
                        bordercolor: styling.hover_bordercolor,
                        font: {
                            color: styling.hover_font_color,
                            family: styling.font_family // Use font family from backend
                        }
                    },
                    legend: {
                        orientation: 'h', // Horizontal orientation
                        x: 0,
                        y: -0.2, // Position the legend below the chart
                        xanchor: 'left',
                        yanchor: 'top'
                    },
                    ...layoutConfig // Spread the layout configuration from the backend
                };

                Plotly.newPlot(divId, traces, layout, { responsive: true, useResizeHandler: true });
            }

            // New function to create Scatter Chart with styling
            function createScatterChartForResponseTimes(avgResponseTimePerReq, elementId) {
                const timestamps = [];
                const values = [];
                
                avgResponseTimePerReq.forEach(transaction => {
                    transaction.data.forEach(record => {
                        timestamps.push(new Date(record.timestamp));
                        values.push(record.value);
                    });
                });

                const trace1 = {
                    x: timestamps,
                    y: values,
                    mode: 'markers',
                    type: 'scatter',
                    marker: { 
                        size: 2, // Smaller dots
                        color: styling.marker_color_normal 
                    },
                };

                const layout = {
                    title: {
                        text: 'Response Time Scatter Chart',
                        font: {
                            color: styling.title_font_color,
                            family: styling.font_family,
                            size: styling.title_size
                        }
                    },
                    paper_bgcolor: styling.paper_bgcolor,
                    plot_bgcolor: styling.plot_bgcolor,
                    xaxis: {
                        tickfont: {
                            color: styling.axis_font_color,
                            family: styling.font_family, // Use font family from backend
                            size: styling.xaxis_tickfont_size // Use x-axis tick font size from backend
                        },
                        color: styling.axis_font_color,
                        gridcolor: styling.gridcolor // Grid color
                    },
                    yaxis: {
                        tickfont: {
                            color: styling.marker_color_normal,
                            family: styling.font_family,
                            size: styling.yaxis_tickfont_size,
                        },
                        color: styling.axis_font_color,
                        gridcolor: styling.gridcolor,
                    },
                    hoverlabel: {
                        bgcolor: styling.hover_bgcolor,
                        bordercolor: styling.hover_bordercolor,
                        font: {
                            color: styling.hover_font_color,
                            family: styling.font_family,
                        },
                    },
                    legend: {
                        orientation: 'h',
                        x: 0,
                        y: -0.2,
                        xanchor: 'left',
                        yanchor: 'top'
                    },
                    ...layoutConfig
                };

                Plotly.newPlot(elementId, [trace1], layout, { responsive: true, useResizeHandler: true });
            }
        });
    </script>
</main>
{% endblock content %}