{% extends "layouts/base-fullscreen.html" %}
{% block title %} Template group {% endblock %}
<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}
<!-- <link type="text/css" href="/static/assets/css/pixel.css" rel="stylesheet"> -->
<link type="text/css" href="/static/assets/vendor/@fortawesome/fontawesome-free/css/all.min.css" rel="stylesheet">
<link type="text/css" href="/static/assets/css/main.css" rel="stylesheet">
<link type="text/css" href="/static/assets/css/report.css" rel="stylesheet">
<style>
    [v-cloak] {
        display: none;
    }
    .drag-handle {
        cursor: move;
        padding: 10px;
        border-radius: 3px;
        text-align: center;
    }
    .template-group {
        border-radius: 5px;
        padding: 10px;
        margin-bottom: 10px;
    }
    .template-item {
        transition: all 0.3s;
    }
    .sortable-ghost {
        opacity: 0.5;
        background-color: #f0f8ff;
    }
    .sortable-chosen {
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
    }
    .center-section {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 300px;
    }
</style>
{% endblock stylesheets %}
{% block content %}
    <main>
        <div class="main-background">
            {% include 'includes/sidebar.html' %}
            <div class="main-body">
                <div class="full-screen-section margin-all-10">
                    {% raw %}
                    <div id="app" style="width: 100%;" v-cloak>
                        <div v-if="isLoading" class="center-section">
                            <div class="spinner-border text-info" role="status"></div>
                        </div>
                        <form v-else class="needs-validation" novalidate="">
                            <div class="row flex-between-end pl-5 pr-5">
                                <div class="col-auto">
                                    <h2 class="mb-2">Template group page
                                        <span class="tooltip-container">
                                          <a href="https://perforge.app/docs/configuration/template_groups" target="_blank">
                                              <span class="fa-regular fa-circle-question me-2 mt-2"></span>
                                          </a>
                                          <span class="tooltip-content" style="font-size: 20px;">
                                              Click to learn more
                                          </span>
                                        </span>
                                    </h2>
                                </div>
                                <div class="col-auto">
                                    <button class="btn btn-primary mb-2 mb-sm-0" @click="checkForm">Save</button>
                                </div>
                            </div>
                            <div class="row g-5">
                            <div class="col-12 col-xl-8 pr-5">
                                <h4 class="mb-3">Report title</h4>
                                <input v-model="title" id="template-title" class="form-control mb-5" type="text" placeholder="Write title here..." required>
                                <h4 class="mb-3">Report template group</h4>
                                <div class="sortable-container">
                                    <div v-for="element in template" :key="element.id">
                                        <div v-if="element.type === 'text'" class="template-group">
                                            <div class="drag-handle"><i class="fas fa-grip-lines"></i></div>
                                            <textarea v-model="element.content" required></textarea>
                                            <button class='btn-close-id btn-close ms-2' @click="removeElement(element)" type="button"></button>
                                        </div>
                                        <div v-else-if="element.type === 'template'" class="template-group">
                                            <div class="drag-handle"><i class="fas fa-grip-lines"></i></div>
                                            <span class="badge badge-primary">TEMPLATE</span>
                                            <div class="template-el-label">Name: {{ getTemplateNameById(element.template_id) }}</div>
                                            <div class="flex-end">
                                                <button class='btn-close-id btn-close' @click="removeElement(element)" type="button"></button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <button class="btn btn-primary mt-3" @click="addTextElement" type="button">Add Text</button>
                                <div class="d-flex mt-3">
                                    <div class="form-check form-switch min-h-auto mb-0">
                                        <input v-model="ai_summary" class="form-check-input" id="ai_summary" type="checkbox" checked="">
                                    </div>
                                    <label class="form-check-label" for="ai_summary">AI summary</label>
                                </div>
                                <div v-if="ai_summary" class="mt-3">
                                    <label>Template group prompt:</label>
                                    <v-select class="vue-select-imput" v-model="selectedTemplateGroupPrompt" :options="template_group_prompts" label="name" @input="updateTemplateGroupPrompt"></v-select>
                                    <textarea v-model="templateGroupPromptText" class="form-control mt-2" rows="7" readonly></textarea>
                                </div>
                            </div>
                            <div class="col-12 col-xl-4">
                                <div class="row g-2">
                                    <div class="col-12 col-xl-12">
                                        <div class="card mb-3">
                                            <div class="card-body">
                                                <div class="margin-all-10">
                                                    <label for="template">Template group name</label>
                                                    <input v-model="name" id="template-name" class="form-control" type="text" required>
                                                </div>
                                                <div class="margin-all-10">
                                                    <label>Add templates</label>
                                                    <v-select class="vue-select-imput" :options="templates" label="name" @input="addTemplateElement" required></v-select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-12 col-xl-12">
                                        <div class="card">
                                            <div class="card-body">
                                                <div>
                                                    <label>Why we need it?</label>
                                                    <div>
                                                        <label class="var-description">A template group is useful when you need to generate reports for multiple tests simultaneously. It enables you to establish the order of test IDs for which reports will be created, and additionally, you can create a template summary for all the reports.</label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                    {% endraw %}
                </div>
                {% with msgs = get_flashed_messages() %}
                    {% include 'includes/flashed-msg.html' %}
                {% endwith %}
            </div>
        </div>
        <script src="//cdnjs.cloudflare.com/ajax/libs/vue/2.5.2/vue.min.js"></script>
        <!-- CDNJS :: Sortable (https://cdnjs.com/) -->
        <script src="//cdn.jsdelivr.net/npm/sortablejs@1.8.4/Sortable.min.js"></script>
        <!-- CDNJS :: Vue.Draggable (https://cdnjs.com/) -->
        <script src="//cdnjs.cloudflare.com/ajax/libs/Vue.Draggable/2.20.0/vuedraggable.umd.min.js"></script>
        <script src="https://unpkg.com/vue-select@latest"></script>
        <link rel="stylesheet" href="https://unpkg.com/vue-select@latest/dist/vue-select.css">

        <script>
            document.addEventListener('DOMContentLoaded', function() {
                Vue.component('v-select', {
                extends: VueSelect.VueSelect,
                props: ['attrs'],
                });

                const app = new Vue({
                    el: '#app',
                    data() {
                        return {
                            isLoading: true,
                            templates: [],
                            name: "",
                            title: "",
                            template: [],
                            ai_summary: false,
                            prompt_id: "",
                            selectedTemplateGroupPrompt: null,
                            template_group_prompts: [],
                            idCounter: 1 // Add a counter for generating IDs
                        };
                    },
                    computed: {
                        templateGroupPromptText() {
                            return this.selectedTemplateGroupPrompt ? this.selectedTemplateGroupPrompt.prompt : '';
                        }
                    },
                    methods: {
                        addTextElement() {
                            this.template.push({
                                id: this.idCounter,
                                template_id: null,
                                type: 'text',
                                content: ''
                            });
                            this.idCounter++;
                        },
                        addTemplateElement(element) {
                            if (element !== null) {
                                this.template.push({
                                    id: this.idCounter,
                                    template_id: element.id,
                                    type: 'template',
                                    content: ''
                                });
                                this.idCounter++;
                            }
                        },
                        removeElement(element) {
                            const index = this.template.indexOf(element);
                            if (index !== -1) {
                                this.template.splice(index, 1);
                            }
                        },
                        updateTemplateOrder(newOrder) {
                            // This method is called from the Sortable onEnd handler
                            console.log("Updating template order to:", newOrder);

                            // Ensure all items have the required content field
                            newOrder.forEach(item => {
                                if (!item.hasOwnProperty('content')) {
                                    item.content = '';
                                }
                            });

                            // Update the template array with the new order
                            this.template = newOrder;
                        },
                        checkForm() {
                            const form = document.querySelector(".needs-validation");
                            perforge.utils.validateForm(form, event, (result) => {
                                if (result) {
                                    let plainTemplate = JSON.parse(JSON.stringify(this.template));
                                    for (const item of plainTemplate) {
                                        if (item.type === 'text') {
                                            item.content = item.content.replace(/"/g, '\\\"');
                                        }
                                    }
                                    const results = {
                                        "id": '{{ "" if template_group_config is none else template_group_config }}',
                                        "name": this.name,
                                        "title": this.title,
                                        "data": plainTemplate,
                                        "prompt_id": this.prompt_id || null,
                                        "ai_summary": this.ai_summary
                                    }

                                    const templateGroupId = results.id;
                                    if (templateGroupId && templateGroupId !== 'None') {
                                        apiClient.templateGroups.update(templateGroupId, results)
                                            .then(response => {
                                                console.log("Template group updated successfully:", response);
                                                showFlashMessage("Template group updated successfully", "success");
                                                window.location.href = "/templates";
                                            })
                                            .catch(error => {
                                                console.error("Error updating template group:", error);
                                                showFlashMessage(error.message || "Error updating template group", "error");
                                            });
                                    } else {
                                        apiClient.templateGroups.create(results)
                                            .then(response => {
                                                console.log("Template group created successfully:", response);
                                                showFlashMessage("Template group created successfully", "success");
                                                window.location.href = "/templates";
                                            })
                                            .catch(error => {
                                                console.error("Error creating template group:", error);
                                                showFlashMessage(error.message || "Error creating template group", "error");
                                            });
                                    }
                                }
                            });
                        },
                        updateTemplateGroupPrompt(selectedOption) {
                            this.prompt_id = selectedOption.id;
                            this.selectedTemplateGroupPrompt = selectedOption;
                        },
                        getTemplateNameById(template_id) {
                            const template = this.templates.find(template => template.id === template_id);
                            return template ? template.name : '';
                        }
                    },
                    created() {
                        function addTypeToName(prompts) {
                            prompts.forEach(prompt => { prompt.name = `${prompt.name} (${prompt.type})`; });
                            return prompts;
                        }

                        // Start loading
                        this.isLoading = true;
                        Promise.all([
                            apiClient.templates.getAll(),
                            apiClient.prompts.getAll({ place: 'template_group' })
                        ])
                        .then(([templatesResponse, templateGroupPromptsResponse]) => {
                            this.templates = templatesResponse.data.templates || [];
                            this.template_group_prompts = addTypeToName(templateGroupPromptsResponse.data.prompts || []);

                            // Check for clone parameter first
                            const cloneTemplateGroupId = new URLSearchParams(window.location.search).get('clone');
                            const templateGroupId = cloneTemplateGroupId || '{{ template_group_config }}';

                            if (templateGroupId && templateGroupId !== 'None') {
                                apiClient.templateGroups.getById(templateGroupId)
                                    .then(response => {
                                        const templateGroupData = response.data.template_group;
                                        if (templateGroupData && templateGroupData.name != null) {
                                            this.title = templateGroupData.title;
                                            // If this is a clone operation, append COPY to the name
                                            this.name = cloneTemplateGroupId ? `${templateGroupData.name} COPY` : templateGroupData.name;
                                            this.template = templateGroupData.data;
                                            this.ai_summary = templateGroupData.ai_summary;
                                            this.prompt_id = templateGroupData.prompt_id;

                                            // If cloning, clear the ID so a new template group will be created on save
                                            if (cloneTemplateGroupId) {
                                                this.template_group_id = null;
                                                this.id = null;
                                            } else {
                                                this.template_group_id = templateGroupData.id;
                                                this.id = templateGroupData.id;
                                            }

                                            if (this.template_group_prompts.length) {
                                                this.selectedTemplateGroupPrompt = this.template_group_prompts.find(prompt => prompt.id === this.prompt_id);
                                            }

                                            if (this.template && this.template.length > 0) {
                                                this.template.forEach(item => {
                                                    if (!item.hasOwnProperty('content')) {
                                                        item.content = '';
                                                    }
                                                });
                                            }
                                        }
                                    })
                                    .catch(error => {
                                        showFlashMessage(error.message || "Error loading template group", "error");
                                        console.error("Error loading template group:", error);
                                    })
                                    .finally(() => {
                                        this.isLoading = false;
                                    });
                            } else {
                                // If no template group to load, end the loading state
                                this.isLoading = false;
                            }
                        })
                        .catch(error => {
                            showFlashMessage(error.message || "Error loading data", "error");
                            console.error("Error loading data:", error);
                            this.isLoading = false;
                        });
                    },
                });
            });

            // Initialize Sortable after Vue is mounted
            setTimeout(() => {
                const sortableContainer = document.querySelector('.sortable-container');
                if (sortableContainer) {
                    new Sortable(sortableContainer, {
                        handle: '.drag-handle',
                        animation: 150,
                        onEnd: function(evt) {
                            // Access the Vue app instance
                            const app = document.querySelector('#app').__vue__;

                            // Get the old index
                            const oldIndex = evt.oldIndex;
                            // Get the new index
                            const newIndex = evt.newIndex;

                            // Create a new array with the reordered items
                            const newTemplate = [...app.template];
                            const movedItem = newTemplate.splice(oldIndex, 1)[0];
                            newTemplate.splice(newIndex, 0, movedItem);

                            // Update the template array with the new order
                            app.updateTemplateOrder(newTemplate);
                        },
                        onStart: function(evt) {
                            console.log('Drag started', evt);
                        },
                        onChange: function(evt) {
                            console.log('Order changed', evt);
                        }
                    });
                    console.log('Sortable initialized on', sortableContainer);
                } else {
                    console.error('Sortable container not found');
                }
            }, 1000);
        </script>
    </main>
{% endblock content %}
