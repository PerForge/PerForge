{% extends "layouts/base-fullscreen.html" %}
{% block title %} Advanced Settings {% endblock %}
<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}
<link type="text/css" href="/static/assets/vendor/@fortawesome/fontawesome-free/css/all.min.css" rel="stylesheet">
<link type="text/css" href="/static/assets/css/main.css" rel="stylesheet">
<style>
  .accordion-button {
    background-color: transparent !important;
    box-shadow: none !important;
    border: none !important;
    font-size: 1.0rem;
    font-weight: 500;
    padding-left: 0;
    padding-right: 0;
    color: inherit !important;
  }

  .accordion-button:not(.collapsed) {
    background-color: transparent !important;
    border: none !important;
    color: inherit !important;
  }

  .accordion-button:focus {
    border: none !important;
    box-shadow: none !important;
  }

  .accordion-button:hover {
    color: inherit !important;
  }

  .accordion-button i {
    font-size: 1.25rem;
    color: #2c7be5;
  }

  .accordion-item {
    background-color: transparent;
    border: none !important;
  }

  .accordion-body {
    border: none !important;
  }

  .settings-subsection {
    margin-top: 1.5rem;
    padding-left: 1rem;
    border-left: 3px solid #2c7be5;
  }

  .settings-subsection-title {
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: 1rem;
  }

  .setting-item {
    margin-bottom: 1.25rem;
  }

  .setting-label {
    font-weight: 500;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .setting-range {
    font-size: 0.875rem;
    color: #6c757d;
    margin-top: 0.25rem;
  }

  .category-buttons {
    margin-top: 1.5rem;
    margin-bottom: 1.5rem;
    padding-top: 1rem;
    display: flex;
    gap: 0.75rem;
  }

  .category-buttons i {
    margin-right: 0.5rem;
  }

  .btn i {
    margin-right: 0.5rem;
  }

  .loading-spinner {
    display: none;
    margin-left: 0.5rem;
  }

  .unsaved-indicator {
    display: inline-block;
    width: 8px;
    height: 8px;
    background-color: #2c7be5;
    border-radius: 50%;
    margin-left: 0.5rem;
  }



  .d-none {
    display: none !important;
  }
</style>
{% endblock stylesheets %}

{% block content %}
<main>
  <div class="main-background">
    {% include 'includes/sidebar.html' %}
    <div class="main-body">
      <div class="card mb-3 margin-all-10" data-component-card="data-component-card">
        <div class="card-body">
          <!-- Header -->
          <div class="mb-4">
            <h3 class="mb-2">Advanced Settings</h3>
            <p class="text-muted mb-1">Current Project: <strong>{{ project_name }}</strong></p>
            <p class="text-muted small mb-0">Configure ML analysis, transaction evaluation, and data aggregation
              parameters for this project.</p>
          </div>

          <!-- Settings Accordion -->
          <div class="accordion mt-3" id="settingsAccordion">

            <!-- ML Analysis Settings -->
            <div class="accordion-item">
              <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                  data-bs-target="#mlAnalysis" aria-expanded="false" aria-controls="mlAnalysis">
                  <i class="fas fa-brain me-2"></i>ML Analysis Settings
                  <span class="unsaved-indicator d-none" id="ml-analysis-unsaved"></span>
                </button>
              </h2>
              <div id="mlAnalysis" class="accordion-collapse collapse">
                <div class="accordion-body">
                  <form id="mlAnalysisForm" data-category="ml_analysis">
                    <div id="mlAnalysisSettings">
                      <!-- Settings will be loaded dynamically -->
                      <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                          <span class="visually-hidden">Loading...</span>
                        </div>
                      </div>
                    </div>
                    <div class="category-buttons">
                      <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i>Save changes
                        <span class="loading-spinner spinner-border spinner-border-sm" role="status"></span>
                      </button>
                      <button type="button" class="btn btn-secondary reset-btn" data-category="ml_analysis">
                        <i class="fas fa-undo"></i>Reset to Defaults
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            </div>

            <!-- Transaction Status Settings -->
            <div class="accordion-item">
              <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                  data-bs-target="#transactionStatus" aria-expanded="false" aria-controls="transactionStatus">
                  <i class="fas fa-check-circle me-2"></i>Transaction Status Settings
                  <span class="unsaved-indicator d-none" id="transaction-status-unsaved"></span>
                </button>
              </h2>
              <div id="transactionStatus" class="accordion-collapse collapse">
                <div class="accordion-body">
                  <form id="transactionStatusForm" data-category="transaction_status">
                    <div id="transactionStatusSettings">
                      <!-- Settings will be loaded dynamically -->
                      <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                          <span class="visually-hidden">Loading...</span>
                        </div>
                      </div>
                    </div>
                    <div class="category-buttons">
                      <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i>Save changes
                        <span class="loading-spinner spinner-border spinner-border-sm" role="status"></span>
                      </button>
                      <button type="button" class="btn btn-secondary reset-btn" data-category="transaction_status">
                        <i class="fas fa-undo"></i>Reset to defaults
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            </div>

            <!-- Data Aggregation Settings Removed -->

          </div>
        </div>
      </div>
    </div>

    <!-- Flash Messages -->
    <div class="center-section">
      {% with msgs = get_flashed_messages() %}
      {% include 'includes/flashed-msg.html' %}
      {% endwith %}
    </div>



  </div>
</main>

<!-- Reset Confirmation Modal -->
<div class="modal fade" id="resetConfirmModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-exclamation-triangle text-warning me-2"></i>Reset to defaults
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to reset <strong id="resetCategoryName"></strong> to default values?</p>
        <p class="text-muted small mb-0">This action cannot be undone. All custom values in this category will be lost.
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-warning" id="confirmResetBtn">
          <i class="fas fa-undo"></i>Reset
        </button>
      </div>
    </div>
  </div>
</div>

{% endblock content %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}
<script src="/static/assets/js/settings.js"></script>
{% endblock javascripts %}
