{% extends "layouts/base-fullscreen.html" %}
{% block title %} Template {% endblock %}
<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}
<!-- <link type="text/css" href="/static/assets/css/pixel.css" rel="stylesheet"> -->
<link type="text/css" href="/static/assets/vendor/@fortawesome/fontawesome-free/css/all.min.css" rel="stylesheet">
<link type="text/css" href="/static/assets/css/main.css" rel="stylesheet">
<link type="text/css" href="/static/assets/css/report.css" rel="stylesheet">
<style>
    [v-cloak] {
        display: none;
    }
    .drag-handle {
        cursor: move;
        padding: 10px;
        border-radius: 3px;
        text-align: center;
    }
    .template-group {
        border-radius: 5px;
        padding: 10px;
        margin-bottom: 10px;
    }
    .template-item {
        transition: all 0.3s;
    }
    .sortable-ghost {
        opacity: 0.5;
        background-color: #f0f8ff;
    }
    .sortable-chosen {
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
    }
</style>
{% endblock stylesheets %}
{% block content %}
    <main>
        <div class="main-background">
            {% include 'includes/sidebar.html' %}
            <div class="main-body">
                <div class="full-screen-section margin-all-10">
                    {% raw %}
                    <div id="app" style="width: 100%;" v-cloak>
                        <div v-if="isLoading" class="center-section">
                            <div class="spinner-border text-info" role="status"></div>
                        </div>
                        <form v-else class="needs-validation" novalidate="">
                            <div class="row flex-between-end pl-5 pr-5">
                                <div class="col-auto">
                                    <h2 class="mb-2">Template page
                                        <div class="tooltip-container">
                                            <a href="https://perforge.app/docs/configuration/templates" target="_blank">
                                                <span class="fa-regular fa-circle-question me-2 mt-2"></span>
                                            </a>
                                            <div class="tooltip-content" style="font-size: 20px;">
                                                Click to learn more
                                            </div>
                                        </div>
                                    </h2>
                                </div>
                                <div class="col-auto">
                                    <button class="btn btn-primary mb-2 mb-sm-0" type="button" @click.prevent="submitForm">Save</button>
                                </div>
                            </div>
                            <div class="row g-5">
                            <div class="col-12 col-xl-8 pr-5">
                                <h4 class="mb-3">Report title</h4>
                                <input v-model="title" id="template-title" class="form-control mb-5" type="text" placeholder="Write title here..." required>
                                <h4 class="mb-3">Report template</h4>
                                <div class="sortable-container">
                                    <div v-for="(element, index) in template" :key="element.id" class="template-item" :data-index="index">
                                        <div v-if="element.type === 'text'" class="template-group">
                                            <div class="drag-handle"><i class="fas fa-grip-lines"></i></div>
                                            <textarea v-model="element.content" required></textarea>
                                            <button class='btn-close-id btn-close ms-2' @click="removeElement(element)" type="button"></button>
                                        </div>
                                        <div v-else-if="element.type === 'graph'" class="template-group">
                                            <div class="drag-handle"><i class="fas fa-grip-lines"></i></div>
                                            <span class="badge badge-success">GRAPH</span>
                                            <div class="template-el-label">Name: ${ getGraphNameById(element.graph_id) || 'Graph not found' }</div>
                                            <div class="flex-end">
                                                <button class='btn-close-id btn-close' @click="removeElement(element)" type="button"></button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <button class="btn btn-primary mt-3" @click="addTextElement" type="button">Add Text</button>
                                <div class="d-flex flex-direction-column">
                                    <div class="d-flex justify-content-between mb-3 mt-3">
                                        <div class="d-flex flex-direction-column">
                                            <label class="form-check-label" for="ml_switch">ML analysis</label>
                                            <span class="text-description">Enable ML based analysis for test results (only for back-end)</span>
                                        </div>
                                        <div class="form-check form-switch min-h-auto mb-0">
                                            <input v-model="ml_switch" class="form-check-input" id="ml_switch" type="checkbox" checked="">
                                        </div>
                                    </div>
                                    <div class="d-flex justify-content-between mb-3">
                                        <div class="d-flex flex-direction-column">
                                            <label class="form-check-label" for="nfrs_switch">NFRs</label>
                                            <label class="text-description">Conduct a comparison of test results against NFRs. Make sure to select the NFRs for this comparison.</label>
                                        </div>
                                        <div class="form-check form-switch min-h-auto mb-0">
                                            <input v-model="nfrs_switch" class="form-check-input" id="nfrs_switch" type="checkbox" checked="">
                                        </div>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <div class="d-flex flex-direction-column">
                                            <label class="form-check-label" for="ai_switch">AI analysis</label>
                                            <label class="text-description">Test results will be evaluated by leveraging default AI integration and utilizing the provided prompts.</label>
                                        </div>
                                        <div class="form-check form-switch">
                                            <input v-model="ai_switch" class="form-check-input" id="ai_switch" type="checkbox" checked="">
                                        </div>
                                    </div>
                                    <div v-if="ai_switch" class="ps-4 mb-3">
                                        <div class="mt-3">
                                            <label>System prompt:</label>
                                            <div class="tooltip-container">
                                                <span class="fa-regular fa-circle-question me-2 mt-2"></span>
                                                <div class="tooltip-content">
                                                    A system message for AI is essential to establish the context, guidelines, and constraints for the AI's responses. This prompt will be used in addition to all other prompts.
                                                </div>
                                            </div>
                                            <v-select class="vue-select-imput" v-model="selectedSystemPrompt" :options="system_prompts" label="name" @input="updateSystemPrompt"></v-select>
                                            <textarea v-model="systemPromptText" class="form-control mt-2" rows="3" readonly></textarea>
                                        </div>
                                        <div class="mt-3">
                                            <label>Template prompt:</label>
                                            <v-select class="vue-select-imput" v-model="selectedTemplatePrompt" :options="template_prompts" label="name" @input="updateTemplatePrompt"></v-select>
                                            <textarea v-model="templatePromptText" class="form-control mt-2" rows="5" readonly></textarea>
                                        </div>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <div class="d-flex flex-direction-column">
                                            <label class="form-check-label" for="ai_aggregated_data_switch">AI aggregated data analysis</label>
                                            <label class="text-description">Clarify if there's a need to conduct an analysis of the aggregated data.</label>
                                        </div>
                                        <div class="form-check form-switch">
                                            <input v-model="ai_aggregated_data_switch" class="form-check-input" id="ai_aggregated_data_switch" type="checkbox" :disabled="!ai_switch" :class="{ 'disabled-checkbox': !ai_switch }" checked="">
                                        </div>
                                    </div>
                                    <div v-if="ai_aggregated_data_switch" class="mt-3">
                                        <label>Aggregated data prompt:</label>
                                        <v-select class="vue-select-imput" v-model="selectedAggregatedDataPrompt" :options="aggregated_data_prompts" label="name" @input="updateAggregatedDataPrompt"></v-select>
                                        <textarea v-model="aggregatedPromptText" class="form-control mt-3" rows="5" readonly></textarea>
                                    </div>
                                    <div class="d-flex justify-content-between mb-3">
                                        <div class="d-flex flex-direction-column">
                                            <label class="form-check-label" for="ai_graph_switch">AI graphs analysis</label>
                                            <label class="text-description">Clarify if there's a need to conduct an analysis of the graphs. Also, make sure you've chosen a model that can handle image inputs.</label>
                                        </div>
                                        <div class="form-check form-switch">
                                            <input v-model="ai_graph_switch" class="form-check-input" id="ai_graph_switch" type="checkbox" :disabled="!ai_switch" :class="{ 'disabled-checkbox': !ai_switch }" checked="">
                                        </div>
                                    </div>
                                    <div class="d-flex justify-content-between mb-3">
                                        <div class="d-flex flex-direction-column">
                                            <label class="form-check-label" for="ai_to_graphs_switch">Add AI observations after graphs</label>
                                            <label class="text-description">The tool will compile and place the gathered analysis beneath the graph within the report.</label>
                                        </div>
                                        <div class="form-check form-switch min-h-auto mb-0">
                                            <input v-model="ai_to_graphs_switch" class="form-check-input" id="ai_to_graphs_switch" type="checkbox" :disabled="!ai_switch" :class="{ 'disabled-checkbox': !ai_switch }" checked="">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12 col-xl-4">
                                <div class="row g-2">
                                    <div class="col-12 col-xl-12">
                                        <div class="card mb-3">
                                            <div class="card-body">
                                                <div class="margin-all-10">
                                                    <label for="template">Template name</label>
                                                    <input v-model="name" id="template-name" class="form-control" type="text" required>
                                                </div>
                                                <div v-if="nfrs_switch" class="margin-all-10">
                                                    <label for="flow">NFR</label>
                                                    <v-select v-model="nfr" class="vue-select-imput" :options="nfrs" label="name">
                                                    </v-select>
                                                </div>
                                                <div class="margin-all-10">
                                                    <label>Add graphs</label>
                                                    <v-select class="vue-select-imput" :options="graphs" label="name" @input="addGraphElement" required></v-select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-12 col-xl-12">
                                        <div class="card">
                                            <div class="card-body">
                                                <div class="variables-container">
                                                    <label>Available variables:</label>

                                                    <div class="variables-section  mt-3">
                                                        <h6>Common variables:</h6>
                                                        <div v-for="variable in commonVariables" :key="variable.name" class="variable-item">
                                                            <label class="var-name" @click="copyToClipboard(variable.name)">${ variable.name }</label>
                                                            <label class="var-description">${ variable.description }</label>
                                                        </div>
                                                    </div>

                                                    <div class="variables-section mt-3">
                                                        <h6>Backend variables:</h6>
                                                        <div v-for="variable in backendVariables" :key="variable.name" class="variable-item">
                                                            <label class="var-name" @click="copyToClipboard(variable.name)">${ variable.name }</label>
                                                            <label class="var-description">${ variable.description }</label>
                                                        </div>
                                                    </div>

                                                    <div class="variables-section mt-3">
                                                        <h6>Summary variables:</h6>
                                                        <div v-for="variable in summaryVariables" :key="variable.name" class="variable-item">
                                                            <label class="var-name" @click="copyToClipboard(variable.name)">${ variable.name }</label>
                                                            <label class="var-description">${ variable.description }</label>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-12 col-xl-12 mt-3">
                                        <div class="card">
                                            <div class="card-body">
                                                <div>
                                                    <label>Available Tables:</label>
                                                    <div class="text-description">Tables can be used in templates to display test metrics data using the following format:</div>
                                                    <div class="variables-section mt-3">
                                                        <h6>Backend Test Tables:</h6>
                                                        <div v-for="table in backendTables" :key="table.name" class="variable-item">
                                                            <label class="var-name" @click="copyToClipboard(table.name)">${ table.name }</label>
                                                            <label class="var-description">${ table.description }</label>
                                                        </div>
                                                    </div>
                                                    <div class="variables-section mt-3">
                                                        <h6>Frontend Test Tables:</h6>
                                                        <div v-for="table in frontendTables" :key="table.name" class="variable-item">
                                                            <label class="var-name" @click="copyToClipboard(table.name)">${ table.name }</label>
                                                            <label class="var-description">${ table.description }</label>
                                                        </div>
                                                        <div class="text-description mt-3">For frontend tables, always specify the aggregation type: median, mean, p90, p95, or p99. Please ensure that the desired aggregation type is available in InfluxDB</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                    {% endraw %}
                </div>
                {% with msgs = get_flashed_messages() %}
                    {% include 'includes/flashed-msg.html' %}
                {% endwith %}
            </div>
        </div>
        <script src="//cdnjs.cloudflare.com/ajax/libs/vue/2.5.2/vue.min.js"></script>
        <!-- CDNJS :: Sortable (https://cdnjs.com/) -->
        <script src="//cdn.jsdelivr.net/npm/sortablejs@1.8.4/Sortable.min.js"></script>
        <!-- CDNJS :: Vue.Draggable (https://cdnjs.com/) -->
        <script src="https://cdn.jsdelivr.net/npm/vuedraggable@2.24.3/dist/vuedraggable.umd.min.js"></script>
        <script src="https://unpkg.com/vue-select@latest"></script>
        <link rel="stylesheet" href="https://unpkg.com/vue-select@latest/dist/vue-select.css">

        <script>
            document.addEventListener('DOMContentLoaded', function() {
                Vue.component('v-select', {
                extends: VueSelect.VueSelect,
                props: ['attrs'],
                });

                initVueApp();

                // Initialize Sortable after Vue is mounted
                setTimeout(() => {
                    const sortableContainer = document.querySelector('.sortable-container');
                    if (sortableContainer) {
                        new Sortable(sortableContainer, {
                            handle: '.drag-handle',
                            animation: 150,
                            onEnd: function(evt) {
                                // Access the Vue app instance
                                const app = document.querySelector('#app').__vue__;

                                // Get the old index
                                const oldIndex = evt.oldIndex;
                                // Get the new index
                                const newIndex = evt.newIndex;

                                // Create a new array with the reordered items
                                const newTemplate = [...app.template];
                                const movedItem = newTemplate.splice(oldIndex, 1)[0];
                                newTemplate.splice(newIndex, 0, movedItem);

                                // Update the template array with the new order
                                app.updateTemplateOrder(newTemplate);
                            },
                            onStart: function(evt) {
                                console.log('Drag started', evt);
                            },
                            onChange: function(evt) {
                                console.log('Order changed', evt);
                            }
                        });
                        console.log('Sortable initialized on', sortableContainer);
                    } else {
                        console.error('Sortable container not found');
                    }
                }, 1000);

                function initVueApp() {
                    const app = new Vue({
                    el: "#app",
                    delimiters: ['${', '}'],
                    data() {
                        return {
                            isLoading: true,
                            title: '',
                            name: '',
                            graphs: [],
                            nfrs: [],
                            nfr: '',
                            template: [],
                            template_prompts: [],
                            aggregated_data_prompts: [],
                            system_prompts: [],
                            template_prompt_id: '',
                            aggregated_prompt_id: '',
                            system_prompt_id: '',
                            ai_switch: false,
                            ai_aggregated_data_switch: false,
                            ai_graph_switch: false,
                            ai_to_graphs_switch: false,
                            nfrs_switch: false,
                            ml_switch: false,
                            selectedTemplatePrompt: null,
                            selectedAggregatedDataPrompt: null,
                            selectedSystemPrompt: null,
                            idCounter: 1,
                            commonVariables: [
                                { name: '${current_test_name}', description: 'Name of the current test.' },
                                { name: '${current_duration}', description: 'Duration of the current test in seconds.' },
                                { name: '${current_start_time}', description: 'Start time of the current test.' },
                                { name: '${current_end_time}', description: 'End time of the current test.' },
                                { name: '${baseline_test_name}', description: 'Name of the baseline test.' },
                                { name: '${baseline_duration}', description: 'Duration of the baseline test in seconds.' },
                                { name: '${baseline_start_time}', description: 'Start time of the baseline test.' },
                                { name: '${baseline_end_time}', description: 'End time of the baseline test.' },
                            ],
                            backendVariables: [
                                { name: '${current_max_active_users}', description: 'Max active users for the current test.' },
                                { name: '${current_errors_pct_stats}', description: 'Error percentage for the current test.' },
                                { name: '${current_median_response_time_stats}', description: 'Median response time for the current test.' },
                                { name: '${current_median_throughput}', description: 'Median throughput for the current test.' },
                                { name: '${current_pct90_response_time_stats}', description: '90th percentile response time for the current test.' },
                                { name: '${current_grafana_link}', description: 'Grafana link for the current test.' },
                                { name: '${baseline_max_active_users}', description: 'Max active users for the baseline test.' },
                                { name: '${baseline_errors_pct_stats}', description: 'Error percentage for the baseline test.' },
                                { name: '${baseline_median_response_time_stats}', description: 'Median response time for the baseline test.' },
                                { name: '${baseline_median_throughput}', description: 'Median throughput for the baseline test.' },
                                { name: '${baseline_pct90_response_time_stats}', description: '90th percentile response time for the baseline test.' },
                                { name: '${baseline_grafana_link}', description: 'Grafana link for the baseline test.' },
                            ],
                            backendTables: [
                                { name: '${aggregated_data_table_}', description: 'Aggregated metrics for backend tests. No aggregation type needed.' }
                            ],
                            frontendTables: [
                                { name: '${google_web_vitals_table_median}', description: 'Web Vitals metrics (LCP, CLS, FID) with median aggregation.' },
                                { name: '${timings_fully_loaded_table_median}', description: 'Page fully loaded timings with median aggregation.' },
                                { name: '${timings_page_timings_table_median}', description: 'Page timings metrics with median aggregation.' },
                                { name: '${timings_main_document_table_median}', description: 'Main document load timings with median aggregation.' },
                                { name: '${cpu_long_tasks_table_median}', description: 'CPU long tasks metrics with median aggregation.' },
                                { name: '${cdp_performance_js_heap_used_size_table_median}', description: 'JavaScript heap used size metrics with median aggregation.' },
                                { name: '${cdp_performance_js_heap_total_size_table_median}', description: 'JavaScript heap total size metrics with median aggregation.' },
                                { name: '${content_types_table_}', description: 'Content types metrics with median aggregation.' },
                                { name: '${first_party_content_types_table_}', description: 'First-party content types metrics with median aggregation.' },
                                { name: '${third_party_content_types_table_}', description: 'Third-party content types metrics with median aggregation.' }
                            ],
                            summaryVariables: [
                                { name: '${nfr_summary}', description: 'Summary of Non-Functional Requirements validation.' },
                                { name: '${ml_summary}', description: 'Summary of ML-based anomaly detection.' },
                                { name: '${ai_summary}', description: 'Summary generated by AI based on test results.' },
                            ]
                        };
                    },
                    mounted() {
                        const self = this;

                        // Find the highest ID to initialize the counter properly
                        if (this.template && this.template.length > 0) {
                            let maxId = 0;
                            this.template.forEach(item => {
                                if (item.id && item.id > maxId) {
                                    maxId = item.id;
                                }
                            });
                            this.idCounter = maxId;
                        }

                        // Ensure all template items have unique IDs and content field
                        if (this.template && this.template.length > 0) {
                            this.template.forEach((item, index) => {
                                if (!item.id) {
                                    this.idCounter++;
                                    item.id = this.idCounter;
                                }
                                if (!item.hasOwnProperty('content')) {
                                    item.content = '';
                                }
                            });
                        }

                        // If template is empty, add a default text element
                        if (this.template.length === 0) {
                            this.addTextElement();
                        }
                    },
                    computed: {
                        templatePromptText() {
                            return this.selectedTemplatePrompt ? this.selectedTemplatePrompt.prompt : '';
                        },
                        aggregatedPromptText() {
                            return this.selectedAggregatedDataPrompt ? this.selectedAggregatedDataPrompt.prompt : '';
                        },
                        systemPromptText() {
                        return this.selectedSystemPrompt ? this.selectedSystemPrompt.prompt : '';
                        }
                    },
                    methods: {
                        copyToClipboard(text) {
                            navigator.clipboard.writeText(text).then(() => {
                                showFlashMessage(`Copied '${text}' to clipboard`, 'success');
                            }, (err) => {
                                showFlashMessage('Failed to copy text', 'error');
                                console.error('Could not copy text: ', err);
                            });
                        },
                        addTextElement() {
                            this.idCounter++; // Increment the counter
                            this.template.push({
                                graph_id: null,
                                type: 'text',
                                content: '',
                                id: this.idCounter
                            });
                        },
                        addGraphElement(graph) {
                            this.idCounter++; // Increment the counter
                            this.template.push({
                                graph_id: graph.id,
                                type: 'graph',
                                content: '', // Add default empty content for graph elements
                                id: this.idCounter
                            });
                        },
                        removeElement(element) {
                            this.template = this.template.filter(el => el !== element);
                        },
                        updateTemplateOrder(newOrder) {
                            // This method is called from the Sortable onEnd handler
                            console.log("Updating template order to:", newOrder);

                            // Ensure all items have the required content field
                            newOrder.forEach(item => {
                                if (!item.hasOwnProperty('content')) {
                                    item.content = '';
                                }
                            });

                            this.template = newOrder;
                        },
                        submitForm() {
                            console.log("submitForm called");
                            // Validate required fields manually
                            if (!this.title) {
                                console.error("Title is required");
                                showFlashMessage("Title is required", "error");
                                return;
                            }

                            if (!this.name) {
                                console.error("Template name is required");
                                showFlashMessage("Template name is required", "error");
                                return;
                            }

                            // Check if template has content
                            if (this.template.length === 0) {
                                console.error("Template must have at least one element");
                                showFlashMessage("Template must have at least one element", "error");
                                return;
                            }

                            // Process template data
                            let plainTemplate = JSON.parse(JSON.stringify(this.template));
                            console.log("Template before processing:", this.template);
                            console.log("Plain template after JSON conversion:", plainTemplate);

                            for (const item of plainTemplate) {
                                // Remove client-side IDs to let the server generate proper IDs
                                delete item.id;

                                // Ensure all items have a content field
                                if (!item.hasOwnProperty('content')) {
                                    item.content = '';
                                }

                                if (item.type === 'text') {
                                    if (item.content) {
                                        item.content = item.content.replace(/"/g, '\\\"');
                                    } else {
                                        console.error("Text content is required");
                                        showFlashMessage("Text content is required", "error");
                                        return;
                                    }
                                }
                            }
                            console.log("Template after processing:", plainTemplate);

                            const results = {
                                "id": '{{ "" if template_config is none or template_config == "None" else template_config }}',
                                "name": this.name,
                                "nfr": this.nfr && this.nfr.id ? this.nfr.id : null,
                                "title": this.title,
                                "ai_switch": this.ai_switch,
                                ai_aggregated_data_switch: this.ai_aggregated_data_switch,
                                "ai_graph_switch": this.ai_graph_switch,
                                "ai_to_graphs_switch": this.ai_to_graphs_switch,
                                "nfrs_switch": this.nfrs_switch,
                                "ml_switch": this.ml_switch,
                                "template_prompt_id": this.template_prompt_id || null,
                                "aggregated_prompt_id": this.aggregated_prompt_id || null,
                                "system_prompt_id": this.system_prompt_id || null,
                                "data": plainTemplate
                            }

                            console.log("Creating template with data:", results);

                            // Use API client instead of direct POST
                            const templateId = results.id;
                            if (templateId && templateId !== 'None') {
                                // Update existing template
                                apiClient.templates.update(templateId, results)
                                    .then(response => {
                                        console.log("Template updated successfully:", response);
                                        showFlashMessage("Template updated successfully", "success");
                                        window.location.href = "/templates";
                                    })
                                    .catch(error => {
                                        console.error("Error updating template:", error);
                                        showFlashMessage(error.message || "Error updating template", "error");
                                    });
                            } else {
                                // Create new template
                                apiClient.templates.create(results)
                                    .then(response => {
                                        console.log("Template created successfully:", response);
                                        showFlashMessage("Template created successfully", "success");
                                        window.location.href = "/templates";
                                    })
                                    .catch(error => {
                                        console.error("Error creating template:", error);
                                        showFlashMessage(error.message || "Error creating template", "error");
                                    });
                            }
                        },
                        updateTemplatePrompt(selectedOption) {
                            this.template_prompt_id = selectedOption.id;
                            this.selectedTemplatePrompt = selectedOption; // Ensure the selected option is updated
                        },
                        updateAggregatedDataPrompt(selectedOption) {
                            this.aggregated_prompt_id = selectedOption.id;
                            this.selectedAggregatedDataPrompt = selectedOption; // Ensure the selected option is updated
                        },
                        updateSystemPrompt(selectedOption) {
                        this.system_prompt_id = selectedOption.id;
                        this.selectedSystemPrompt = selectedOption; // Ensure the selected option is updated
                        },
                        getGraphNameById(graph_id) {
                            const graph = this.graphs.find(graph => graph.id === graph_id);
                            return graph ? graph.name : '';
                        }
                    },
                    created() {
                        function addTypeToName(prompts) {
                            prompts.forEach(prompt => { prompt.name = `${prompt.name} (${prompt.type})`; });
                            return prompts;
                        }

                        // Load data using API client
                        this.isLoading = true;
                        Promise.all([
                            apiClient.graphs.getAll(),
                            apiClient.nfrs.getAll(),
                            apiClient.prompts.getAll({ place: 'template' }),
                            apiClient.prompts.getAll({ place: 'aggregated_data' }),
                            apiClient.prompts.getAll({ place: 'system' })
                        ])
                        .then(([graphsResponse, nfrsResponse, templatePromptsResponse, aggregatedDataPromptsResponse, systemPromptsResponse]) => {
                            this.graphs = graphsResponse.data.graphs || [];
                            this.nfrs = nfrsResponse.data.nfrs || [];

                            // Process prompts
                            this.template_prompts = addTypeToName(templatePromptsResponse.data.prompts || []);
                            this.aggregated_data_prompts = addTypeToName(aggregatedDataPromptsResponse.data.prompts || []);
                            this.system_prompts = addTypeToName(systemPromptsResponse.data.prompts || []);

                            // If template_config is provided, load the template data
                            const templateId = '{{ template_config }}';
                            if (templateId && templateId !== 'None') {
                                apiClient.templates.getById(templateId)
                                    .then(response => {
                                        const templateData = response.data.template;
                                        if (templateData && templateData.name != null) {
                                            this.title = templateData.title;
                                            this.name = templateData.name;
                                            this.nfr = this.nfrs.find(nfr => nfr.id === templateData.nfr) || "";
                                            this.template = templateData.data;
                                            this.template_prompt_id = templateData.template_prompt_id;
                                            this.aggregated_prompt_id = templateData.aggregated_prompt_id;
                                            this.system_prompt_id = templateData.system_prompt_id;
                                            this.ai_switch = templateData.ai_switch;
                                            this.ai_aggregated_data_switch = templateData.ai_aggregated_data_switch;
                                            this.ai_graph_switch = templateData.ai_graph_switch;
                                            this.ai_to_graphs_switch = templateData.ai_to_graphs_switch;
                                            this.nfrs_switch = templateData.nfrs_switch;
                                            this.ml_switch = templateData.ml_switch;

                                            // Set selected options after data is loaded
                                            if (this.template_prompts.length && this.aggregated_data_prompts.length && this.system_prompts.length) {
                                                this.selectedTemplatePrompt = this.template_prompts.find(prompt => prompt.id === this.template_prompt_id);
                                                this.selectedAggregatedDataPrompt = this.aggregated_data_prompts.find(prompt => prompt.id === this.aggregated_prompt_id);
                                                this.selectedSystemPrompt = this.system_prompts.find(prompt => prompt.id === this.system_prompt_id);
                                            }
                                        }
                                    })
                                    .catch(error => {
                                        showFlashMessage(error.message || "Error loading template", "error");
                                        console.error("Error loading template:", error);
                                    })
                                    .finally(() => {
                                        this.isLoading = false;
                                    });
                            } else {
                                // If no template to load, add a default text element
                                if (this.template.length === 0) {
                                    this.addTextElement();
                                }

                                // Set default prompts if available
                                if (this.system_prompts.length > 0) {
                                    this.selectedSystemPrompt = this.system_prompts[0];
                                    this.system_prompt_id = this.system_prompts[0].id;
                                }
                                if (this.template_prompts.length > 0) {
                                    this.selectedTemplatePrompt = this.template_prompts[0];
                                    this.template_prompt_id = this.template_prompts[0].id;
                                }
                                if (this.aggregated_data_prompts.length > 0) {
                                    this.selectedAggregatedDataPrompt = this.aggregated_data_prompts[0];
                                    this.aggregated_prompt_id = this.aggregated_data_prompts[0].id;
                                }

                                this.isLoading = false;
                            }
                        })
                        .catch(error => {
                            showFlashMessage(error.message || "Error loading initial data", "error");
                            console.error("Error loading initial data:", error);
                            this.isLoading = false;
                        });
                    },
                });
                }
            });
        </script>
    </main>
{% endblock content %}
