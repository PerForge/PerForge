{% extends "layouts/base-fullscreen.html" %}
{% block title %} Template {% endblock %}
<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}
<!-- <link type="text/css" href="/static/assets/css/pixel.css" rel="stylesheet"> -->
<link type="text/css" href="/static/assets/vendor/@fortawesome/fontawesome-free/css/all.min.css" rel="stylesheet">
<link type="text/css" href="/static/assets/css/main.css" rel="stylesheet">
<link type="text/css" href="/static/assets/css/report.css" rel="stylesheet">
<style>
    [v-cloak] {
        display: none;
    }
    .drag-handle {
        cursor: move;
        padding: 10px;
        border-radius: 3px;
        text-align: center;
    }
    .template-group {
        border-radius: 5px;
        padding: 10px;
        margin-bottom: 10px;
    }
    .template-item {
        transition: all 0.3s;
    }
    .sortable-ghost {
        opacity: 0.5;
        background-color: #f0f8ff;
    }
    .sortable-chosen {
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
    }
    .copy-icon {
        cursor: pointer;
        opacity: 0.8;
    }
    .copy-icon:hover {
        opacity: 1;
    }
    /* Graph item layout */
    .graph-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 8px 16px;
        flex-wrap: wrap;
    }
    .graph-meta {
        display: flex;
        align-items: center;
        gap: 8px;
        flex: 1 1 auto;
        min-width: 0; /* allow children (name) to shrink and ellipsize in flex */
    }
    .graph-name {
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 6px;
        min-width: 0;
        max-width: 100%;
    }
    .graph-name-label {
        white-space: nowrap;
        flex: 0 0 auto;
    }
    .graph-name-value {
        white-space: nowrap;
        overflow: visible;
        text-overflow: ellipsis;
    }
    .graph-toggles {
        display: flex;
        align-items: center;
        gap: 24px;
        flex-wrap: nowrap;
    }
    .graph-toggles .toggle-item {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: nowrap;
    }
    /* Render both switches inline horizontally */
    .graph-toggles .toggle-item .form-check {
        display: inline-flex;
        align-items: center;
        gap: 6px; /* small space between checkbox and text */
        margin-bottom: 0; /* override bootstrap's block spacing */
        flex: 0 0 auto; /* prevent full-width expansion */
    }
    /* Align checkbox and text perfectly on the same line */
    .graph-toggles .toggle-item .form-check .form-check-input {
        margin-top: 0; /* override Bootstrap's default 0.3em */
    }
    .graph-toggles label {
        margin-bottom: 0;
    }
    .graph-toggles .form-check-label {
        white-space: nowrap;
    }
    /* Ensure the disabled caption is red and breaks to a new line under toggles */
    .ai-disabled-caption {
        color: #dc3545 !important; /* enforce red even if .form-text sets muted color */
        flex-basis: 100%; /* take full width under the flex row */
    }
</style>
{% endblock stylesheets %}
{% block content %}
    <main>
        <div class="main-background">
            {% include 'includes/sidebar.html' %}
            <div class="main-body">
                <div class="full-screen-section margin-all-10">
                    {% raw %}
                    <div id="app" style="width: 100%;" v-cloak>
                        <div v-if="isLoading" class="center-section">
                            <div class="spinner-border text-info" role="status"></div>
                        </div>
                        <form v-else class="needs-validation" novalidate="">
                            <div class="row">
                            <div class="col-12 col-xl-23p pr-1">
                                <div class="row g-2">
                                    <div class="col-12 mb-3">
                                        <div class="card">
                                            <div class="card-body">
                                                <div class="d-flex flex-direction-column">
                                                    <div class="d-flex justify-content-between mb-3">
                                                        <div class="d-flex flex-direction-column">
                                                            <label class="form-check-label" for="ml_switch">ML analysis</label>
                                                            <span class="text-description">Enable ML based analysis for test results (only for back-end)</span>
                                                        </div>
                                                        <div class="form-check form-switch min-h-auto mb-0">
                                                            <input v-model="ml_switch" class="form-check-input" id="ml_switch" type="checkbox" checked="">
                                                        </div>
                                                    </div>
                                                    <div class="d-flex justify-content-between" :class="{ 'mb-3': !nfrs_switch }">
                                                        <div class="d-flex flex-direction-column">
                                                            <label class="form-check-label" for="nfrs_switch">NFR analysis</label>
                                                            <label class="text-description">Conduct a comparison of test results against NFRs. Make sure to select the NFRs for this comparison.</label>
                                                        </div>
                                                        <div class="form-check form-switch min-h-auto mb-0">
                                                            <input v-model="nfrs_switch" class="form-check-input" id="nfrs_switch" type="checkbox" checked="">
                                                        </div>
                                                    </div>
                                                    <div v-if="nfrs_switch" class="ps-4 mb-3">
                                                        <div class="mt-3">
                                                            <v-select v-model="nfr" class="vue-select-imput" :options="nfrs" label="name"></v-select>
                                                        </div>
                                                    </div>
                                                    <div class="d-flex justify-content-between" :class="{ 'mb-3': !ai_switch }">
                                                        <div class="d-flex flex-direction-column">
                                                            <label class="form-check-label" for="ai_switch">AI analysis</label>
                                                            <label class="text-description">Test results will be evaluated by leveraging default AI integration and utilizing the provided prompts.</label>
                                                        </div>
                                                        <div class="form-check form-switch">
                                                            <input v-model="ai_switch" class="form-check-input" id="ai_switch" type="checkbox" checked="">
                                                        </div>
                                                    </div>
                                                    <div v-if="ai_switch" class="ps-4 mb-3">
                                                        <div class="mt-3">
                                                            <label>System prompt:
                                                                <span class="tooltip-container">
                                                                    <span class="fa-regular fa-circle-question me-2 mt-2"></span>
                                                                    <span class="tooltip-content">
                                                                        A system message for AI is essential to establish the context, guidelines, and constraints for the AI's responses. This prompt will be used in addition to all other prompts.
                                                                    </span>
                                                                </span>
                                                            </label>
                                                            <v-select class="vue-select-imput" v-model="selectedSystemPrompt" :options="system_prompts" label="name" @input="updateSystemPrompt"></v-select>
                                                            <textarea v-model="systemPromptText" class="form-control mt-2" rows="3" readonly></textarea>
                                                        </div>
                                                        <div class="mt-3">
                                                            <label>Template prompt:</label>
                                                            <v-select class="vue-select-imput" v-model="selectedTemplatePrompt" :options="template_prompts" label="name" @input="updateTemplatePrompt"></v-select>
                                                            <textarea v-model="templatePromptText" class="form-control mt-2" rows="5" readonly></textarea>
                                                        </div>
                                                    </div>
                                                    <div class="d-flex justify-content-between" :class="{ 'mb-3': !ai_aggregated_data_switch }">
                                                        <div class="d-flex flex-direction-column">
                                                            <label class="form-check-label" for="ai_aggregated_data_switch">AI aggregated data analysis</label>
                                                            <label class="text-description">Clarify if there's a need to conduct an analysis of the aggregated data.</label>
                                                        </div>
                                                        <div class="form-check form-switch">
                                                            <input v-model="ai_aggregated_data_switch" class="form-check-input" id="ai_aggregated_data_switch" type="checkbox" :disabled="!ai_switch" :class="{ 'disabled-checkbox': !ai_switch }" checked="">
                                                        </div>
                                                    </div>
                                                    <div v-if="ai_aggregated_data_switch" class="mt-3">
                                                        <label>Aggregated data prompt:</label>
                                                        <v-select class="vue-select-imput" v-model="selectedAggregatedDataPrompt" :options="aggregated_data_prompts" label="name" @input="updateAggregatedDataPrompt"></v-select>
                                                        <textarea v-model="aggregatedPromptText" class="form-control mt-3" rows="5" readonly></textarea>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Center column: Template Editor (60%) -->
                            <div class="col-12 col-xl-55p pr-1">
                                <div class="mb-3">
                                    <label for="template-name" class="mb-2">Template name
                                        <span class="tooltip-container">
                                            <a href="https://perforge.app/docs/configuration/templates" target="_blank">
                                                <span class="fa-regular fa-circle-question me-2 mt-2"></span>
                                            </a>
                                            <span class="tooltip-content" style="font-size: 20px;">
                                                Click to learn more
                                            </span>
                                        </span>
                                    </label>
                                    <div class="d-flex align-items-center">
                                        <input v-model="name" id="template-name" class="form-control" type="text" required>
                                        <button class="btn btn-primary ms-2" type="button" @click.prevent="submitForm">Save</button>
                                    </div>
                                </div>
                                <h4 class="mb-2">Report title</h4>
                                <input v-model="title" id="template-title" class="form-control mb-3" type="text" placeholder="Write title here..." required>
                                <h4 class="mb-2">Report template</h4>
                                <div class="sortable-container">
                                    <div v-for="(element, index) in template" :key="element.id" class="template-item" :data-index="index">
                                        <div v-if="element.type === 'text'" class="template-group">
                                            <div class="drag-handle"><i class="fas fa-grip-lines"></i></div>
                                            <textarea v-model="element.content" required></textarea>
                                            <button class='btn-close-id btn-close ms-2' @click="removeElement(element)" type="button"></button>
                                        </div>
                                        <div v-else-if="element.type === 'graph'" class="template-group">
                                            <div class="drag-handle"><i class="fas fa-grip-lines"></i></div>
                                            <div class="graph-header mt-2 ps-2">
                                                <div class="graph-meta">
                                                    <span class="badge badge-primary">GRAPH</span>
                                                    <span class="badge badge-success ms-2" v-if="getGraphTypeById(element.graph_id)">${ getGraphTypeById(element.graph_id) }</span>
                                                    <div class="template-el-label graph-name" :title="getGraphNameById(element.graph_id) || 'Graph not found'">
                                                        <span class="graph-name-label">Name:</span>
                                                        <span class="graph-name-value">${ getGraphNameById(element.graph_id) || 'Graph not found' }</span>
                                                    </div>
                                                </div>
                                                <div class="graph-toggles">
                                                    <div class="toggle-item">
                                                        <div class="form-check form-switch min-h-auto mb-0">
                                                            <input v-model="element.ai_graph_switch" class="form-check-input" :id="'ai_graph_switch_' + element.id" type="checkbox" :disabled="!ai_switch || !graphHasPrompt(element.graph_id)" :class="{ 'disabled-checkbox': !ai_switch || !graphHasPrompt(element.graph_id) }" :title="!graphHasPrompt(element.graph_id) ? 'Disabled: no prompt assigned to this graph' : ''" @change="if (!$event.target.checked) element.ai_to_graphs_switch = false">
                                                            <label class="form-check-label ms-1" :for="'ai_graph_switch_' + element.id">AI analysis for this graph</label>
                                                        </div>
                                                        <div class="form-check form-switch min-h-auto mb-0">
                                                            <input v-model="element.ai_to_graphs_switch" class="form-check-input" :id="'ai_to_graphs_switch_' + element.id" type="checkbox" :disabled="!ai_switch || !element.ai_graph_switch || !graphHasPrompt(element.graph_id)" :class="{ 'disabled-checkbox': !ai_switch || !element.ai_graph_switch || !graphHasPrompt(element.graph_id) }" :title="!graphHasPrompt(element.graph_id) ? 'Disabled: no prompt assigned to this graph' : ''">
                                                            <label class="form-check-label ms-1" :for="'ai_to_graphs_switch_' + element.id">Add AI summary under the graph</label>
                                                        </div>
                                                        <div v-if="!graphHasPrompt(element.graph_id)" class="form-text text-danger small mt-1 ai-disabled-caption">
                                                            Disabled: assign a prompt to this graph to enable AI.
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="flex-end">
                                                <button class='btn-close-id btn-close' @click="removeElement(element)" type="button"></button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <button class="btn btn-primary" @click="addTextElement" type="button">Add Text</button>
                                <button class="btn btn-success ms-2" @click="showGraphsModal = true" type="button">Add Graphs</button>
                                <!-- Switches moved to left column -->
                            </div>
                            <div class="col-12 col-xl-22p">
                                <div class="row g-2">
                                    <div class="col-12">
                                        <div class="card">
                                            <div class="card-body">
                                                <div class="variables-container">
                                                    <label>Available variables:</label>

                                                    <div class="variables-section  mt-2">
                                                        <h6>Common variables:</h6>
                                                        <div v-for="variable in commonVariables" :key="variable.name" class="variable-item">
                                                            <label class="var-name" @click="copyToClipboard(variable.name)"><i class="fas fa-copy copy-icon" title="Copy" aria-label="Copy variable name" @click.stop="copyToClipboard(variable.name)"></i> ${ variable.name }</label>
                                                            <label class="var-description">${ variable.description }</label>
                                                        </div>
                                                    </div>

                                                    <div class="variables-section mt-2">
                                                        <h6>Summary variables:</h6>
                                                        <div v-for="variable in summaryVariables" :key="variable.name" class="variable-item">
                                                            <label class="var-name" @click="copyToClipboard(variable.name)"><i class="fas fa-copy copy-icon" title="Copy" aria-label="Copy variable name" @click.stop="copyToClipboard(variable.name)"></i> ${ variable.name }</label>
                                                            <label class="var-description">${ variable.description }</label>
                                                        </div>
                                                    </div>

                                                    <div class="variables-section mt-2">
                                                        <div class="d-flex justify-content-between align-items-center">
                                                            <h6 class="mb-0">Backend variables:</h6>
                                                            <i class="fas" :class="showBackendVariables ? 'fa-chevron-up' : 'fa-chevron-down'" @click="showBackendVariables = !showBackendVariables" style="cursor: pointer;"></i>
                                                        </div>
                                                        <div v-show="showBackendVariables">
                                                            <div v-for="variable in backendVariables" :key="variable.name" class="variable-item">
                                                                <label class="var-name" @click="copyToClipboard(variable.name)"><i class="fas fa-copy copy-icon" title="Copy" aria-label="Copy variable name" @click.stop="copyToClipboard(variable.name)"></i> ${ variable.name }</label>
                                                                <label class="var-description">${ variable.description }</label>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <!-- Merged Test Tables into Available variables -->
                                                    <div class="variables-section mt-2">
                                                        <div class="d-flex justify-content-between align-items-center">
                                                            <h6 class="mb-0">Frontend variables:</h6>
                                                            <i class="fas" :class="showTables ? 'fa-chevron-up' : 'fa-chevron-down'" @click="showTables = !showTables" style="cursor: pointer;"></i>
                                                        </div>
                                                        <div v-show="showTables">
                                                            <div class="text-description mt-2">Tables can be used in templates to display test metrics data. Always specify the aggregation type: median, mean, p90, p95, or p99. Please ensure that the desired aggregation type is available in InfluxDB</div>
                                                            <div v-for="table in backendTables" :key="'b-' + table.name" class="variable-item">
                                                                <label class="var-name" @click="copyToClipboard(table.name)"><i class="fas fa-copy copy-icon" title="Copy" aria-label="Copy table name" @click.stop="copyToClipboard(table.name)"></i> ${ table.name }</label>
                                                                <label class="var-description">${ table.description }</label>
                                                            </div>
                                                            <div v-for="table in frontendTables" :key="'f-' + table.name" class="variable-item">
                                                                <label class="var-name" @click="copyToClipboard(table.name)"><i class="fas fa-copy copy-icon" title="Copy" aria-label="Copy table name" @click.stop="copyToClipboard(table.name)"></i> ${ table.name }</label>
                                                                <label class="var-description">${ table.description }</label>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                        <!-- Graphs picker modal -->
                        <div class="modal fade modal-centered" :class="{ show: showGraphsModal }" :style="{ display: showGraphsModal ? 'flex' : 'none' }" tabindex="-1" role="dialog" @click.self="showGraphsModal=false">
                            <div class="modal-dialog modal-dialog-wide">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">Select a graph</h5>
                                        <button type="button" class="btn-close" @click="showGraphsModal=false"></button>
                                    </div>
                                    <div class="modal-body">
                                        <div v-if="graphs.length === 0" class="text-description">No graphs available.</div>
                                        <div v-else style="max-height: 60vh; overflow:auto;">
                                            <button v-for="graph in graphs" :key="graph.id" type="button" class="btn btn-secondary mb-2" style="width:100%; text-align: left;" @click.prevent.stop="addGraphElement(graph)">
                                                <span class="text-main">${ graph.name }</span>
                                                <span class="badge badge-success ms-2" v-if="graph.type">${ graph.type }</span>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button class="btn btn-secondary" type="button" @click="showGraphsModal=false">Cancel</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-backdrop fade" :class="{ show: showGraphsModal }" v-if="showGraphsModal"></div>
                    </div>
                    {% endraw %}
                </div>
                {% with msgs = get_flashed_messages() %}
                    {% include 'includes/flashed-msg.html' %}
                {% endwith %}
            </div>
        </div>
        <script src="//cdnjs.cloudflare.com/ajax/libs/vue/2.5.2/vue.min.js"></script>
        <!-- CDNJS :: Sortable (https://cdnjs.com/) -->
        <script src="//cdn.jsdelivr.net/npm/sortablejs@1.8.4/Sortable.min.js"></script>
        <!-- CDNJS :: Vue.Draggable (https://cdnjs.com/) -->
        <script src="https://cdn.jsdelivr.net/npm/vuedraggable@2.24.3/dist/vuedraggable.umd.min.js"></script>
        <script src="https://unpkg.com/vue-select@latest"></script>
        <link rel="stylesheet" href="https://unpkg.com/vue-select@latest/dist/vue-select.css">

        <script>
            document.addEventListener('DOMContentLoaded', function() {
                Vue.component('v-select', {
                extends: VueSelect.VueSelect,
                props: ['attrs'],
                });

                initVueApp();

                // Initialize Sortable after Vue is mounted
                setTimeout(() => {
                    const sortableContainer = document.querySelector('.sortable-container');
                    if (sortableContainer) {
                        new Sortable(sortableContainer, {
                            handle: '.drag-handle',
                            animation: 150,
                            onEnd: function(evt) {
                                // Access the Vue app instance
                                const app = document.querySelector('#app').__vue__;

                                // Get the old index
                                const oldIndex = evt.oldIndex;
                                // Get the new index
                                const newIndex = evt.newIndex;

                                // Create a new array with the reordered items
                                const newTemplate = [...app.template];
                                const movedItem = newTemplate.splice(oldIndex, 1)[0];
                                newTemplate.splice(newIndex, 0, movedItem);

                                // Update the template array with the new order
                                app.updateTemplateOrder(newTemplate);
                            },
                            onStart: function(evt) {
                                console.log('Drag started', evt);
                            },
                            onChange: function(evt) {
                                console.log('Order changed', evt);
                            }
                        });
                        console.log('Sortable initialized on', sortableContainer);
                    } else {
                        console.error('Sortable container not found');
                    }
                }, 1000);

                function initVueApp() {
                    const app = new Vue({
                    el: "#app",
                    delimiters: ['${', '}'],
                    data() {
                        return {
                            isLoading: true,
                            title: '',
                            name: '',
                            graphs: [],
                            nfrs: [],
                            nfr: '',
                            template: [],
                            template_prompts: [],
                            aggregated_data_prompts: [],
                            system_prompts: [],
                            template_prompt_id: '',
                            aggregated_prompt_id: '',
                            system_prompt_id: '',
                            ai_switch: false,
                            ai_aggregated_data_switch: false,
                            nfrs_switch: false,
                            ml_switch: false,
                            showBackendVariables: false,
                            showTables: false,
                            selectedTemplatePrompt: null,
                            selectedAggregatedDataPrompt: null,
                            selectedSystemPrompt: null,
                            idCounter: 1,
                            showGraphsModal: false,
                            commonVariables: [
                                { name: '${report_timestamp}', description: 'Timestamp when report was generated.' },
                                { name: '${current_test_title}', description: 'Name of the current test.' },
                                { name: '${current_duration}', description: 'Duration of the current test in seconds.' },
                                { name: '${current_start_time}', description: 'Start time of the current test.' },
                                { name: '${current_end_time}', description: 'End time of the current test.' },
                                { name: '${baseline_test_title}', description: 'Name of the baseline test.' },
                                { name: '${baseline_duration}', description: 'Duration of the baseline test in seconds.' },
                                { name: '${baseline_start_time}', description: 'Start time of the baseline test.' },
                                { name: '${baseline_end_time}', description: 'End time of the baseline test.' },
                            ],
                            backendVariables: [
                                { name: '${aggregated_data_table_}', description: 'Aggregated metrics table for backend tests. No aggregation type needed.' },
                                { name: '${current_max_active_users}', description: 'Max active users for the current test.' },
                                { name: '${current_errors_pct_stats}', description: 'Error percentage for the current test.' },
                                { name: '${current_median_response_time_stats}', description: 'Median response time for the current test.' },
                                { name: '${current_median_throughput}', description: 'Median throughput for the current test.' },
                                { name: '${current_pct90_response_time_stats}', description: '90th percentile response time for the current test.' },
                                { name: '${current_grafana_link}', description: 'Grafana link for the current test.' },
                                { name: '${baseline_max_active_users}', description: 'Max active users for the baseline test.' },
                                { name: '${baseline_errors_pct_stats}', description: 'Error percentage for the baseline test.' },
                                { name: '${baseline_median_response_time_stats}', description: 'Median response time for the baseline test.' },
                                { name: '${baseline_median_throughput}', description: 'Median throughput for the baseline test.' },
                                { name: '${baseline_pct90_response_time_stats}', description: '90th percentile response time for the baseline test.' },
                                { name: '${baseline_grafana_link}', description: 'Grafana link for the baseline test.' },
                            ],
                            backendTables: [],
                            frontendTables: [
                                { name: '${google_web_vitals_table_median}', description: 'Web Vitals metrics (LCP, CLS, FID) with median aggregation.' },
                                { name: '${timings_fully_loaded_table_median}', description: 'Page fully loaded timings with median aggregation.' },
                                { name: '${timings_page_timings_table_median}', description: 'Page timings metrics with median aggregation.' },
                                { name: '${timings_main_document_table_median}', description: 'Main document load timings with median aggregation.' },
                                { name: '${cpu_long_tasks_table_median}', description: 'CPU long tasks metrics with median aggregation.' },
                                { name: '${cdp_performance_js_heap_used_size_table_median}', description: 'JavaScript heap used size metrics with median aggregation.' },
                                { name: '${cdp_performance_js_heap_total_size_table_median}', description: 'JavaScript heap total size metrics with median aggregation.' },
                                { name: '${count_per_content_type_table_}', description: 'Content types metrics with median aggregation.' },
                                { name: '${first_party_transfer_size_table_}', description: 'First-party content types metrics with median aggregation.' },
                                { name: '${third_party_transfer_size_table_}', description: 'Third-party content types metrics with median aggregation.' }
                            ],
                            summaryVariables: [
                                { name: '${ml_summary}', description: 'Summary of ML-based anomaly detection.' },
                                { name: '${nfr_summary}', description: 'Summary of NFRs validation.' },
                                { name: '${ai_summary}', description: 'Summary generated by AI based on test results.' },
                            ]
                        };
                    },
                    mounted() {
                        const self = this;

                        // Find the highest ID to initialize the counter properly
                        if (this.template && this.template.length > 0) {
                            let maxId = 0;
                            this.template.forEach(item => {
                                if (item.id && item.id > maxId) {
                                    maxId = item.id;
                                }
                            });
                            this.idCounter = maxId;
                        }

                        // Ensure all template items have unique IDs and content field
                        if (this.template && this.template.length > 0) {
                            this.template.forEach((item, index) => {
                                if (!item.id) {
                                    this.idCounter++;
                                    item.id = this.idCounter;
                                }
                                if (!item.hasOwnProperty('content')) {
                                    item.content = '';
                                }
                            });
                        }

                        // If template is empty, add a default text element
                        if (this.template.length === 0) {
                            this.addTextElement();
                        }
                    },
                    computed: {
                        templatePromptText() {
                            return this.selectedTemplatePrompt ? this.selectedTemplatePrompt.prompt : '';
                        },
                        aggregatedPromptText() {
                            return this.selectedAggregatedDataPrompt ? this.selectedAggregatedDataPrompt.prompt : '';
                        },
                        systemPromptText() {
                        return this.selectedSystemPrompt ? this.selectedSystemPrompt.prompt : '';
                        }
                    },
                    methods: {
                        copyToClipboard(text) {
                            navigator.clipboard.writeText(text).then(() => {
                                showFlashMessage(`Copied '${text}' to clipboard`, 'success');
                            }, (err) => {
                                showFlashMessage('Failed to copy text', 'error');
                                console.error('Could not copy text: ', err);
                            });
                        },
                        addTextElement() {
                            this.idCounter++; // Increment the counter
                            this.template.push({
                                graph_id: null,
                                type: 'text',
                                content: '',
                                id: this.idCounter
                            });
                        },
                        addGraphElement(graph) {
                            this.idCounter++; // Increment the counter
                            this.template.push({
                                graph_id: graph.id,
                                type: 'graph',
                                content: '', // Add default empty content for graph elements
                                ai_graph_switch: false,
                                ai_to_graphs_switch: false,
                                id: this.idCounter
                            });
                            // Close the modal after selecting a graph
                            this.showGraphsModal = false;
                        },
                        removeElement(element) {
                            this.template = this.template.filter(el => el !== element);
                        },
                        updateTemplateOrder(newOrder) {
                            // This method is called from the Sortable onEnd handler
                            console.log("Updating template order to:", newOrder);

                            // Ensure all items have the required content field
                            newOrder.forEach(item => {
                                if (!item.hasOwnProperty('content')) {
                                    item.content = '';
                                }
                            });

                            this.template = newOrder;
                        },
                        submitForm() {
                            console.log("submitForm called");
                            // Validate required fields manually
                            if (!this.title) {
                                console.error("Title is required");
                                showFlashMessage("Title is required", "error");
                                return;
                            }

                            if (!this.name) {
                                console.error("Template name is required");
                                showFlashMessage("Template name is required", "error");
                                return;
                            }

                            // Check if template has content
                            if (this.template.length === 0) {
                                console.error("Template must have at least one element");
                                showFlashMessage("Template must have at least one element", "error");
                                return;
                            }

                            // Process template data
                            let plainTemplate = JSON.parse(JSON.stringify(this.template));
                            console.log("Template before processing:", this.template);
                            console.log("Plain template after JSON conversion:", plainTemplate);

                            for (const item of plainTemplate) {
                                // Remove client-side IDs to let the server generate proper IDs
                                delete item.id;

                                // Ensure all items have a content field
                                if (!item.hasOwnProperty('content')) {
                                    item.content = '';
                                }

                                if (item.type === 'text') {
                                    if (!item.content) {
                                        console.error("Text content is required");
                                        showFlashMessage("Text content is required", "error");
                                        return;
                                    }
                                }
                            }
                            console.log("Template after processing:", plainTemplate);

                            const results = {
                                "id": '{{ "" if template_config is none or template_config == "None" else template_config }}',
                                "name": this.name,
                                "nfr": this.nfr && this.nfr.id ? this.nfr.id : null,
                                "title": this.title,
                                "ai_switch": this.ai_switch,
                                ai_aggregated_data_switch: this.ai_aggregated_data_switch,
                                "nfrs_switch": this.nfrs_switch,
                                "ml_switch": this.ml_switch,
                                "template_prompt_id": this.template_prompt_id || null,
                                "aggregated_prompt_id": this.aggregated_prompt_id || null,
                                "system_prompt_id": this.system_prompt_id || null,
                                "data": plainTemplate
                            }

                            console.log("Creating template with data:", results);

                            // Use API client instead of direct POST
                            const templateId = results.id;
                            if (templateId && templateId !== 'None') {
                                // Update existing template
                                apiClient.templates.update(templateId, results)
                                    .then(response => {
                                        console.log("Template updated successfully:", response);
                                        showFlashMessage("Template updated successfully", "success");
                                        window.location.href = "/templates";
                                    })
                                    .catch(error => {
                                        console.error("Error updating template:", error);
                                        showFlashMessage(error.message || "Error updating template", "error");
                                    });
                            } else {
                                // Create new template
                                apiClient.templates.create(results)
                                    .then(response => {
                                        console.log("Template created successfully:", response);
                                        showFlashMessage("Template created successfully", "success");
                                        window.location.href = "/templates";
                                    })
                                    .catch(error => {
                                        console.error("Error creating template:", error);
                                        showFlashMessage(error.message || "Error creating template", "error");
                                    });
                            }
                        },
                        updateTemplatePrompt(selectedOption) {
                            this.template_prompt_id = selectedOption.id;
                            this.selectedTemplatePrompt = selectedOption; // Ensure the selected option is updated
                        },
                        updateAggregatedDataPrompt(selectedOption) {
                            this.aggregated_prompt_id = selectedOption.id;
                            this.selectedAggregatedDataPrompt = selectedOption; // Ensure the selected option is updated
                        },
                        updateSystemPrompt(selectedOption) {
                        this.system_prompt_id = selectedOption.id;
                        this.selectedSystemPrompt = selectedOption; // Ensure the selected option is updated
                        },
                        getGraphNameById(graph_id) {
                            const graph = this.graphs.find(graph => graph.id === graph_id);
                            return graph ? graph.name : '';
                        },
                        getGraphTypeById(graph_id) {
                            const graph = this.graphs.find(graph => graph.id === graph_id);
                            return graph ? graph.type : '';
                        },
                        getGraphById(graph_id) {
                            const graph = this.graphs.find(graph => graph.id === graph_id);
                            return graph || null;
                        },
                        graphHasPrompt(graph_id) {
                            const graph = this.getGraphById(graph_id);
                            return !!(graph && graph.prompt_id);
                        }
                    },
                    watch: {
                        ai_switch(newValue) {
                            if (!newValue) {
                                this.ai_aggregated_data_switch = false;
                                // Turn off all per-graph flags when AI is disabled
                                if (Array.isArray(this.template)) {
                                    this.template.forEach(item => {
                                        if (item && item.type === 'graph') {
                                            item.ai_graph_switch = false;
                                            item.ai_to_graphs_switch = false;
                                        }
                                    });
                                }
                            }
                        },
                        showGraphsModal(newValue) {
                            if (newValue) {
                                document.body.classList.add('modal-open');
                                this._escHandler = (e) => {
                                    if (e.key === 'Escape') {
                                        this.showGraphsModal = false;
                                    }
                                };
                                window.addEventListener('keydown', this._escHandler);
                                this.$nextTick(() => {
                                    const firstBtn = document.querySelector('.modal .modal-body button');
                                    if (firstBtn) firstBtn.focus();
                                });
                            } else {
                                document.body.classList.remove('modal-open');
                                if (this._escHandler) {
                                    window.removeEventListener('keydown', this._escHandler);
                                    this._escHandler = null;
                                }
                            }
                        }
                    },
                    created() {
                        function addTypeToName(prompts) {
                            prompts.forEach(prompt => { prompt.name = `${prompt.name} (${prompt.type})`; });
                            return prompts;
                        }

                        // Load data using API client
                        this.isLoading = true;
                        Promise.all([
                            apiClient.graphs.getAll(),
                            apiClient.nfrs.getAll(),
                            apiClient.prompts.getAll({ place: 'template' }),
                            apiClient.prompts.getAll({ place: 'aggregated_data' }),
                            apiClient.prompts.getAll({ place: 'system' })
                        ])
                        .then(([graphsResponse, nfrsResponse, templatePromptsResponse, aggregatedDataPromptsResponse, systemPromptsResponse]) => {
                            this.graphs = graphsResponse.data.graphs || [];
                            this.nfrs = nfrsResponse.data.nfrs || [];

                            // Process prompts
                            this.template_prompts = addTypeToName(templatePromptsResponse.data.prompts || []);
                            this.aggregated_data_prompts = addTypeToName(aggregatedDataPromptsResponse.data.prompts || []);
                            this.system_prompts = addTypeToName(systemPromptsResponse.data.prompts || []);

                            // Check for clone parameter first
                            const cloneTemplateId = new URLSearchParams(window.location.search).get('clone');
                            const templateId = cloneTemplateId || '{{ template_config }}';

                            if (templateId && templateId !== 'None') {
                                apiClient.templates.getById(templateId)
                                    .then(response => {
                                        const templateData = response.data.template;
                                        if (templateData && templateData.name != null) {
                                            this.title = templateData.title;
                                            // If this is a clone operation, append COPY to the name
                                            this.name = cloneTemplateId ? `${templateData.name} COPY` : templateData.name;
                                            this.nfr = this.nfrs.find(nfr => nfr.id === templateData.nfr) || "";
                                             if (!this.nfr && this.nfrs.length) {
                                                 this.nfr = this.nfrs[0];
                                             }
                                            this.template = templateData.data;
                                            // Ensure graph items have AI flags for proper binding
                                            if (Array.isArray(this.template)) {
                                                this.template.forEach(item => {
                                                    if (item && item.type === 'graph') {
                                                        if (!Object.prototype.hasOwnProperty.call(item, 'ai_graph_switch')) item.ai_graph_switch = false;
                                                        if (!Object.prototype.hasOwnProperty.call(item, 'ai_to_graphs_switch')) item.ai_to_graphs_switch = false;
                                                    }
                                                });
                                            }
                                            this.template_prompt_id = templateData.template_prompt_id;
                                            this.aggregated_prompt_id = templateData.aggregated_prompt_id;
                                            this.system_prompt_id = templateData.system_prompt_id;
                                            this.ai_switch = templateData.ai_switch;
                                            this.ai_aggregated_data_switch = templateData.ai_aggregated_data_switch;
                                            this.nfrs_switch = templateData.nfrs_switch;
                                            this.ml_switch = templateData.ml_switch;

                                            // Normalize AI flags on load for backward compatibility and dependency enforcement
                                            if (Array.isArray(this.template)) {
                                                // Enforce per-graph dependency: if ai_graph_switch is OFF, ai_to_graphs_switch must be OFF
                                                this.template.forEach(item => {
                                                    if (item && item.type === 'graph' && !item.ai_graph_switch) {
                                                        item.ai_to_graphs_switch = false;
                                                    }
                                                });
                                                // If global AI is disabled, turn off all per-graph AI flags
                                                if (!this.ai_switch) {
                                                    this.template.forEach(item => {
                                                        if (item && item.type === 'graph') {
                                                            item.ai_graph_switch = false;
                                                            item.ai_to_graphs_switch = false;
                                                        }
                                                    });
                                                }
                                                // Ensure graphs without prompts cannot have AI toggles ON
                                                this.template.forEach(item => {
                                                    if (item && item.type === 'graph') {
                                                        const g = this.graphs.find(g => g.id === item.graph_id);
                                                        if (!g || !g.prompt_id) {
                                                            item.ai_graph_switch = false;
                                                            item.ai_to_graphs_switch = false;
                                                        }
                                                    }
                                                });
                                            }

                                            // If cloning, clear the ID so a new template will be created on save
                                            if (cloneTemplateId) {
                                                this.template_id = null;
                                            } else {
                                                this.template_id = templateData.id;
                                            }

                                            // Set selected options after data is loaded
                                            if (this.template_prompts.length && this.aggregated_data_prompts.length && this.system_prompts.length) {
                                                this.selectedTemplatePrompt = this.template_prompts.find(prompt => prompt.id === this.template_prompt_id);
                                                if (!this.selectedTemplatePrompt && this.template_prompts.length) {
                                                    this.selectedTemplatePrompt = this.template_prompts[0];
                                                    this.template_prompt_id = this.selectedTemplatePrompt.id;
                                                }
                                                this.selectedAggregatedDataPrompt = this.aggregated_data_prompts.find(prompt => prompt.id === this.aggregated_prompt_id);
                                                if (!this.selectedAggregatedDataPrompt && this.aggregated_data_prompts.length) {
                                                    this.selectedAggregatedDataPrompt = this.aggregated_data_prompts[0];
                                                    this.aggregated_prompt_id = this.selectedAggregatedDataPrompt.id;
                                                }
                                                this.selectedSystemPrompt = this.system_prompts.find(prompt => prompt.id === this.system_prompt_id);
                                                if (!this.selectedSystemPrompt && this.system_prompts.length) {
                                                    this.selectedSystemPrompt = this.system_prompts[0];
                                                    this.system_prompt_id = this.selectedSystemPrompt.id;
                                                }
                                            }
                                        }
                                    })
                                    .catch(error => {
                                        showFlashMessage(error.message || "Error loading template", "error");
                                        console.error("Error loading template:", error);
                                    })
                                    .finally(() => {
                                        this.isLoading = false;
                                    });
                            } else {
                                // If no template to load, add a default text element
                                if (this.template.length === 0) {
                                    this.addTextElement();
                                }

                                // Set default prompts if available
                                if (this.system_prompts.length > 0) {
                                    this.selectedSystemPrompt = this.system_prompts[0];
                                    this.system_prompt_id = this.system_prompts[0].id;
                                }
                                if (this.template_prompts.length > 0) {
                                    this.selectedTemplatePrompt = this.template_prompts[0];
                                    this.template_prompt_id = this.template_prompts[0].id;
                                }
                                if (this.aggregated_data_prompts.length > 0) {
                                    this.selectedAggregatedDataPrompt = this.aggregated_data_prompts[0];
                                    this.aggregated_prompt_id = this.aggregated_data_prompts[0].id;
                                }
                                // Set default NFR if available
                                if (this.nfrs.length > 0) {
                                    this.nfr = this.nfrs[0];
                                }

                                this.isLoading = false;
                            }
                        })
                        .catch(error => {
                            showFlashMessage(error.message || "Error loading initial data", "error");
                            console.error("Error loading initial data:", error);
                            this.isLoading = false;
                        });
                    },
                    beforeDestroy() {
                        // Clean up modal side-effects if needed
                        document.body.classList.remove('modal-open');
                        if (this._escHandler) {
                            window.removeEventListener('keydown', this._escHandler);
                            this._escHandler = null;
                        }
                    }
                });
                }
            });
        </script>
    </main>
{% endblock content %}
