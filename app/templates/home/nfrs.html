{% extends "layouts/base-fullscreen.html" %}
{% block title %} NFRs {% endblock %}
<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}
<link type="text/css" href="/static/assets/vendor/@fortawesome/fontawesome-free/css/all.min.css" rel="stylesheet">
<link type="text/css" href="/static/assets/css/main.css" rel="stylesheet">
{% endblock stylesheets %}
{% block content %}
    <main>
        <div class="main-background">
            {% include 'includes/sidebar.html' %}
            <div class="main-body">
              <div class="card mb-3 margin-all-10" data-component-card="data-component-card">
                <div class="card-body">
                    <div id="table-id">
                        <div class="d-flex align-items-center justify-content-end mb-3">
                            <div class="d-flex">
                                <div>
                                    <div class="search-box position-relative" data-bs-toggle="search" data-bs-display="static">
                                        <input class="form-control search-input search" type="search" placeholder="Search" aria-label="Search" />
                                        <span class="fas fa-search search-box-icon"></span>
                                    </div>
                                </div>
                                <a class="btn btn-primary ms-2" href="/nfr">New NFR</a>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table fs--1 mb-0">
                                <thead>
                                    <tr>
                                        <th class="sort" data-sort="name">Name</th>
                                        <th class="sort" data-sort="nfrs">NFRS</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="list" id="nfrs-table-body">
                                    <!-- NFR items will be loaded dynamically via API -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
              </div>
            </div>
        </div>
    </main>

    <!-- NFR Delete Modal Template -->
    <div class="modal fade" id="deleteNfrModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            Are you sure you want to delete this NFR?
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Confirm Delete</button>
          </div>
        </div>
      </div>
    </div>
    <div class="center-section">
        {% with msgs = get_flashed_messages() %}
        {% include 'includes/flashed-msg.html' %}
        {% endwith %}
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Load NFRs when the page loads
            loadNfrs();

            // Set up search functionality
            const searchInput = document.querySelector('.search-input');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase();
                    const rows = document.querySelectorAll('#nfrs-table-body tr');

                    rows.forEach(row => {
                        const name = row.querySelector('.name').textContent.toLowerCase();
                        const nfrs = row.querySelector('.nfrs').textContent.toLowerCase();

                        if (name.includes(searchTerm) || nfrs.includes(searchTerm)) {
                            row.style.display = '';
                        } else {
                            row.style.display = 'none';
                        }
                    });
                });
            }
        });

        // Function to load NFRs via API
        function loadNfrs() {
            apiClient.nfrs.getAll()
                .then(response => {
                    if (response.data && response.data.nfrs) {
                        renderNfrs(response.data.nfrs);
                    } else {
                        showFlashMessage('No NFRs found or error loading NFRs', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error loading NFRs:', error);
                    showFlashMessage(error.message || 'Error loading NFRs', 'error');
                });
        }

        // Function to render NFRs in the table
        function renderNfrs(nfrsList) {
            const tableBody = document.getElementById('nfrs-table-body');
            tableBody.innerHTML = '';

            if (nfrsList.length === 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = '<td colspan="3" class="text-center">No NFRs found</td>';
                tableBody.appendChild(emptyRow);
                return;
            }

            nfrsList.forEach(nfr => {
                const row = document.createElement('tr');

                // Name column
                const nameCell = document.createElement('td');
                nameCell.className = 'name';
                nameCell.textContent = nfr.name;
                row.appendChild(nameCell);

                // NFRs column
                const nfrsCell = document.createElement('td');
                nfrsCell.className = 'nfrs';

                if (nfr.rows && nfr.rows.length > 0) {
                    nfr.rows.forEach(nfrRow => {
                        const nfrDiv = document.createElement('div');
                        const scopeText = nfrRow.regex ? `regex(${nfrRow.scope})` : nfrRow.scope;
                        nfrDiv.textContent = `${nfrRow.metric} ${nfrRow.operation} ${nfrRow.threshold} for ${scopeText}`;
                        nfrsCell.appendChild(nfrDiv);
                    });
                }
                row.appendChild(nfrsCell);

                // Actions column
                const actionsCell = document.createElement('td');
                actionsCell.className = 'actions';
                actionsCell.style.width = '20%';

                const editButton = document.createElement('a');
                editButton.className = 'btn btn-secondary';
                editButton.href = `/nfr?nfr_config=${nfr.id}`;
                editButton.textContent = 'Edit';
                actionsCell.appendChild(editButton);

                const deleteButton = document.createElement('button');
                deleteButton.className = 'btn btn-danger ms-2';
                deleteButton.textContent = 'Delete';
                deleteButton.setAttribute('data-nfr-id', nfr.id);
                deleteButton.setAttribute('data-nfr-name', nfr.name);
                deleteButton.addEventListener('click', function() {
                    showDeleteModal(nfr.id, nfr.name);
                });
                actionsCell.appendChild(deleteButton);

                row.appendChild(actionsCell);

                tableBody.appendChild(row);
            });
        }

        // Function to show the delete confirmation modal
        function showDeleteModal(nfrId, nfrName) {
            const modal = new bootstrap.Modal(document.getElementById('deleteNfrModal'));
            const modalBody = document.querySelector('#deleteNfrModal .modal-body');
            modalBody.textContent = `Are you sure you want to delete the "${nfrName}" NFR?`;

            // Set up the confirm delete button
            const confirmBtn = document.getElementById('confirmDeleteBtn');
            confirmBtn.onclick = function() {
                deleteNfr(nfrId, modal);
            };

            modal.show();
        }

        // Function to delete an NFR
        function deleteNfr(nfrId, modal) {
            apiClient.nfrs.delete(nfrId)
                .then(response => {
                    modal.hide();
                    showFlashMessage('NFR deleted successfully', 'success');
                    loadNfrs(); // Reload the NFRs list
                })
                .catch(error => {
                    console.error('Error deleting NFR:', error);
                    modal.hide();
                    showFlashMessage(error.message || 'Error deleting NFR', 'error');
                });
        }
    </script>
{% endblock content %}
