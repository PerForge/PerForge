{% extends "layouts/base-fullscreen.html" %}
{% block title %} Graphs {% endblock %}
<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}
<link type="text/css" href="/static/assets/vendor/@fortawesome/fontawesome-free/css/all.min.css" rel="stylesheet">
<link type="text/css" href="/static/assets/css/main.css" rel="stylesheet">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
{% endblock stylesheets %}
{% block content %}
<main>
    <div class="main-background">
      {% include 'includes/sidebar.html' %}
      <div class="main-body">
        <div class="card mb-3 margin-all-10" data-component-card="data-component-card">
          <div class="card-body">
              <div id="table-id">
                  <div class="d-flex align-items-center justify-content-end mb-3">
                      <div class="d-flex">
                          <div>
                              <div class="search-box position-relative" data-bs-toggle="search" data-bs-display="static">
                                  <input class="form-control search-input search" type="search" placeholder="Search" aria-label="Search" />
                                  <span class="fas fa-search search-box-icon"></span>
                              </div>
                          </div>
                          <button class="btn btn-primary ms-2" type="button" data-bs-toggle="modal" data-bs-target="#graphModal" add-graph="add-graph">Add graph</button>
                      </div>
                  </div>
                  <div class="table-responsive">
                      <table class="table fs--1 mb-0">
                          <thead>
                              <tr>
                                  <th class="sort" data-sort="name">Name</th>
                                  <th class="sort" data-sort="grafana">Grafana</th>
                                  <th class="sort" data-sort="dash_id">Dashboard Id</th>
                                  <th class="sort" data-sort="view_panel">View Panel</th>
                                  <th class="sort" data-sort="height">Height</th>
                                  <th class="sort" data-sort="width">Width</th>
                                  <th class="sort" data-sort="prompt_id">Prompt</th>
                                  <th>Actions</th>
                              </tr>
                          </thead>
                          <tbody class="list">
                              {% for graph in graphs_list %}
                              <tr>
                                  <td class="name">{{ graph.name }}</td>
                                  <td class="grafana">
                                      {% for grafana in grafana_configs %}
                                          {% if grafana.id == graph.grafana_id %}
                                              {{ grafana.name }}
                                          {% endif %}
                                      {% endfor %}
                                  </td>
                                  <td class="dash_id">
                                      {% for grafana in grafana_configs %}
                                          {% for dashboard in grafana.dashboards %}
                                              {% if dashboard.id == graph.dash_id %}
                                                  {{ dashboard.content }}
                                              {% endif %}
                                          {% endfor %}
                                      {% endfor %}
                                  </td>
                                  <td class="view_panel">{{ graph.view_panel }}</td>
                                  <td class="height">{{ graph.height }}</td>
                                  <td class="width">{{ graph.width }}</td>
                                  <td class="prompt_id">
                                      {% for prompt in graph_prompts %}
                                          {% if prompt.id == graph.prompt_id %}
                                              {{ prompt.name }}
                                          {% endif %}
                                      {% endfor %}
                                  </td>
                                  <td class="actions">
                                      <button class="btn btn-primary" type="button" data-bs-toggle="modal" data-bs-target="#graphModal" data-graph='{{ graph | tojson | safe }}'>Edit</button>
                                      <button class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#graphModal" data-clone-graph='{{ graph | tojson | safe }}'>Clone</button>
                                      <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteModal{{ graph.id }}">Delete</button>
                                  </td>
                              </tr>
                              <div class="modal fade" id="deleteModal{{ graph.id }}" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
                                <div class="modal-dialog">
                                  <div class="modal-content">
                                    <div class="modal-header">
                                      <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
                                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                      Are you sure you want to delete the "{{ graph.name }}" graph?
                                    </div>
                                    <div class="modal-footer">
                                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                      <button type="button" class="btn btn-danger" onclick="deleteGraph('{{ graph.id }}')">Confirm Delete</button>
                                    </div>
                                  </div>
                                </div>
                              </div>
                              {% endfor %}
                          </tbody>
                      </table>
                  </div>
              </div>
          </div>
        </div>
        {% with msgs = get_flashed_messages() %}
            {% include 'includes/flashed-msg.html' %}
        {% endwith %}
        <div id="good-msg" style="display: none;" class="alert alert-success">
            <span id="msg"></span>
        </div>
        <div id="bad-msg" style="display: none;" class="alert alert-danger">
            <span id="msg"></span>
        </div>
      </div>
    </div>
    <div class="modal fade" id="graphModal" aria-hidden="true" style="display: none;">
      <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
                <h2 class="mb-0">Graphs
                    <div class="tooltip-container">
                      <a href="https://perforge.app/docs/configuration/graphs" target="_blank">
                          <span class="fa-regular fa-circle-question me-2 mt-2"></span>
                      </a>
                      <div class="tooltip-content" style="font-size: 16px;">
                          Click to learn more
                      </div>
                    </div>
                </h2>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <form id="graphForm">
                  <div class="mt-3">
                      <label>Name</label>
                      <input type="text" class="form-control" id="name" name="name">
                      <input type="hidden" id="graph_id" name="id">
                  </div>
                  <div class="mt-3">
                      <label>Grafana</label>
                      <select class="form-select" id="grafana_id" name="grafana_id">
                          {% for grafana in grafana_configs %}
                              <option value="{{ grafana.id }}">{{ grafana.name }}</option>
                          {% endfor %}
                      </select>
                  </div>
                  <div class="mt-3">
                      <label>Dashboard Id</label>
                      <select class="form-select" id="dash_id" name="dash_id">
                      </select>
                  </div>
                  <div class="mt-3">
                      <label>View panel</label>
                      <input type="text" class="form-control" id="view_panel" name="view_panel">
                  </div>
                  <div class="mt-3">
                      <label>Panel width</label>
                      <input type="text" class="form-control" id="width" name="width">
                  </div>
                  <div class="mt-3">
                      <label class="mt-3">Panel height</label>
                      <input type="text" class="form-control" id="height" name="height">
                  </div>
                  <div class="mt-3">
                      <label class="mt-3">Custom vars (optional)</label>
                      <div class="tooltip-container">
                          <span class="fa-regular fa-circle-question me-2 mt-2"></span>
                          <div class="tooltip-content">
                              You can add additional custom variables to draw graphs with these variables. For example, use the following format: &var-varname=varvalue
                          </div>
                      </div>
                      <input type="text" class="form-control" id="custom_vars" name="custom_vars">
                  </div>
                  <div class="mt-3">
                      <label>Prompt (optional)</label>
                      <select class="form-select" id="prompt_id" name="prompt_id">
                          <option value="" selected>Select a prompt</option>
                          {% for prompt in graph_prompts %}
                              <option value="{{ prompt.id }}" data-prompt="{{ prompt.prompt }}">{{ prompt.name }}</option>
                          {% endfor %}
                      </select>
                  </div>
                  <div class="mt-3">
                      <label>Prompt value</label>
                      <textarea class="form-control" id="prompt_value" rows="3" readonly></textarea>
                  </div>
              </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveGraphBtn">Save</button>
            </div>
          </div>
      </div>
    </div>
    <script>
      let listJsInstance;

      $(document).ready(function() {
          const options = {
              valueNames: ['name', 'grafana', 'dash_id', 'view_panel', 'height', 'width', 'prompt_id'],
              page: 15,
              pagination: true
          };

          setTimeout(() => {
              listJsInstance = new List('table-id', options);
          }, 0);

          // Set up search functionality
          const searchInput = document.querySelector('.search-input');
          if (searchInput) {
              searchInput.addEventListener('input', function() {
                  if (listJsInstance) {
                      listJsInstance.search(this.value);
                  }
              });
          }
          var grafanaConfigs = '{{ grafana_configs | tojson | safe }}';

          $('#grafana_id').change(function() {
              var selectedGrafanaId = $(this).val();
              var dashIdSelect = $('#dash_id');

              // Clear existing options
              dashIdSelect.empty();

              // Find the selected Grafana config
              var selectedGrafana = null;
              for (var i = 0; i < grafanaConfigs.length; i++) {
                  if (grafanaConfigs[i].id == selectedGrafanaId) {
                      selectedGrafana = grafanaConfigs[i];
                      break;
                  }
              }

              if (!selectedGrafana) {
                  return;
              }

              // Get dashboards for the selected Grafana
              var dashboards = selectedGrafana.dashboards || [];

              // Add options for each dashboard
              dashboards.forEach(function(dashboard) {
                  dashIdSelect.append('<option value="' + dashboard.id + '">' + dashboard.content + '</option>');
              });
          });

          $('#grafana_id').change();

          var modal = $('#graphModal');
          var form = modal.find('form');

          $('#graphModal').on('show.bs.modal', function(event) {
              var button = $(event.relatedTarget);
              var graphData = button.data('graph');
              var cloneData = button.data('clone-graph');
              var modal = $(this);

              // Reset form
              $('#graphForm')[0].reset();
              $('#graph_id').val('');
              $('#prompt_value').val('');

              if (cloneData) {
                  // Cloning an existing graph
                  modal.find('.modal-title').text('Clone Graph');
                  $('#name').val(cloneData.name + ' COPY');
                  $('#grafana_id').val(cloneData.grafana_id).change();

                  setTimeout(function() {
                      $('#dash_id').val(cloneData.dash_id);
                  }, 100);

                  $('#view_panel').val(cloneData.view_panel);
                  $('#width').val(cloneData.width);
                  $('#height').val(cloneData.height);
                  $('#custom_vars').val(cloneData.custom_vars);
                  $('#prompt_id').val(cloneData.prompt_id || '').change();
              } else if (graphData) {
                  // Editing an existing graph
                  modal.find('.modal-title').text('Edit Graph');
                  $('#graph_id').val(graphData.id);
                  $('#name').val(graphData.name);
                  $('#grafana_id').val(graphData.grafana_id).change();

                  setTimeout(function() {
                      $('#dash_id').val(graphData.dash_id);
                  }, 100);

                  $('#view_panel').val(graphData.view_panel);
                  $('#width').val(graphData.width);
                  $('#height').val(graphData.height);
                  $('#custom_vars').val(graphData.custom_vars);
                  $('#prompt_id').val(graphData.prompt_id || '').change();
              } else {
                  // Adding a new graph
                  modal.find('.modal-title').text('Add Graph');
              }
          });

          // Update the prompt value textarea when a prompt is selected
          $('#prompt_id').change(function() {
            var selectedPrompt = $(this).find('option:selected').data('prompt');
            $('#prompt_value').val(selectedPrompt || '');
          });

          // Handle save button click
          $('#saveGraphBtn').click(function() {
              // Collect form data
              var graphData = {
                  id: $('#graph_id').val() || null,
                  name: $('#name').val(),
                  grafana_id: $('#grafana_id').val(),
                  dash_id: $('#dash_id').val(),
                  view_panel: $('#view_panel').val(),
                  width: $('#width').val(),
                  height: $('#height').val(),
                  custom_vars: $('#custom_vars').val(),
                  prompt_id: $('#prompt_id').val() || null
              };

              // Determine if we're creating or updating
              if (graphData.id) {
                  // Update existing graph
                  apiClient.graphs.update(graphData.id, graphData)
                      .then(function(response) {
                          // Close modal and show success message
                          $('#graphModal').modal('hide');
                          showFlashMessage('Graph updated successfully', 'success');
                          setTimeout(function() {
                              window.location.reload();
                          }, 1000);
                      })
                      .catch(function(error) {
                          console.error('Error updating graph:', error);
                          showFlashMessage('Error updating graph: ' + (error.message || 'Unknown error'), 'error');
                      });
              } else {
                  // Create new graph
                  apiClient.graphs.create(graphData)
                      .then(function(response) {
                          // Close modal and show success message
                          $('#graphModal').modal('hide');
                          showFlashMessage('Graph created successfully', 'success');
                          setTimeout(function() {
                              window.location.reload();
                          }, 1000);
                      })
                      .catch(function(error) {
                          console.error('Error creating graph:', error);
                          showFlashMessage('Error creating graph: ' + (error.message || 'Unknown error'), 'error');
                      });
              }
          });
      });

      // Function to delete a graph
      function deleteGraph(graphId) {
          apiClient.graphs.delete(graphId)
              .then(function(response) {
                  // Close modal and show success message
                  $(`#deleteModal${graphId}`).modal('hide');
                  showFlashMessage('Graph deleted successfully', 'success');
                  setTimeout(function() {
                      window.location.reload();
                  }, 1000);
              })
              .catch(function(error) {
                  console.error('Error deleting graph:', error);
                  showFlashMessage('Error deleting graph: ' + (error.message || 'Unknown error'), 'error');
              });
      }
    </script>
  </main>
{% endblock content %}
