{% extends "layouts/base-fullscreen.html" %}
{% block title %} Prompts {% endblock %}
<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}
<link type="text/css" href="/static/assets/vendor/@fortawesome/fontawesome-free/css/all.min.css" rel="stylesheet">
<link type="text/css" href="/static/assets/css/main.css" rel="stylesheet">
{% endblock stylesheets %}
{% block content %}
<main>
    <div class="main-background">
      {% include 'includes/sidebar.html' %}
      <div class="main-body">
        <div class="card mb-3 margin-all-10" data-component-card="data-component-card">
          <div class="card-body">
              <div id="table-id">
                  <div class="d-flex align-items-center justify-content-end mb-3">
                          <label class="me-2" for="selectedTypeSwitch">Default</label>
                          <div class="form-check form-switch">
                              <input class="form-check-input" type="checkbox" id="selectedTypeSwitch" unchecked>
                          </div>
                          <label class="me-2" for="selectedTypeSwitch">Custom prompts</label>
                          <div>
                              <div class="search-box position-relative" data-bs-toggle="search" data-bs-display="static">
                                  <input class="form-control search-input search" type="search" placeholder="Search" aria-label="Search" />
                                  <span class="fas fa-search search-box-icon"></span>
                              </div>
                          </div>
                          <button class="btn btn-primary ms-2" type="button" data-bs-toggle="modal" data-bs-target="#promptModal" add-prompt="add-prompt">Add custom prompt</button>
                  </div>
                  <div class="table-responsive">
                      <table class="table fs--1 mb-0">
                          <thead>
                              <tr>
                                  <th class="sort" data-sort="name">Name</th>
                                  <th class="sort" data-sort="prompt">Prompt</th>
                                  <th class="sort" data-sort="place">Place</th>
                                  <th class="sort" data-sort="type">Type</th>
                                  <th class="sort" data-sort="project_id">Scope</th>
                                  <th>Actions</th>
                              </tr>
                          </thead>
                          <tbody class="list" id="prompts-table-body">
                            <!-- Prompts will be loaded dynamically via API -->
                          </tbody>
                      </table>
                  </div>
              </div>
          </div>
        </div>
      </div>
      <div class="center-section">
        {% with msgs = get_flashed_messages() %}
        {% include 'includes/flashed-msg.html' %}
        {% endwith %}
      </div>
    </div>
    <div class="modal fade" id="promptModal" aria-hidden="true" style="display: none;">
      <div class="modal-dialog">
          <div class="modal-content">
            <form id="promptForm">
              <input type="hidden" name="id" id="prompt_id">
              <input type="hidden" name="type" id="prompt_type" value="custom">
              <div class="modal-header">
                <h2 class="modal-title" id="addnewpromptLabel">Add prompt</h2>
              </div>
              <div class="modal-body">
                <div class="mt-3">
                  <label>Name</label>
                  <input type="text" class="form-control" id="name" name="name" required>
                </div>
                <div class="mt-3">
                  <label>Place</label>
                  <select class="form-select" id="place" name="place" required>
                    <option value="graph">Graph</option>
                    <option value="template">Template</option>
                    <option value="aggregated_data">Aggregated Data</option>
                    <option value="template_group">Template Group</option>
                    <option value="system">System</option>
                  </select>
                </div>
                <div class="mt-3">
                  <label>Prompt</label>
                  <textarea class="form-control" id="prompt" name="prompt" rows="6" required></textarea>
                </div>
                <div class="mt-3">
                  <label>Scope</label>
                  <select class="form-select" id="project_id" name="project_id">
                    <option value="">All projects</option>
                    <option value="project">Current project</option>
                  </select>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="submit" class="btn btn-primary">Save</button>
              </div>
            </form>
          </div>
      </div>
    </div>

    <!-- View Prompt Modal -->
    <div class="modal fade" id="viewPromptModal" aria-hidden="true" style="display: none;">
      <div class="modal-dialog">
          <div class="modal-content">
              <div class="modal-header">
                <h2 class="modal-title">View Prompt</h2>
              </div>
              <div class="modal-body">
                <div class="mt-3">
                  <label>Name</label>
                  <input type="text" class="form-control" id="view_name" readonly>
                </div>
                <div class="mt-3">
                  <label>Place</label>
                  <input type="text" class="form-control" id="view_place" readonly>
                </div>
                <div class="mt-3">
                  <label>Prompt</label>
                  <textarea class="form-control" id="view_prompt" rows="6" readonly></textarea>
                </div>
                <div class="mt-3">
                  <label>Scope</label>
                  <input type="text" class="form-control" id="view_scope" readonly>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              </div>
          </div>
      </div>
    </div>

    <!-- Delete Prompt Modal -->
    <div class="modal fade" id="deletePromptModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            Are you sure you want to delete this prompt?
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Confirm Delete</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // Load prompts when the page loads
        loadPrompts();

        // Set up search functionality
        const searchInput = document.querySelector('.search-input');
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const rows = document.querySelectorAll('#prompts-table-body tr');

                rows.forEach(row => {
                    const name = row.querySelector('.name').textContent.toLowerCase();
                    const promptText = row.querySelector('.prompt').textContent.toLowerCase();
                    const place = row.querySelector('.place').textContent.toLowerCase();

                    if (name.includes(searchTerm) || promptText.includes(searchTerm) || place.includes(searchTerm)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            });
        }

        // Handle form submission
        document.getElementById('promptForm').addEventListener('submit', function(event) {
            event.preventDefault();

            const promptData = {
                id: document.getElementById('prompt_id').value || null,
                name: document.getElementById('name').value,
                place: document.getElementById('place').value,
                prompt: document.getElementById('prompt').value,
                type: document.getElementById('prompt_type').value,
                project_id: document.getElementById('project_id').value === 'project' ? true : null
            };

            const promptId = promptData.id;

            // Use the API client to save the prompt
            const apiCall = promptId
                ? apiClient.prompts.update(promptId, promptData)
                : apiClient.prompts.create(promptData);

            apiCall
                .then(response => {
                    // Close the modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('promptModal'));
                    modal.hide();

                    // Show success message
                    const message = promptId ? "Prompt updated successfully." : "Prompt created successfully.";
                    showFlashMessage(message, "success");

                    // Reload prompts
                    loadPrompts();
                })
                .catch(error => {
                    console.error('Error:', error);
                    showFlashMessage(error.message || "An error occurred while saving the prompt.", "error");
                });
        });

        // Initialize the switcher based on the URL
        initializeSwitcher();
      });

      // Function to load prompts via API
      function loadPrompts() {
          apiClient.prompts.getAll()
              .then(response => {
                  if (response.data && response.data.prompts) {
                      // Split prompts into default and custom
                      const defaultPrompts = response.data.prompts.filter(p => p.type === 'default');
                      const customPrompts = response.data.prompts.filter(p => p.type === 'custom');

                      // Render based on the current filter
                      const showCustom = document.getElementById('selectedTypeSwitch').checked;
                      renderPrompts(showCustom ? customPrompts : defaultPrompts);
                  } else {
                      showFlashMessage('No prompts found or error loading prompts', 'error');
                  }
              })
              .catch(error => {
                  console.error('Error loading prompts:', error);
                  showFlashMessage(error.message || 'Error loading prompts', 'error');
              });
      }

      // Function to render prompts in the table
      function renderPrompts(promptsList) {
          const tableBody = document.getElementById('prompts-table-body');
          tableBody.innerHTML = '';

          if (promptsList.length === 0) {
              const emptyRow = document.createElement('tr');
              emptyRow.innerHTML = '<td colspan="6" class="text-center">No prompts found</td>';
              tableBody.appendChild(emptyRow);
              return;
          }

          promptsList.forEach(prompt => {
              const row = document.createElement('tr');
              row.className = prompt.type === 'default' ? 'default-prompt' : 'custom-prompt';

              // Name column
              const nameCell = document.createElement('td');
              nameCell.className = 'name';
              nameCell.textContent = prompt.name;
              row.appendChild(nameCell);

              // Prompt column
              const promptCell = document.createElement('td');
              promptCell.className = 'prompt';
              const promptDiv = document.createElement('div');
              promptDiv.style = 'display:block;width:40pc;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;';
              promptDiv.textContent = prompt.prompt;
              promptCell.appendChild(promptDiv);
              row.appendChild(promptCell);

              // Place column
              const placeCell = document.createElement('td');
              placeCell.className = 'place';
              const placeDiv = document.createElement('div');
              placeDiv.className = 'badge badge-primary';
              placeDiv.textContent = prompt.place;
              placeCell.appendChild(placeDiv);
              row.appendChild(placeCell);

              // Type column
              const typeCell = document.createElement('td');
              typeCell.className = 'type';
              const typeDiv = document.createElement('div');
              typeDiv.className = 'badge badge-success';
              typeDiv.textContent = prompt.type;
              typeCell.appendChild(typeDiv);
              row.appendChild(typeCell);

              // Project ID column
              const projectCell = document.createElement('td');
              projectCell.className = 'project_id';
              const projectDiv = document.createElement('div');
              projectDiv.className = 'badge badge-primary';
              projectDiv.textContent = prompt.project_id ? 'PROJECT' : 'ALL';
              projectCell.appendChild(projectDiv);
              row.appendChild(projectCell);

              // Actions column
              const actionsCell = document.createElement('td');
              actionsCell.className = 'actions';

              if (prompt.type === 'default') {
                  // Default prompts can only be viewed
                  const viewButton = document.createElement('button');
                  viewButton.className = 'btn btn-secondary';
                  viewButton.textContent = 'View';
                  viewButton.setAttribute('data-bs-toggle', 'modal');
                  viewButton.setAttribute('data-bs-target', '#viewPromptModal');
                  viewButton.addEventListener('click', function() {
                      showViewPromptModal(prompt);
                  });
                  actionsCell.appendChild(viewButton);
              } else {
                  // Custom prompts can be edited and deleted
                  const editButton = document.createElement('button');
                  editButton.className = 'btn btn-secondary';
                  editButton.textContent = 'Edit';
                  editButton.setAttribute('data-bs-toggle', 'modal');
                  editButton.setAttribute('data-bs-target', '#promptModal');
                  editButton.addEventListener('click', function() {
                      showEditPromptModal(prompt);
                  });
                  actionsCell.appendChild(editButton);

                  const deleteButton = document.createElement('button');
                  deleteButton.className = 'btn btn-danger ms-2';
                  deleteButton.textContent = 'Delete';
                  deleteButton.addEventListener('click', function() {
                      showDeletePromptModal(prompt.id, prompt.name);
                  });
                  actionsCell.appendChild(deleteButton);
              }

              row.appendChild(actionsCell);
              tableBody.appendChild(row);
          });
      }

      // Function to show the view prompt modal
      function showViewPromptModal(prompt) {
          document.getElementById('view_name').value = prompt.name;
          document.getElementById('view_place').value = prompt.place;
          document.getElementById('view_prompt').value = prompt.prompt;
          document.getElementById('view_scope').value = prompt.project_id ? 'PROJECT' : 'ALL';
      }

      // Function to show the edit prompt modal
      function showEditPromptModal(prompt) {
          document.getElementById('prompt_id').value = prompt.id;
          document.getElementById('name').value = prompt.name;
          document.getElementById('place').value = prompt.place;
          document.getElementById('prompt').value = prompt.prompt;
          document.getElementById('prompt_type').value = prompt.type;
          document.getElementById('project_id').value = prompt.project_id ? 'project' : '';

          // Update modal title
          document.getElementById('addnewpromptLabel').textContent = 'Edit Prompt';
      }

      // Function to show the delete confirmation modal
      function showDeletePromptModal(promptId, promptName) {
          const modal = new bootstrap.Modal(document.getElementById('deletePromptModal'));
          const modalBody = document.querySelector('#deletePromptModal .modal-body');
          modalBody.textContent = `Are you sure you want to delete the "${promptName}" prompt?`;

          // Set up the confirm delete button
          const confirmBtn = document.getElementById('confirmDeleteBtn');
          confirmBtn.onclick = function() {
              deletePrompt(promptId, modal);
          };

          modal.show();
      }

      // Function to delete a prompt
      function deletePrompt(promptId, modal) {
          apiClient.prompts.delete(promptId)
              .then(response => {
                  modal.hide();
                  showFlashMessage('Prompt deleted successfully', 'success');
                  loadPrompts(); // Reload the prompts list
              })
              .catch(error => {
                  console.error('Error deleting prompt:', error);
                  modal.hide();
                  showFlashMessage(error.message || 'Error deleting prompt', 'error');
              });
      }

      // Function to toggle template info visibility
      function toggleTemplateInfo() {
          const templateInfo = document.getElementById('templateInfo');
          if (templateInfo.style.display === 'none') {
              templateInfo.style.display = 'block';
          } else {
              templateInfo.style.display = 'none';
          }
      }

      // Update the URL with the selected type
      function updateURL(type) {
          const url = new URL(window.location.href);
          url.searchParams.set('type', type);
          window.history.replaceState({}, '', url);
      }

      // Read the switcher state from the URL on page load
      function initializeSwitcher() {
          const urlParams = new URLSearchParams(window.location.search);
          const type = urlParams.get('type');

          const switcher = document.getElementById('selectedTypeSwitch');
          if (type === 'custom') {
              switcher.checked = true;
          } else {
              switcher.checked = false;
          }

          // Add event listener to the switcher
          switcher.addEventListener('change', function() {
              updateURL(this.checked ? 'custom' : 'default');
              loadPrompts(); // Reload prompts when switcher changes
          });
      }
    </script>
</main>
{% endblock content %}
