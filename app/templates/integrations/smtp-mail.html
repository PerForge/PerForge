{% extends "layouts/base-fullscreen.html" %}
{% block title %} SMTP Mail {% endblock %}
<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}
<link type="text/css" href="/static/assets/vendor/@fortawesome/fontawesome-free/css/all.min.css" rel="stylesheet">
<link type="text/css" href="/static/assets/css/main.css" rel="stylesheet">
{% endblock stylesheets %}
{% block content %}
    <main>
        <div class="main-background">
            {% include 'includes/sidebar.html' %}
            <div class="main-body">
                <div class="center-section">
                    <div class="card mb-3 pf-card-wide" data-component-card="data-component-card">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h4 class="mb-0">SMTP Mail Integration</h4>
                                    <small class="text-muted">Configure SMTP server to send email notifications.</small>
                                </div>
                                <a class="btn btn-sm btn-outline-secondary" href="https://perforge.app/docs/configuration/integrations#smtp-mail" target="_blank">
                                    <i class="fa-regular fa-circle-question me-1"></i>
                                    Docs
                                </a>
                            </div>
                        </div>
                        <div class="card-body">
                            <form method="POST" id="smtpMailForm" class="pf-form" onsubmit="return handleFormSubmit(event)">
                                <div>
                                    {{ form.hidden_tag() }}
                                    {% if smtp_mail_config %}
                                        <input type="hidden" name="id" id="config_id" value="{{ smtp_mail_config }}">
                                    {% else %}
                                        <input type="hidden" name="id" id="config_id">
                                    {% endif %}
                                    <div class="row g-3 mt-1">
                                        <div class="col-12">
                                            <label for="name" class="form-label required">Name
                                                <span class="tooltip-container">
                                                    <span class="tooltip-content">Display name for this connection (used in notifications and settings).</span>
                                                </span>
                                            </label>
                                            {{ form.name(id='name', class_='form-control', placeholder="e.g. My SMTP Mail") }}
                                        </div>
                                        <div class="pf-two-col">
                                            <div>
                                                <label for="server" class="form-label required">SMTP Server
                                                    <span class="tooltip-container">
                                                        <span class="tooltip-content">Hostname of your SMTP server.</span>
                                                    </span>
                                                </label>
                                                {{ form.server(id='server', class_='form-control', placeholder="e.g. smtp.gmail.com") }}
                                            </div>
                                            <div>
                                                <label for="port" class="form-label required">Port
                                                    <span class="tooltip-container">
                                                        <span class="tooltip-content">SMTP port (e.g., 465 for SSL, 587 for TLS).</span>
                                                    </span>
                                                </label>
                                                {{ form.port(id='port', class_='form-control', placeholder="e.g. 465") }}
                                            </div>
                                        </div>
                                        <div class="pf-two-col">
                                            <div>
                                                <label class="form-label" for="use_ssl">Use SSL
                                                    <span class="tooltip-container">
                                                        <span class="tooltip-content">Implicit SSL (SMTPS) establishes TLS from the start. Typically port 465.</span>
                                                    </span>
                                                </label>
                                                <div class="form-check form-switch">
                                                    <input class="form-check-input" type="checkbox" id="use_ssl" name="use_ssl" {% if form.use_ssl.data %}checked{% endif %}>
                                                    <label class="form-check-label" for="use_ssl">Implicit SSL (465)</label>
                                                </div>
                                            </div>
                                            <div>
                                                <label class="form-label" for="use_tls">Use TLS
                                                    <span class="tooltip-container">
                                                        <span class="tooltip-content">STARTTLS upgrades a plain connection to TLS after HELO. Typically port 587.</span>
                                                    </span>
                                                </label>
                                                <div class="form-check form-switch">
                                                    <input class="form-check-input" type="checkbox" id="use_tls" name="use_tls" {% if form.use_tls.data %}checked{% endif %}>
                                                    <label class="form-check-label" for="use_tls">STARTTLS upgrade (587)</label>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-12">
                                            <label for="username" class="form-label required">Email
                                                <span class="tooltip-container">
                                                    <span class="tooltip-content">Email/login used for SMTP authentication.</span>
                                                </span>
                                            </label>
                                            {{ form.username(id='username', class_='form-control', placeholder="e.g. perforge.app@gmail.com") }}
                                        </div>
                                        <div class="col-12">
                                            <label for="token" class="form-label required">Token</label>
                                            <select class="form-select" name="token" id="token" required>
                                                <option value="">--- Select the secret ---</option>
                                                <option value="create_new">--- Create a new secret ---</option>
                                                {% for secret in secret_configs %}
                                                    <option value="{{ secret.id }}" {% if form.token.data == secret.id %} selected {% endif %}>{{ secret.key }}</option>
                                                {% endfor %}
                                            </select>
                                            <div id="tokenError" class="invalid-feedback" style="display: none;">
                                                Please select a token
                                            </div>
                                        </div>
                                        <div class="col-12 hidden" id="new_secret_fields">
                                            <div class="card card-body border-1">
                                                <div class="row g-3">
                                                        <div class="col-md-6">
                                                            <label for="new_secret_name" class="form-label">Secret Name</label>
                                                            <input type="text" id="new_secret_name" class="form-control" placeholder="e.g. SMTP_PASSWORD">
                                                        </div>
                                                        <div class="col-md-6">
                                                            <label for="new_secret_scope" class="form-label">
                                                                Scope
                                                                <span class="tooltip-container d-inline-block ms-1">
                                                                    <span class="tooltip-content">Scope determines secret visibility: "ALL" makes it visible across all projects, while "Project" restricts access to the current project.</span>
                                                                </span>
                                                            </label>
                                                            <select class="form-select" id="new_secret_scope">
                                                                <option value="project">Current project</option>
                                                                <option value="">All projects</option>
                                                            </select>
                                                        </div>
                                                        <div class="col-12">
                                                            <label for="new_secret_value" class="form-label">Secret Value</label>
                                                            <div class="input-group">
                                                                <input type="password" id="new_secret_value" class="form-control" placeholder="e.g. my-super-secret-password">
                                                                <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('new_secret_value', this)" aria-label="Toggle secret visibility">
                                                                    <i class="fa-regular fa-eye"></i>
                                                                </button>
                                                            </div>
                                                        </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-12">
                                            <label for="recipients" class="form-label required">Recipients
                                                <span class="tooltip-container">
                                                    <span class="tooltip-content">Add one or more recipient emails. They will receive notifications from PerForge.</span>
                                                </span>
                                            </label>
                                            <div id="recipients-container" style="width: 100%;">
                                                {% for recipient in form.recipients %}
                                                <div class="flex m10-top">
                                                    <input type="hidden" name="recipients-{{ loop.index0 }}-id" value="{{ recipient.data.id if recipient.data else '' }}">
                                                    <input type="text" class="form-control recipientInput" required name="recipients-{{ loop.index0 }}-email" id="recipients-{{ loop.index0 }}-email" value="{{ recipient.data.email if recipient.data else '' }}" placeholder="e.g. perforge.app@gmail.com">
                                                    <button type="button" class="btn btn-outline-secondary ms-2 deleteRecipient" onclick="removeRecipient(this)"><i class="fa-regular fa-trash-can me-1"></i>Delete</button>
                                                </div>
                                                {% endfor %}
                                            </div>
                                            <div class="d-flex flex-wrap gap-2 mt-2">
                                                <button class="btn btn-outline-primary" type="button" id="addRecipientButton" onclick="addRecipient()"><i class="fa-solid fa-plus me-1"></i>Add Recipient</button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card-footer mt-3">
                                        <div class="pf-footer-actions">
                                            {% if smtp_mail_config %}
                                                <a class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteModal"><i class="fa-regular fa-trash-can me-1"></i>Delete</a>
                                            {% endif %}
                                            <button class="btn btn-primary" type="submit"><i class="fa-solid fa-floppy-disk me-1"></i>Save</button>
                                            <div class="ms-1">
                                                <input type="checkbox" class="btn-check" id="is_default" name="is_default" autocomplete="off" {% if form.is_default.data %}checked{% endif %}>
                                                <label class="btn btn-outline-secondary" for="is_default">
                                                    <i class="fa-solid fa-star me-1 icon-on"></i>
                                                    <i class="fa-regular fa-star me-1 icon-off"></i>
                                                    Default
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </form>
                            <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
                              <div class="modal-dialog">
                                <div class="modal-content">
                                  <div class="modal-header">
                                    <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                  </div>
                                  <div class="modal-body">
                                    Are you sure you want to delete this integration?
                                  </div>
                                  <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <button type="button" class="btn btn-danger" id="deleteButton">Delete</button>
                                  </div>
                                </div>
                              </div>
                            </div>
                        </div>
                    </div>
                   {% with msgs = get_flashed_messages() %}
                   {% include 'includes/flashed-msg.html' %}
                   {% endwith %}
                </div>
            </div>
        </div>
    </main>
    <script>
        function validateForm() {
            const tokenSelect = document.getElementById('token');
            const tokenError = document.getElementById('tokenError');
            if (!tokenSelect.value) {
                tokenError.style.display = 'block';
                return false;
            }
            tokenError.style.display = 'none';
            return true;
        }

        const tokenSelectEl = document.getElementById('token');
        function toggleNewSecretFields() {
            const container = document.getElementById('new_secret_fields');
            if (!container) return;
            const shouldShow = tokenSelectEl.value === 'create_new';
            container.classList.toggle('hidden', !shouldShow);
        }
        tokenSelectEl.addEventListener('change', function() {
            toggleNewSecretFields();
            if (this.value) {
                document.getElementById('tokenError').style.display = 'none';
            }
        });
        toggleNewSecretFields();

        function togglePasswordVisibility(inputId, btn) {
            const input = document.getElementById(inputId);
            if (!input) return;
            const isPassword = input.type === 'password';
            input.type = isPassword ? 'text' : 'password';
            const icon = btn?.querySelector('i');
            if (icon) {
                icon.classList.toggle('fa-eye');
                icon.classList.toggle('fa-eye-slash');
            }
        }

        // Focus-driven hints
        function attachFocusHint(inputId) {
            const input = document.getElementById(inputId);
            if (!input) return;
            const label = document.querySelector('label[for="' + inputId + '"]');
            const contentEl = label ? label.querySelector('.tooltip-content') : null;
            if (!contentEl) return;
            const parent = input.parentElement;
            if (!parent) return;
            parent.classList.add('has-focus-hint');
            let hint = parent.querySelector('.focus-hint-overlay');
            if (!hint) {
                hint = document.createElement('div');
                hint.className = 'form-hint focus-hint-overlay aside';
                hint.innerHTML = '<i class="fas fa-info-circle icon" aria-hidden="true"></i><div>' + contentEl.innerHTML + '</div>';
                parent.appendChild(hint);
            }
            function show() {
                const hintWidth = 320; const gap = 16; const rect = parent.getBoundingClientRect();
                const spaceLeft = rect.left; const spaceRight = window.innerWidth - rect.right;
                hint.classList.remove('aside', 'aside-right');
                if (spaceLeft >= hintWidth + gap) { hint.classList.add('aside'); }
                else if (spaceRight >= hintWidth + gap) { hint.classList.add('aside-right'); }
                hint.classList.add('is-visible');
            }
            function hide() { hint.classList.remove('is-visible'); }
            input.addEventListener('focus', show);
            input.addEventListener('blur', hide);
        }

        function attachFocusHintWithContent(input, contentHtml) {
            if (!input || !contentHtml) return;
            const parent = input.parentElement;
            if (!parent) return;
            parent.classList.add('has-focus-hint');
            let hint = parent.querySelector('.focus-hint-overlay');
            if (!hint) {
                hint = document.createElement('div');
                hint.className = 'form-hint focus-hint-overlay aside';
                hint.innerHTML = '<i class="fas fa-info-circle icon" aria-hidden="true"></i><div>' + contentHtml + '</div>';
                parent.appendChild(hint);
            }
            function show() { const hintWidth = 320; const gap = 16; const rect = parent.getBoundingClientRect(); const spaceLeft = rect.left; const spaceRight = window.innerWidth - rect.right; hint.classList.remove('aside', 'aside-right'); if (spaceLeft >= hintWidth + gap) { hint.classList.add('aside'); } else if (spaceRight >= hintWidth + gap) { hint.classList.add('aside-right'); } hint.classList.add('is-visible'); }
            function hide() { hint.classList.remove('is-visible'); }
            input.addEventListener('focus', show);
            input.addEventListener('blur', hide);
        }

        document.addEventListener('DOMContentLoaded', function() {
            // attach focus hints for all labeled fields
            const labels = document.querySelectorAll('#smtpMailForm label[for]');
            labels.forEach(label => {
                const id = label.getAttribute('for');
                if (label.querySelector('.tooltip-content') && document.getElementById(id)) {
                    attachFocusHint(id);
                }
            });

            // recipients existing rows: attach hint using the Recipients label tooltip, if any
            const recContent = document.querySelector('#smtpMailForm label[for="recipients"] .tooltip-content');
            if (recContent) {
                document.querySelectorAll('.recipientInput').forEach(inp => {
                    attachFocusHintWithContent(inp, recContent.innerHTML);
                });
            }

            // enforce mutual exclusivity for SSL and TLS toggles
            const sslCb = document.getElementById('use_ssl');
            const tlsCb = document.getElementById('use_tls');
            if (sslCb && tlsCb) {
                sslCb.addEventListener('change', () => {
                    if (sslCb.checked) { tlsCb.checked = false; }
                });
                tlsCb.addEventListener('change', () => {
                    if (tlsCb.checked) { sslCb.checked = false; }
                });
            }
        });

        function addRecipient() {
            const container = document.getElementById('recipients-container');
            const count = container.querySelectorAll('.flex').length;
            const html = `<div class="flex m10-top">
                    <input type="text" class="form-control recipientInput" name="recipients-${count}-email" id="recipients-${count}-email" placeholder="e.g. perforge.app@gmail.com">
                    <button type="button" class="btn btn-outline-secondary ms-2" onclick="removeRecipient(this)"><i class=\"fa-regular fa-trash-can me-1\"></i>Delete</button>
                </div>`;
            const wrap = document.createElement('div');
            wrap.innerHTML = html;
            const row = wrap.firstChild;
            container.appendChild(row);
            // attach hint to new input
            const recContent = document.querySelector('#smtpMailForm label[for="recipients"] .tooltip-content');
            const newInput = row.querySelector('.recipientInput');
            if (recContent && newInput) {
                attachFocusHintWithContent(newInput, recContent.innerHTML);
            }
            updateRecipientInputs();
        }

        function removeRecipient(button) {
            button.parentElement.remove();
            updateRecipientInputs();
        }

        function updateRecipientInputs() {
            const container = document.getElementById('recipients-container');
            const items = container.querySelectorAll('.flex');
            items.forEach((item, index) => {
                const emailInput = item.querySelector('.recipientInput');
                if (emailInput) {
                    emailInput.name = `recipients-${index}-email`;
                    emailInput.id = `recipients-${index}-email`;
                }
                const idInput = item.querySelector("input[type='hidden']");
                if (idInput) {
                    idInput.name = `recipients-${index}-id`;
                    idInput.id = `recipients-${index}-id`;
                }
            });
        }

        function handleFormSubmit(event) {
            event.preventDefault();
            if (!validateForm()) { return; }

            // defensive check: SSL and TLS cannot both be enabled simultaneously
            const sslOn = document.getElementById('use_ssl').checked;
            const tlsOn = document.getElementById('use_tls').checked;
            if (sslOn && tlsOn) {
                showFlashMessage('Please enable either SSL or STARTTLS, not both.', 'error');
                return;
            }

            const tokenSelect = document.getElementById('token');
            if (tokenSelect.value === 'create_new') {
                const newSecretName = document.getElementById('new_secret_name').value;
                const newSecretValue = document.getElementById('new_secret_value').value;
                const newSecretScope = document.getElementById('new_secret_scope').value;
                if (!newSecretName || !newSecretValue) {
                    showFlashMessage('Secret name and value are required.', 'error');
                    return;
                }
                const secretData = { key: newSecretName, value: newSecretValue };
                if (newSecretScope === 'project') { secretData.project_id = '{{ project_id }}'; }
                apiClient.secrets.create(secretData)
                    .then(response => {
                        const secretId = response?.data?.secret_id ?? response?.secret_id ?? response?.id;
                        saveIntegration(secretId);
                    })
                    .catch(error => {
                        console.error('Error creating secret:', error);
                        const errorMessage = error.responseJSON?.message || error.message || 'An error occurred while creating the secret.';
                        showFlashMessage(errorMessage, 'error');
                    });
            } else {
                saveIntegration(tokenSelect.value);
            }
        }

        function saveIntegration(tokenId) {
            const id = document.getElementById('config_id')?.value;
            const data = {
                id: id || null,
                name: document.getElementById('name').value,
                server: document.getElementById('server').value,
                port: parseInt(document.getElementById('port').value),
                use_ssl: document.getElementById('use_ssl').checked,
                use_tls: document.getElementById('use_tls').checked,
                username: document.getElementById('username').value,
                token: tokenId,
                is_default: document.getElementById('is_default').checked,
                recipients: []
            };

            const rows = document.querySelectorAll('#recipients-container .flex');
            rows.forEach(row => {
                const emailInput = row.querySelector('.recipientInput');
                const idInput = row.querySelector("input[type='hidden']");
                if (emailInput && emailInput.value) {
                    const recipientId = idInput ? idInput.value : null;
                    data.recipients.push({ id: id && recipientId ? recipientId : null, email: emailInput.value, smtp_mail_id: id });
                }
            });

            const apiCall = id ? apiClient.integrations.update(id, data, 'smtp_mail') : apiClient.integrations.create(data, 'smtp_mail');
            apiCall
                .then(() => {
                    const message = id ? 'Integration updated successfully.' : 'Integration added successfully.';
                    showFlashMessage(message, 'success');
                    setTimeout(() => { window.location.href = '/integrations?tab=smtp-mail'; }, 1000);
                })
                .catch(error => {
                    console.error('Error:', error);
                    showFlashMessage(error.message || 'An error occurred while saving the integration.', 'error');
                });
        }

        document.getElementById('deleteButton')?.addEventListener('click', function() {
            const integrationId = document.getElementById('config_id').value;
            apiClient.integrations.delete(integrationId, 'smtp_mail')
                .then(() => {
                    showFlashMessage('Integration deleted successfully.', 'success');
                    setTimeout(() => { window.location.href = '/integrations?tab=smtp-mail'; }, 1000);
                })
                .catch(error => {
                    console.error('Error:', error);
                    showFlashMessage(error.message || 'An error occurred while deleting the integration.', 'error');
                });
        });
    </script>
{% endblock content %}
