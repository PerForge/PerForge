{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://perforge/specs/report_document.schema.json",
  "title": "ReportDocument",
  "type": "object",
  "required": ["schemaVersion", "reportId", "createdAt"],
  "properties": {
    "schemaVersion": { "type": "string" },
    "generatorVersion": { "type": "string" },
    "reportId": { "type": "string" },
    "project": {
      "type": "object",
      "properties": {
        "id": { "type": ["string", "number"] }
      },
      "additionalProperties": true
    },
    "createdAt": { "type": "string", "format": "date-time" },
    "timeWindow": {
      "type": "object",
      "properties": {
        "start": { "type": "string", "format": "date-time" },
        "end": { "type": "string", "format": "date-time" }
      },
      "additionalProperties": false
    },
    "parameters": { "type": "object", "additionalProperties": true },
    "provenance": {
      "type": "object",
      "properties": {
        "sources": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "provider": { "type": "string" },
              "details": { "type": "object", "additionalProperties": true }
            },
            "required": ["provider"],
            "additionalProperties": true
          }
        }
      },
      "additionalProperties": true
    },
    "tests": {
      "type": "array",
      "items": { "$ref": "#/$defs/ReportTest" }
    },
    "datasets": {
      "type": "array",
      "items": { "$ref": "#/$defs/Dataset" }
    },
    "charts": {
      "type": "array",
      "items": { "$ref": "#/$defs/Chart" }
    },
    "sections": { "type": "array", "items": { "$ref": "#/$defs/Section" } },
    "errors": {
      "type": "array",
      "items": { "$ref": "#/$defs/Error" }
    }
  },
  "$defs": {
    "ReportTest": {
      "type": "object",
      "required": ["id", "title"],
      "properties": {
        "id": { "type": "string" },
        "title": { "type": "string" },
        "baselineTitle": { "type": "string" },
        "summary": { "type": "object", "additionalProperties": true }
      },
      "additionalProperties": false
    },
    "Dataset": {
      "type": "object",
      "required": ["id", "type"],
      "properties": {
        "id": { "type": "string" },
        "type": { "type": "string", "enum": ["table", "timeseries", "events"] },
        "name": { "type": "string" },
        "unit": { "type": "string" },
        "dimensions": { "type": "array", "items": { "type": "string" } },
        "columns": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["name", "type"],
            "properties": {
              "name": { "type": "string" },
              "type": { "type": "string", "enum": ["string", "number", "boolean"] },
              "unit": { "type": "string" }
            },
            "additionalProperties": false
          }
        },
        "rows": { "type": "array", "items": { "type": "array", "items": {} } },
        "series": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "label": { "type": "string" },
              "points": {
                "type": "array",
                "items": {
                  "type": "object",
                  "required": ["t", "value"],
                  "properties": {
                    "t": { "type": "string", "format": "date-time" },
                    "value": { "type": "number" },
                    "meta": { "type": "object", "additionalProperties": true }
                  },
                  "additionalProperties": false
                }
              }
            },
            "additionalProperties": false
          }
        },
        "events": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["t", "type"],
            "properties": {
              "t": { "type": "string", "format": "date-time" },
              "type": { "type": "string" },
              "severity": { "type": "string" },
              "message": { "type": "string" },
              "meta": { "type": "object", "additionalProperties": true }
            },
            "additionalProperties": false
          }
        }
      },
      "additionalProperties": false
    },
    "Chart": {
      "type": "object",
      "required": ["id", "kind"],
      "properties": {
        "id": { "type": "string" },
        "kind": { "type": "string", "enum": ["line", "bar", "scatter", "heatmap"] },
        "dataRef": { "type": "string" },
        "title": { "type": "string" },
        "encodings": { "type": "object", "additionalProperties": true },
        "theme": { "type": "string" },
        "rendered": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "role": { "type": "string", "enum": ["figure", "thumbnail", "email"] },
              "storage": { "type": "string", "enum": ["inline"] },
              "dataUri": { "type": "string", "pattern": "^data:[^;]+;base64,[A-Za-z0-9+/=]+$" },
              "width": { "type": "number" },
              "height": { "type": "number" },
              "mime": { "type": "string" }
            },
            "required": ["storage", "dataUri"],
            "additionalProperties": false
          }
        }
      },
      "additionalProperties": false
    },
    "Insight": {
      "type": "object",
      "required": ["id", "kind"],
      "properties": {
        "id": { "type": "string" },
        "kind": { "type": "string", "enum": ["nfr", "ml", "ai"] },
        "summaryText": { "type": "string" },
        "summaryHtml": { "type": "string" },
        "status": { "type": "string", "enum": ["pass", "warn", "fail", "unknown"] },
        "score": { "type": "number", "minimum": 0, "maximum": 1 },
        "references": {
          "type": "object",
          "properties": {
            "datasets": { "type": "array", "items": { "type": "string" } },
            "charts": { "type": "array", "items": { "type": "string" } },
            "tests": { "type": "array", "items": { "type": "string" } }
          },
          "additionalProperties": false
        },
        "details": { "type": "object", "additionalProperties": true },
        "providerMeta": { "type": "object", "additionalProperties": true }
      },
      "additionalProperties": false
    },
    "Section": {
      "type": "object",
      "required": ["id", "blocks"],
      "properties": {
        "id": { "type": "string" },
        "title": { "type": "string" },
        "blocks": {
          "type": "array",
          "items": { "$ref": "#/$defs/Block" },
          "minItems": 1
        }
      },
      "additionalProperties": false
    },
    "Block": {
      "type": "object",
      "oneOf": [
        { "$ref": "#/$defs/Heading" },
        { "$ref": "#/$defs/Paragraph" },
        { "$ref": "#/$defs/Callout" },
        { "$ref": "#/$defs/TableRef" },
        { "$ref": "#/$defs/ChartRef" },
        { "$ref": "#/$defs/List" }
      ]
    },
    "Heading": {
      "type": "object",
      "required": ["type", "text"],
      "properties": {
        "type": { "const": "Heading" },
        "text": { "type": "string" },
        "level": { "type": "integer", "minimum": 1, "maximum": 4 }
      },
      "additionalProperties": false
    },
    "Paragraph": {
      "type": "object",
      "required": ["type", "text"],
      "properties": {
        "type": { "const": "Paragraph" },
        "text": { "type": "string" }
      },
      "additionalProperties": false
    },
    "Callout": {
      "type": "object",
      "required": ["type", "text"],
      "properties": {
        "type": { "const": "Callout" },
        "text": { "type": "string" },
        "tone": { "type": "string", "enum": ["info", "warning", "success", "danger"] }
      },
      "additionalProperties": false
    },
    "TableRef": {
      "type": "object",
      "required": ["type", "datasetId"],
      "properties": {
        "type": { "const": "TableRef" },
        "datasetId": { "type": "string" }
      },
      "additionalProperties": false
    },
    "ChartRef": {
      "type": "object",
      "required": ["type", "chartId"],
      "properties": {
        "type": { "const": "ChartRef" },
        "chartId": { "type": "string" }
      },
      "additionalProperties": false
    },
    "List": {
      "type": "object",
      "required": ["type", "items"],
      "properties": {
        "type": { "const": "List" },
        "items": { "type": "array", "items": { "type": "string" } }
      },
      "additionalProperties": false
    },
    "Error": {
      "type": "object",
      "required": ["message"],
      "properties": {
        "code": { "type": "string" },
        "message": { "type": "string" },
        "context": { "type": "object", "additionalProperties": true }
      },
      "additionalProperties": false
    }
  }
}
